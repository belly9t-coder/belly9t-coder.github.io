
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales Report App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
        }
        #app-container {
            width: 100%;
            height: 100vh;
            background-color: white;
            display: flex;
            flex-direction: column;
        }
         #app {
            flex-grow: 1;
            overflow-y: auto;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        #app::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        #teamAdminDashboard #app {
            -ms-overflow-style: auto;
            scrollbar-width: auto;
        }
        #teamAdminDashboard #app::-webkit-scrollbar {
            display: block;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.6);
            padding: 24px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            text-align: center;
        }
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.875rem;
        }
        .btn-primary {
            background-color: #1877f2;
            color: white;
        }
        .btn-primary:hover {
            background-color: #166fe5;
        }
        .btn-secondary {
            background-color: #e4e6eb;
            color: #050505;
        }
        .btn-secondary:hover {
            background-color: #d8dade;
        }
        .btn-danger {
            background-color: #fa383e;
            color: white;
        }
         .btn-danger:hover {
            background-color: #e32128;
        }
        .btn-warning {
            background-color: #f59e0b;
            color: white;
        }
        .btn-warning:hover {
            background-color: #d97706;
        }
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        .btn-success:hover {
            background-color: #059669;
        }
        .input-field {
            width: 100%;
            padding: 10px;
            border: 1px solid #dddfe2;
            border-radius: 6px;
            margin-bottom: 12px;
        }
        #currentReportItemsTable th, #currentReportItemsTable td {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
        }
        
        #reportTable, #dateRangeReportTable, #skuTgtVsSalesReportTable, #myCategoryReportTable, #categoryReportTable {
            border-collapse: collapse;
            width: 100%;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 0.7rem; /* Smaller font size */
        }
        #reportTable th, #reportTable td,
        #dateRangeReportTable th, #dateRangeReportTable td,
        #skuTgtVsSalesReportTable th, #skuTgtVsSalesReportTable td,
        #myCategoryReportTable th, #myCategoryReportTable td,
        #categoryReportTable th, #categoryReportTable td {
            border: 1px solid #ddd;
            padding: 3px; /* Smaller padding */
            text-align: center;
            white-space: nowrap;
        }
        #reportTable thead th, #dateRangeReportTable thead th, #skuTgtVsSalesReportTable thead th, #myCategoryReportTable thead th, #categoryReportTable thead th {
            position: sticky;
            z-index: 10;
        }
        #reportTable thead tr:first-child th,
        #dateRangeReportTable thead tr:first-child th,
        #skuTgtVsSalesReportTable thead tr:first-child th,
        #myCategoryReportTable thead tr:first-child th,
        #categoryReportTable thead tr:first-child th {
            top: 0;
        }
        #reportTable thead tr:nth-child(2) th,
        #dateRangeReportTable thead tr:nth-child(2) th,
        #skuTgtVsSalesReportTable thead tr:nth-child(2) th {
            top: 25px; /* Adjust this value based on the height of the first row */
        }

        #reportTable th:first-child, #reportTable td:first-child,
        #reportTable th:nth-child(2), #reportTable td:nth-child(2),
        #reportTable th:nth-child(3), #reportTable td:nth-child(3),
        #dateRangeReportTable th:first-child, #dateRangeReportTable td:first-child,
        #dateRangeReportTable th:nth-child(2), #dateRangeReportTable td:nth-child(2),
        #dateRangeReportTable th:nth-child(3), #dateRangeReportTable td:nth-child(3),
        #skuTgtVsSalesReportTable th:first-child, #skuTgtVsSalesReportTable td:first-child,
        #myCategoryReportTable th:first-child, #myCategoryReportTable td:first-child,
        #categoryReportTable th:first-child, #categoryReportTable td:first-child {
            position: sticky;
            z-index: 11;
            background: #f1f5f9;
        }
        #reportTable th:first-child, #reportTable td:first-child,
        #dateRangeReportTable th:first-child, #dateRangeReportTable td:first-child,
        #skuTgtVsSalesReportTable th:first-child, #skuTgtVsSalesReportTable td:first-child,
        #myCategoryReportTable th:first-child, #myCategoryReportTable td:first-child,
        #categoryReportTable th:first-child, #categoryReportTable td:first-child {
            left: 0;
            min-width: 40px;
        }
        #reportTable th:nth-child(2), #reportTable td:nth-child(2),
        #dateRangeReportTable th:nth-child(2), #dateRangeReportTable td:nth-child(2) {
            left: 40px;
            min-width: 100px;
        }
        #reportTable th:nth-child(3), #reportTable td:nth-child(3),
        #dateRangeReportTable th:nth-child(3), #dateRangeReportTable td:nth-child(3) {
            left: 140px;
        }
        
        #reportTable thead th, #dateRangeReportTable thead th, #skuTgtVsSalesReportTable thead th, #myCategoryReportTable thead th, #categoryReportTable thead th {
             background: #0867d2;
             color: white;
        }
        #reportTable th:first-child, #reportTable th:nth-child(2), #reportTable th:nth-child(3),
        #dateRangeReportTable th:first-child, #dateRangeReportTable th:nth-child(2), #dateRangeReportTable th:nth-child(3),
        #skuTgtVsSalesReportTable th:first-child,
        #myCategoryReportTable th:first-child,
        #categoryReportTable th:first-child {
            z-index: 12;
        }

        #reportTable tfoot td, #dateRangeReportTable tfoot td, #skuTgtVsSalesReportTable tfoot td, #myCategoryReportTable tfoot td, #categoryReportTable tfoot td {
            font-weight: bold;
            background: #f1f5f9;
        }
        #reportTable .summary-header, #dateRangeReportTable .summary-header, #skuTgtVsSalesReportTable .summary-header {
            background: #4a148c; /* Purple for Summary Header */
        }
        #reportTable .summary-col, #dateRangeReportTable .summary-col, #skuTgtVsSalesReportTable .summary-col {
             background: #f3e5f5; /* Light purple for summary data columns */
             font-weight: bold;
        }
        .search-suggestions {
            border: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            position: absolute;
            z-index: 100;
            width: 100%;
        }
        .suggestion-item {
            padding: 8px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f0f2f5;
        }
        .neon-glow-btn {
            background-color: #059669;
            color: white;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 0 5px #10b981, 0 0 15px #10b981, 0 0 25px #10b981, 0 0 35px #10b981;
            transition: box-shadow 0.3s ease-in-out, background-color 0.3s ease-in-out;
        }
        .neon-glow-btn:hover {
             background-color: #06d6a0;
             box-shadow: 0 0 10px #06d6a0, 0 0 25px #06d6a0, 0 0 40px #06d6a0, 0 0 60px #06d6a0;
        }
        .grouped-product-table th, .grouped-product-table td {
            padding: 6px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.8rem;
        }
        .grouped-product-table .group-header {
            background-color: #f1f5f9;
            font-weight: 700;
            color: #1e293b;
            padding: 10px 8px;
        }
        .grouped-product-table .inline-input {
            width: 50px;
            padding: 4px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            text-align: center;
            font-size: 0.8rem;
        }
        .toggle-btn {
            cursor: pointer;
            color: #1877f2;
            font-weight: 500;
            margin-left: 8px;
        }
         footer {
            background-color: #1f2937;
            color: #d1d5db;
            padding: 1rem;
            text-align: center;
            font-size: 0.875rem;
            flex-shrink: 0;
        }
         @keyframes blink {
            50% {
                opacity: 0;
            }
        }
        .blinking-text {
            animation: blink 1s linear infinite;
            color: #ef4444; /* red-500 */
            font-weight: bold;
        }
        .accordion-header {
            cursor: pointer;
            padding: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(255, 255, 255, 0.1);
            transition: background-color 0.2s;
        }
        .accordion-header:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .accordion-content {
            display: none;
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        #voice-assistant-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        #mic-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #1877f2;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }
        #mic-btn.listening {
            background-color: #fa383e;
            transform: scale(1.1);
        }
        #mic-icon {
            color: white;
            width: 28px;
            height: 28px;
        }
        #assistant-status {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            display: none;
            font-size: 0.9rem;
        }
         /* Sidebar Styles */
        #admin-sidebar {
            position: fixed;
            top: 0;
            left: -280px; /* Hidden by default */
            width: 280px;
            height: 100%;
            background-color: #1f2937; /* Gray-800 */
            color: #d1d5db; /* Gray-300 */
            transition: left 0.3s ease-in-out;
            z-index: 1040;
            display: flex;
            flex-direction: column;
        }
        #admin-sidebar.show {
            left: 0;
        }
        #sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1030;
        }
        #sidebar-overlay.show {
            display: block;
        }
        #sidebar-nav {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .sidebar-menu-item, .sidebar-submenu-item {
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        .sidebar-menu-item:hover, .sidebar-submenu-item:hover {
            background-color: #374151; /* Gray-700 */
            color: white;
        }
        .sidebar-menu-item.active, .sidebar-submenu-item.active {
             background-color: #4b5563; /* Gray-600 */
             color: white;
        }
        .sidebar-submenu {
            padding-left: 1rem;
            display: none;
            background-color: rgba(0,0,0,0.2);
            border-radius: 0.375rem;
            margin-top: 0.25rem;
        }
        .sidebar-submenu.show {
            display: block;
        }
        .sidebar-menu-container {
             margin-bottom: 0.5rem;
        }
        .add-submenu-btn, .delete-menu-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0 0.25rem;
        }
        .add-submenu-btn:hover, .delete-menu-btn:hover {
            color: white;
        }
        .sortable-ghost {
            background: #4b5563;
            opacity: 0.5;
        }
        .sortable-drag {
            opacity: 1 !important;
        }
        #admin-main-content {
            transition: margin-left 0.3s ease-in-out;
        }
        @media (min-width: 768px) {
            #admin-sidebar {
                left: 0;
            }
            #admin-main-content {
                margin-left: 280px;
            }
            #sidebar-toggle-btn {
                display: none;
            }
             #admin-sidebar.show {
                left: 0;
            }
        }
        .admin-content-view {
            display: none;
        }
        .admin-content-view.active {
            display: block;
        }

        /* Menu Editor Styles */
        .menu-editor-item {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }
        .menu-editor-item .item-content {
            padding: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .menu-editor-item .item-name {
            font-weight: 600;
        }
        .menu-editor-item .item-controls button {
            margin-left: 0.5rem;
        }
         .menu-editor-item .sub-items {
            padding-left: 2rem;
            border-top: 1px solid #e5e7eb;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
    </style>
</head>
<body class="antialiased font-sans">
<div id="app-container">
    <div id="app">

        <!-- Main Login Page -->
        <div id="mainLoginPage" class="page active">
            <div class="card max-w-md mx-auto mt-8 md:mt-16">
                <h1 class="text-2xl font-bold text-center mb-6">Welcome to Sales Report App</h1>
                <p class="text-center text-gray-600 mb-6">Login to continue</p>
                <div class="flex flex-col space-y-4">
                    <button onclick="showPage('superAdminLoginPage')" class="btn btn-primary">Super Admin Login</button>
                    <button onclick="showPage('teamAdminLoginPage')" class="btn btn-primary">Team Admin Login</button>
                    <button onclick="showPage('teamMemberLoginPage')" class="btn btn-primary">Team Member Login</button>
                </div>
            </div>
        </div>

        <!-- Super Admin Login Page -->
        <div id="superAdminLoginPage" class="page">
             <div class="card max-w-md mx-auto mt-8 md:mt-16">
                <h2 class="text-xl font-bold mb-4">Super Admin Login</h2>
                <input type="password" id="superAdminPassword" class="input-field" placeholder="Enter password">
                <button onclick="loginSuperAdmin()" class="btn btn-primary w-full">Login</button>
                <button onclick="showPage('mainLoginPage')" class="btn btn-secondary w-full mt-2">Back to Main Menu</button>
            </div>
        </div>

        <!-- Team Admin Login Page -->
        <div id="teamAdminLoginPage" class="page">
            <div class="card max-w-md mx-auto mt-8 md:mt-16">
                <h2 class="text-xl font-bold mb-4">Team Admin Login</h2>
                <input type="text" id="teamAdminUsername" class="input-field" placeholder="Username">
                <input type="password" id="teamAdminPassword" class="input-field" placeholder="Password">
                <button onclick="loginTeamAdmin()" class="btn btn-primary w-full">Login</button>
                <button onclick="showPage('mainLoginPage')" class="btn btn-secondary w-full mt-2">Back to Main Menu</button>
            </div>
        </div>
        
        <!-- Team Member Login Page -->
        <div id="teamMemberLoginPage" class="page">
            <div class="card max-w-md mx-auto mt-8 md:mt-16">
                <h2 class="text-xl font-bold mb-4">Team Member Login</h2>
                <input type="text" id="teamMemberUsername" class="input-field" placeholder="Username">
                <input type="password" id="teamMemberPassword" class="input-field" placeholder="Password">
                <button onclick="loginTeamMember()" class="btn btn-primary w-full">Login</button>
                <button onclick="showPage('mainLoginPage')" class="btn btn-secondary w-full mt-2">Back to Main Menu</button>
            </div>
        </div>


        <!-- Super Admin Dashboard -->
        <div id="superAdminDashboard" class="page">
            <div class="card">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <h2 class="text-2xl font-bold mb-4 md:mb-0">Super Admin Dashboard</h2>
                    <button onclick="handleLogoutClick(event)" class="btn btn-danger w-full md:w-auto">Logout</button>
                </div>

                <div class="mb-8">
                    <button onclick="showPage('createTeamAdminPage')" class="btn btn-primary">Create New Team Admin</button>
                </div>

                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-2">Manage Team Admins (<span id="teamAdminCount">0</span>)</h3>
                    <div id="teamAdminsList" class="space-y-2"></div>
                </div>
                
                 <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-2">Change Super Admin Password</h3>
                    <div class="p-4 border rounded-lg space-y-4 max-w-md">
                        <input type="password" id="newSuperAdminPassword" class="input-field" placeholder="New Password">
                        <input type="password" id="confirmSuperAdminPassword" class="input-field" placeholder="Confirm New Password">
                        <button onclick="changeSuperAdminPassword()" class="btn btn-warning w-full">Change Password</button>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-2">Notice for Team Admins</h3>
                    <div class="p-4 border rounded-lg space-y-4">
                        <textarea id="superAdminNotice" class="input-field !mb-0" placeholder="Write notice for team admins..."></textarea>
                        <button onclick="saveSuperAdminNotice()" class="btn btn-primary w-full">Save Notice</button>
                         <button onclick="deleteSuperAdminNotice()" class="btn btn-danger w-full mt-2">Delete Notice</button>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-2">Manage Advertisements</h3>
                    <div class="p-4 border rounded-lg space-y-4">
                        <div>
                            <label for="popunderAd" class="font-semibold text-sm">Popunder Ad URL</label>
                            <input type="text" id="popunderAd" class="input-field !mb-0" placeholder="https://example.com/popunder">
                        </div>
                        <div>
                            <label for="bannerAd" class="font-semibold text-sm">Banner Ad URL</label>
                            <input type="text" id="bannerAd" class="input-field !mb-0" placeholder="https://example.com/banner.jpg">
                        </div>
                        <div>
                            <label for="nativeBannerAd" class="font-semibold text-sm">Native Banner Ad URL</label>
                            <input type="text" id="nativeBannerAd" class="input-field !mb-0" placeholder="https://example.com/native_banner.jpg">
                        </div>
                        <button onclick="saveAdvertisements()" class="btn btn-primary w-full">Save Advertisements</button>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- Create Team Admin Page -->
        <div id="createTeamAdminPage" class="page">
            <div class="card max-w-md mx-auto mt-8 md:mt-16">
                <h3 class="text-xl font-bold mb-4">Create New Team Admin</h3>
                <input type="text" id="newTeamAdminUsername" class="input-field" placeholder="Team Admin Username">
                <input type="password" id="newTeamAdminPassword" class="input-field" placeholder="Password">
                <button onclick="createTeamAdmin()" class="btn btn-primary w-full">Create Team Admin</button>
                <button onclick="showPage('superAdminDashboard')" class="btn btn-secondary w-full mt-2">Back to Dashboard</button>
            </div>
        </div>

        <!-- Team Admin Dashboard -->
        <div id="teamAdminDashboard" class="page">
            <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
            <!-- Sidebar -->
            <div id="admin-sidebar">
                <div class="flex justify-between items-center mb-6 p-4">
                     <h2 class="text-xl font-bold text-white">Dashboard</h2>
                     <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white md:hidden text-2xl">&times;</button>
                </div>
                <nav id="sidebar-nav">
                    <!-- Dynamic menu will be injected here by JS -->
                </nav>
                 <div class="p-4 border-t border-gray-700">
                    <button onclick="switchAdminView('view_add_or_edit_menu')" class="btn btn-secondary w-full">Edit Menu</button>
                </div>
            </div>

            <!-- Main Content -->
            <div id="admin-main-content">
                <div class="p-4">
                    <header class="flex justify-between items-center mb-6">
                        <button id="sidebar-toggle-btn" onclick="toggleSidebar()" class="btn btn-secondary md:hidden">Menu</button>
                        <h2 class="text-2xl font-bold">Team Admin Dashboard</h2>
                        <button onclick="handleLogoutClick(event)" class="btn btn-danger">Logout</button>
                    </header>
                    <p class="mb-6">Welcome, <span id="loggedInTeamAdminUsername" class="font-semibold"></span>!</p>
                    <div id="superAdminNoticeContainerForAdmin" class="mb-4"></div>

                    <!-- Dashboard Default View -->
                    <div id="view_dashboard_default" class="admin-content-view">
                         <div id="reportSubmissionStatus" class="mb-4 p-4 border rounded-lg bg-gray-50 space-y-2">
                            <div class="flex items-center space-x-2">
                                <label for="submissionStatusDate" class="font-semibold whitespace-nowrap">Select Date for Status:</label>
                                <input type="date" id="submissionStatusDate" onchange="renderReportSubmissionStatus()" class="input-field !mb-0 w-auto">
                            </div>
                            <div id="submissionStatusContent">
                                <!-- Submission status will be rendered here by JS -->
                            </div>
                        </div>
                         <!-- Category Wise Report Section -->
                        <div class="p-4 border rounded-lg space-y-6 bg-gray-50">
                             <h3 class="text-lg font-semibold">Category Wise Report</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <div>
                                    <label for="categoryReportStartDate" class="font-semibold text-sm">Start Date:</label>
                                    <input type="date" id="categoryReportStartDate" class="input-field !mb-0 w-full" onchange="renderCategoryWiseReport()">
                                </div>
                                <div>
                                    <label for="categoryReportEndDate" class="font-semibold text-sm">End Date:</label>
                                    <input type="date" id="categoryReportEndDate" class="input-field !mb-0 w-full" onchange="renderCategoryWiseReport()">
                                </div>
                                <div>
                                    <label for="categoryReportMemberSelect" class="font-semibold text-sm">Select Member:</label>
                                    <select id="categoryReportMemberSelect" class="input-field !mb-0 w-full" onchange="renderCategoryWiseReport()"></select>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <button onclick="renderCategoryWiseReport()" class="btn btn-primary w-full">Refresh Report</button>
                                <button onclick="exportReportToExcel('categoryReportTable')" class="btn btn-success w-full">Export to Excel</button>
                            </div>
                            <div class="mt-4 h-96">
                                <canvas id="categoryChart"></canvas>
                            </div>
                            <div id="categoryReportTableContainer" class="mt-4 overflow-x-auto"></div>
                        </div>
                    </div>
                    
                    <!-- Team Report View -->
                    <div id="view_team_report" class="admin-content-view">
                        <div class="card">
                             <h3 class="text-lg font-semibold mb-2">Team Report Dashboard</h3>
                             <div class="controls mb-4 flex flex-col md:flex-row items-stretch md:items-center md:space-x-4 space-y-4 md:space-y-0">
                                <div class="flex items-center space-x-2">
                                    <label for="reportDate" class="font-semibold whitespace-nowrap">Select Date:</label>
                                    <input type="date" id="reportDate" onchange="renderTeamAdminReports()" class="input-field !mb-0 w-auto">
                                </div>
                                <button onclick="exportReportToExcel('reportTable')" class="btn btn-success">Export</button>
                                <button onclick="copyTable('reportTable')" class="btn btn-secondary">Copy</button>
                            </div>
                             <div class="overflow-x-auto max-h-[50vh] overflow-y-auto">
                                <table id="reportTable">
                                    <thead>
                                      <tr id="memberRow">
                                      </tr>
                                      <tr id="subHeaderRow">
                                      </tr>
                                    </thead>
                                    <tbody id="tableBody">
                                    </tbody>
                                    <tfoot id="tableFoot">
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Date Range Report View -->
                    <div id="view_date_range_report" class="admin-content-view">
                         <div class="card">
                            <h3 class="text-lg font-semibold mb-2">Up to Date Report</h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end mb-4 p-4 border rounded-lg bg-gray-50">
                                <div>
                                    <label for="reportStartDate" class="font-semibold text-sm">Start Date:</label>
                                    <input type="date" id="reportStartDate" class="input-field !mb-0 w-full">
                                </div>
                                <div>
                                    <label for="reportEndDate" class="font-semibold text-sm">End Date:</label>
                                    <input type="date" id="reportEndDate" class="input-field !mb-0 w-full">
                                </div>
                                <div>
                                    <label for="reportMemberSelect" class="font-semibold text-sm">Select Member:</label>
                                    <select id="reportMemberSelect" class="input-field !mb-0 w-full"></select>
                                </div>
                                <div>
                                    <label for="reportProductSelect" class="font-semibold text-sm">Select Product:</label>
                                    <select id="reportProductSelect" class="input-field !mb-0 w-full"></select>
                                </div>
                            </div>
                            <div class="flex gap-4 mb-4">
                                <button onclick="renderTeamAdminReportsForDateRange()" class="btn btn-primary w-full">View Report</button>
                                <button onclick="exportReportToExcel('dateRangeReportTable')" class="btn btn-success">Export</button>
                                <button onclick="copyTable('dateRangeReportTable')" class="btn btn-secondary">Copy</button>
                            </div>
                             <div class="overflow-x-auto max-h-[50vh] overflow-y-auto">
                                <table id="dateRangeReportTable">
                                    <thead>
                                      <tr id="dateRangeMemberRow">
                                      </tr>
                                      <tr id="dateRangeSubHeaderRow">
                                      </tr>
                                    </thead>
                                    <tbody id="dateRangeTableBody">
                                    </tbody>
                                    <tfoot id="dateRangeTableFoot">
                                    </tfoot>
                                </table>
                            </div>
                         </div>
                    </div>

                    <!-- New SKU TGT vs Sales Report View -->
                    <div id="view_sku_tgt_vs_sales_report" class="admin-content-view">
                        <div class="card">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">SKU TGT vs Sales Difference Report</h3>
                                <div id="skuReportMemberToggle" class="flex items-center gap-2">
                                     <!-- Toggle switch will be injected by JS -->
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mb-4 p-4 border rounded-lg bg-gray-50">
                                <div>
                                    <label for="skuTgtDate" class="font-semibold text-sm">Target Date:</label>
                                    <input type="date" id="skuTgtDate" class="input-field !mb-0 w-full">
                                </div>
                                <div>
                                    <label for="skuSalesDate" class="font-semibold text-sm">Sales Date:</label>
                                    <input type="date" id="skuSalesDate" class="input-field !mb-0 w-full">
                                </div>
                                <div>
                                    <label for="skuMemberSelect" class="font-semibold text-sm">Select Member:</label>
                                    <select id="skuMemberSelect" class="input-field !mb-0 w-full"></select>
                                </div>
                                <div class="md:col-span-1">
                                    <label for="skuCategorySelect" class="font-semibold text-sm">Select Category:</label>
                                    <select id="skuCategorySelect" class="input-field !mb-0 w-full"></select>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="skuProductSelect" class="font-semibold text-sm">Select Product:</label>
                                    <select id="skuProductSelect" class="input-field !mb-0 w-full"></select>
                                </div>
                            </div>
                            <div class="flex gap-4 mb-4">
                                <button onclick="renderSkuTgtVsSalesReport()" class="btn btn-primary w-full">Show Report</button>
                                <button onclick="exportReportToExcel('skuTgtVsSalesReportTable')" class="btn btn-success">Export to Excel</button>
                            </div>
                             <div class="overflow-x-auto max-h-[60vh] overflow-y-auto">
                                <table id="skuTgtVsSalesReportTable">
                                    <thead>
                                      <!-- Header will be generated by JS -->
                                    </thead>
                                    <tbody id="skuTgtVsSalesReportBody">
                                    </tbody>
                                    <tfoot id="skuTgtVsSalesReportFoot">
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                     <!-- Report Format 1 View (For Admin) -->
                    <div id="view_report_format_1" class="admin-content-view">
                        <div class="card">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">Report Format 1: Category Wise Sales</h3>
                                <div id="reportFormat1MemberToggle" class="flex items-center gap-2">
                                     <label for="enableReportFormat1" class="font-semibold text-gray-700">Enable for Team Members</label>
                                     <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="enableReportFormat1" class="sr-only peer" onchange="toggleMemberReportFormat('report_format_1', this.checked)">
                                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mb-4">This format allows team members to see their own category-wise sales report for a selected date range.</p>
                            
                        </div>
                    </div>

                    <!-- Add or Edit Menu View -->
                    <div id="view_add_or_edit_menu" class="admin-content-view">
                        <div class="card">
                             <h3 class="text-lg font-semibold mb-4">Add or Edit Menu</h3>
                             <div class="mb-6 p-4 border rounded-lg">
                                <h4 class="font-semibold mb-2">Add New Menu Item</h4>
                                <div class="flex gap-2">
                                    <input type="text" id="newMenuItemName" class="input-field !mb-0" placeholder="New menu name">
                                    <button onclick="addNewMenuItemToEditor()" class="btn btn-primary">Add Menu</button>
                                </div>
                            </div>
                            <div id="menu-editor-list">
                                <!-- Menu editor will be rendered here by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Create Team Member View -->
                    <div id="view_create_team_member" class="admin-content-view">
                         <div class="card max-w-md mx-auto">
                             <h3 class="text-xl font-bold mb-4">Create New Team Member</h3>
                            <input type="text" id="newTeamMemberName" class="input-field" placeholder="Team Member Name">
                            <input type="text" id="newTeamMemberUsername_sidebar" class="input-field" placeholder="Team Member Username">
                            <input type="password" id="newTeamMemberPassword_sidebar" class="input-field" placeholder="Password">
                            <button onclick="createTeamMember()" class="btn btn-primary w-full">Create Team Member</button>
                        </div>
                    </div>
                    
                    <!-- All Sections Manager Views -->
                    <div id="view_manage_team_members" class="admin-content-view">
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-4">Manage Team Members</h3>
                            <div id="teamMembersList" class="space-y-2"></div>
                        </div>
                    </div>
                     <div id="view_notice_for_members" class="admin-content-view">
                        <div class="card max-w-lg mx-auto">
                            <h3 class="text-lg font-semibold mb-4">Notice for Team Members</h3>
                            <div id="teamAdminNoticeSection" class="space-y-4">
                                <textarea id="teamAdminNotice" class="input-field !mb-0" placeholder="Write notice for team members..."></textarea>
                                <button onclick="saveTeamAdminNotice()" class="btn btn-primary w-full">Save Notice</button>
                                <button onclick="deleteTeamAdminNotice()" class="btn btn-danger w-full mt-2">Delete Notice</button>
                            </div>
                        </div>
                     </div>
                     <div id="view_add_new_product" class="admin-content-view">
                        <div class="card max-w-lg mx-auto">
                            <h3 class="text-lg font-semibold mb-4">Add New Product</h3>
                            <div id="addProductSection" class="space-y-4">
                                <input type="text" id="newProductName" class="input-field" placeholder="Product Name">
                                <input type="number" id="newProductRate" class="input-field" placeholder="Product Rate">
                                <label for="newProductCategory" class="text-sm font-medium text-gray-700">Add New Category</label>
                                <input type="text" id="newProductCategory" class="input-field" placeholder="Type new category name...">
                                <button onclick="addNewProduct()" class="btn btn-primary w-full">Add Product</button>
                            </div>
                        </div>
                     </div>
                    <div id="view_manage_products" class="admin-content-view">
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-4">Manage Products</h3>
                            <div id="manageProductSection">
                                <div class="relative mb-2">
                                    <input type="text" id="adminProductSearch" class="input-field" placeholder="Search for a product..." oninput="filterProductsForAdmin(this.value)">
                                </div>
                                <div id="productListForAdmin" class="space-y-2 max-h-96 overflow-y-auto p-2 border rounded-md"></div>
                            </div>
                        </div>
                    </div>
                    <div id="view_manage_categories" class="admin-content-view">
                        <div class="card">
                             <h3 class="text-lg font-semibold mb-4">Manage Categories</h3>
                             <div id="categoryManagerSection">
                                <div class="mb-4 p-4 border rounded-lg">
                                    <h4 class="font-semibold mb-2">Add New Category</h4>
                                    <input type="text" id="newStandaloneCategoryName" class="input-field" placeholder="New category name">
                                    <button onclick="addStandaloneCategory()" class="btn btn-primary w-full">Add Category</button>
                                </div>
                                <div class="mb-4 p-4 border rounded-lg">
                                    <h4 class="font-semibold mb-2">Delete Existing Category</h4>
                                    <select id="deleteCategorySelect" class="input-field">
                                        <option value="">-- Select Category to Delete --</option>
                                    </select>
                                    <button onclick="deleteStandaloneCategory()" class="btn btn-danger w-full">Delete Selected Category</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="view_notification_system" class="admin-content-view">
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-4">Manage Notification System</h3>
                             <div id="notificationSystemSection" class="space-y-6">
                                <div class="flex items-center justify-between">
                                    <label for="enableNotifications" class="font-semibold text-gray-700">Enable Notification System</label>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="enableNotifications" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
        
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Reminder Message (for non-submitters)</label>
                                    <textarea id="reminderMessage" rows="3" class="input-field !mb-0" placeholder="Message for members who have not submitted their report..."></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Reminder Times</label>
                                    <div id="reminderTimesContainer" class="space-y-2">
                                        <!-- Reminder time inputs will be here -->
                                    </div>
                                    <button onclick="addReminderTimeInput()" class="btn btn-secondary btn-sm mt-2">Add More Time</button>
                                </div>
        
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Thank You Message (for submitters)</label>
                                    <textarea id="thankYouMessage" rows="2" class="input-field !mb-0" placeholder="Message for members who have submitted their report..."></textarea>
                                </div>
        
                                <button onclick="saveNotificationSettings()" class="btn btn-primary w-full">Save Settings</button>
                            </div>
                        </div>
                    </div>
                     <div id="view_logout_settings" class="admin-content-view">
                        <div class="card max-w-lg mx-auto">
                             <h3 class="text-lg font-semibold mb-4">Manage Logout Settings</h3>
                             <div id="logoutSettingsSection" class="space-y-4">
                                <div>
                                    <label for="logoutClickCount" class="block text-sm font-medium text-gray-700 mb-1">Required Clicks to Logout</label>
                                    <input type="number" id="logoutClickCount" class="input-field !mb-0" placeholder="e.g., 10">
                                </div>
                                <button onclick="saveLogoutSettings()" class="btn btn-primary w-full">Save Logout Clicks</button>
                            </div>
                        </div>
                     </div>
                      <div id="view_voice_settings" class="admin-content-view">
                        <div class="card max-w-lg mx-auto">
                            <h3 class="text-lg font-semibold mb-4">Manage Voice Settings</h3>
                            <div id="voiceSettingsSection" class="space-y-4">
                                <div>
                                    <label for="voiceRepeatCount" class="block text-sm font-medium text-gray-700 mb-1">Voice Summary Repeat Count</label>
                                    <input type="number" id="voiceRepeatCount" class="input-field !mb-0" placeholder="e.g., 2">
                                </div>
                                <button onclick="saveVoiceSettings()" class="btn btn-primary w-full">Save Voice Settings</button>
                            </div>
                        </div>
                      </div>

                </div>
            </div>
        </div>
        
         <!-- Create Team Member Page -->
        <div id="createTeamMemberPage" class="page">
            <div class="card max-w-md mx-auto mt-8 md:mt-16">
                 <h3 class="text-xl font-bold mb-4">Create New Team Member</h3>
                <input type="text" id="newTeamMemberUsername" class="input-field" placeholder="Team Member Username">
                <input type="password" id="newTeamMemberPassword" class="input-field" placeholder="Password">
                <button onclick="createTeamMember()" class="btn btn-primary w-full">Create Team Member</button>
                <button onclick="showPage('teamAdminDashboard')" class="btn btn-secondary w-full mt-2">Back to Dashboard</button>
            </div>
        </div>

        <!-- Team Member Dashboard -->
        <div id="teamMemberDashboard" class="page">
            <div class="card">
                 <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 md:mb-0">Team Member Dashboard</h2>
                        <p class="mb-4 md:mb-0">Welcome, <span id="loggedInTeamMemberName" class="font-semibold"></span>!</p>
                    </div>
                    <button onclick="handleLogoutClick(event)" class="btn btn-danger w-full md:w-auto">Logout</button>
                </div>

                <!-- Member's Default View -->
                <div id="memberDefaultView">
                    <div id="teamAdminNoticeContainer" class="border-b pb-4 mb-6"></div>
                </div>

                <div id="submitReportContainer" class="mb-8 p-4 border rounded-lg">
                    <h3 class="text-lg font-semibold mb-2">Submit Daily Sales Report</h3>
                    
                     <div class="border-t pt-4">
                        <h4 class="text-md font-semibold mb-4">Add Products to Report</h4>
                        
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <input type="text" id="memberProductSearch" oninput="handleProductSearchForMember(this.value)" class="input-field !mb-0 flex-grow" placeholder="Search for a product by name...">
                            <select id="productCategorySelect" onchange="handleCategorySelect(this.value)" class="input-field !mb-0 md:w-1/3">
                                <!-- Categories will be populated here -->
                            </select>
                        </div>

                        <div id="memberProductListContainer" class="max-h-[60vh] overflow-y-auto mb-6">
                            <!-- Product list for selected category or search will be rendered here -->
                        </div>
                    </div>


                    <div class="mt-6">
                        <h4 class="text-md font-semibold mb-2">Current Report Items</h4>
                        <div class="border rounded-lg overflow-x-auto">
                            <table id="currentReportItemsTable" class="w-full text-left">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th>Product Name</th>
                                        <th>TGT</th>
                                        <th>Sales</th>
                                        <th>Amount</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="currentReportItems">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <button onclick="submitSalesReport()" class="btn btn-success mt-4 w-full">Submit Final Report</button>
                </div>
                
                <!-- Dynamic Report Format View for Members -->
                <div id="memberDynamicReportView" class="mt-8" style="display: none;">
                    <div id="memberReport_format_1" style="display: none;">
                         <div class="card">
                             <h3 class="text-lg font-semibold">My Category Wise Report</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end mt-4">
                                <div>
                                    <label for="myCategoryReportStartDate" class="font-semibold text-sm">Start Date:</label>
                                    <input type="date" id="myCategoryReportStartDate" class="input-field !mb-0 w-full">
                                </div>
                                <div>
                                    <label for="myCategoryReportEndDate" class="font-semibold text-sm">End Date:</label>
                                    <input type="date" id="myCategoryReportEndDate" class="input-field !mb-0 w-full">
                                </div>
                            </div>
                             <div class="flex flex-col sm:flex-row gap-4 mt-4">
                                <button onclick="renderMyCategoryWiseReport()" class="btn btn-primary w-full">Show My Report</button>
                                <button onclick="exportReportToExcel('myCategoryReportTable')" class="btn btn-success w-full">Export to Excel</button>
                            </div>
                            <div id="myCategoryReportTableContainer" class="mt-4 overflow-x-auto"></div>
                        </div>
                    </div>
                </div>


                <div class="mt-8">
                    <h3 class="text-lg font-semibold mb-2">My All Submitted Reports</h3>
                    <div id="mySalesReportsList" class="space-y-4"></div>
                </div>

            </div>
        </div>

        <!-- Advertisement Container -->
        <div id="adContainer" class="mt-8 text-center"></div>
        
        <!-- Voice Assistant UI -->
        <div id="voice-assistant-container" style="display: none;">
             <div id="assistant-status"></div>
             <div id="mic-btn">
                <span id="mic-countdown" style="display: none;"></span>
                <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3zM17 12a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V22h2v-3.08A7 7 0 0 0 19 12h-2z"/>
                </svg>
            </div>
        </div>

    </div>
    <footer id="mainFooter">
        © 2024 shohel_it. All rights reserved.
    </footer>
</div>
    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBhvOEtF_7iMzBxEtJMUx4y49XtfwcsuDs",
            authDomain: "ekta-local-saver.firebaseapp.com",
            databaseURL: "https://ekta-local-saver-default-rtdb.firebaseio.com",
            projectId: "ekta-local-saver",
            storageBucket: "ekta-local-saver.appspot.com",
            messagingSenderId: "279895079867",
            appId: "1:279895079867:web:51b22c70183af03551e29e"
        };

        // --- Global Variables ---
        let db;
        let messaging;
        let state = {}; 
        let alarmIntervalId = null;
        let adminNotificationIntervalId = null;
        let logoutClickCounter = 0;
        let logoutClickTimer = null;
        let categoryChartInstance = null;
        let isListening = false;
        let recognition;
        let countdownInterval = null;
        let synth = window.speechSynthesis;
        let bengaliVoice = null;
        
        const defaultProducts = [
            { id: 'prod_1', name: 'Chili Powder 50gm NEW', rate: 29.11, category: 'Chili Powder' },
            { id: 'prod_2', name: 'Chili Powder 100gm NEW', rate: 57.60, category: 'Chili Powder' },
            { id: 'prod_3', name: 'Chili Powder - 200gm', rate: 108.00, category: 'Chili Powder' },
            { id: 'prod_4', name: 'Chili Powder-500gm x 24', rate: 254.57, category: 'Chili Powder' },
            { id: 'prod_5', name: 'Chili Powder-1kg', rate: 556.45, category: 'Chili Powder' },
            { id: 'prod_6', name: 'Chili powder 200 gm jar', rate: 132.96, category: 'Chili Powder' },
            { id: 'prod_7', name: 'Chili powder 5 kg-New', rate: 1530, category: 'Chili Powder' },
            { id: 'prod_8', name: '16 Ana Chilli-15Kg (Bulk)', rate: 4380, category: 'Chili Powder' },
            { id: 'prod_9', name: 'Turmeric Powder 15gm New', rate: 9.95, category: 'Turmeric Powder' },
            { id: 'prod_10', name: 'Turmeric Powder 50gm NEW', rate: 30.67, category: 'Turmeric Powder' },
            { id: 'prod_11', name: 'Turmeric Powder 100gm NEW', rate: 57.78, category: 'Turmeric Powder' },
            { id: 'prod_12', name: 'Turmeric Powder 200 gm', rate: 112.00, category: 'Turmeric Powder' },
            { id: 'prod_13', name: 'Turmeric Powder 500gmX24 Pouch', rate: 249.43, category: 'Turmeric Powder' },
            { id: 'prod_14', name: 'Turmeric Powder-1kg', rate: 533.33, category: 'Turmeric Powder' },
            { id: 'prod_15', name: 'Turmeric powder 200 gm jar', rate: 135.36, category: 'Turmeric Powder' },
            { id: 'prod_16', name: 'Turmeric Powder- 5kg', rate: 1310, category: 'Turmeric Powder' },
            { id: 'prod_17', name: '16 Ana Turmeric 15kg (Bulk)', rate: 3821, category: 'Turmeric Powder' },
            { id: 'prod_18', name: 'Pran Coriander Powder 50 gm pouch', rate: 23.57, category: 'Coriander Powder' },
            { id: 'prod_19', name: 'Pran Coriander Powder 100 gm pouch', rate: 44.14, category: 'Coriander Powder' },
            { id: 'prod_20', name: 'Pran Coriander Powder 200 gm pouch', rate: 83.33, category: 'Coriander Powder' },
            { id: 'prod_21', name: 'Pran Coriander Powder 500 gm pouch', rate: 180.00, category: 'Coriander Powder' },
            { id: 'prod_22', name: 'Pran Coriander Powder 200 gm Jar', rate: 92.57, category: 'Coriander Powder' },
            { id: 'prod_23', name: 'Pran Cumin Powder 15gm pouch', rate: 22.05, category: 'Cumin Powder' },
            { id: 'prod_24', name: 'Pran Cumin Powder 50gm pouch', rate: 66.67, category: 'Cumin Powder' },
            { id: 'prod_25', name: 'Pran Cumin Powder 100gm pouch', rate: 129.09, category: 'Cumin Powder' },
            { id: 'prod_26', name: 'Pran Cumin Powder 200gm pouch', rate: 247.11, category: 'Cumin Powder' },
            { id: 'prod_27', name: 'Pran Cumin Powder 200gm Jar', rate: 268.18, category: 'Cumin Powder' },
            { id: 'prod_28', name: 'Pran Cumin Powder 500gm pouch', rate: 578.57, category: 'Cumin Powder' },
            { id: 'prod_29', name: 'Fish Masala 20gm Foil NEW', rate: 15.00, category: 'Mixed Spice and box' },
            { id: 'prod_30', name: 'Beef Masala 20gm Foil NEW', rate: 15.45, category: 'Mixed Spice and box' },
            { id: 'prod_31', name: 'Chicken Masala 20gm Foil NEW', rate: 15.11, category: 'Mixed Spice and box' },
            { id: 'prod_32', name: 'Meat Masala 20gm Foil NEW', rate: 15.45, category: 'Mixed Spice and box' },
            { id: 'prod_33', name: 'Biriyani Masala Mix 25 gm', rate: 30.74, category: 'Mixed Spice and box' },
            { id: 'prod_34', name: 'Meat Masala 100gm×48pcs P.Box', rate: 76.36, category: 'Mixed Spice and box' },
            { id: 'prod_35', name: 'Chicken Masala 100gm×48pcs P.Box', rate: 75.00, category: 'Mixed Spice and box' },
            { id: 'prod_36', name: 'Chicken Roast Masala 35gm×48pcs P.Box', rate: 48.89, category: 'Mixed Spice and box' },
            { id: 'prod_37', name: 'Tehari Masala 40gm×48pcs P.Box', rate: 44.16, category: 'Mixed Spice and box' },
            { id: 'prod_38', name: 'Bombay Biryani Masala 45gm×48pcs P.Box', rate: 48.00, category: 'Mixed Spice and box' },
            { id: 'prod_39', name: 'Biryani Masala 40gm×48pcs P.Box', rate: 46.15, category: 'Mixed Spice and box' },
            { id: 'prod_40', name: 'Chatpati Masala 45gm×48pcs P.Box', rate: 36.00, category: 'Mixed Spice and box' },
            { id: 'prod_41', name: 'Firni Mix 150gm×48pcs P.Box', rate: 48.40, category: 'Mixed Spice and box' },
            { id: 'prod_42', name: 'BBQ Sheik Kabab Masala 50gm×48pcs P.Box', rate: 62.77, category: 'Mixed Spice and box' },
            { id: 'prod_43', name: 'Kacchi Biryani Masala 45gm×48pcs P.Box', rate: 52.53, category: 'Mixed Spice and box' },
            { id: 'prod_44', name: 'Haleem Mix  200 gm', rate: 54.67, category: 'Mixed Spice and box' },
            { id: 'prod_45', name: 'Curry powder 20gm', rate: 90.10, category: 'Mixed Spice and box' },
            { id: 'prod_46', name: 'Garam Masala 15gm Foil New', rate: 27.50, category: 'Mixed Spice and box' },
            { id: 'prod_47', name: 'Payes Mix 150gmX48pcs P.Box', rate: 53.78, category: 'Mixed Spice and box' },
            { id: 'prod_48', name: 'Kacchi Biryani Masala 40 gm', rate: 52.53, category: 'Mixed Spice and box' },
            { id: 'prod_49', name: 'Beef Kala Bhuna 80 gm', rate: 91.58, category: 'Mixed Spice and box' },
            { id: 'prod_50', name: 'Shindhi Biriany Masala 45 gm', rate: 44.31, category: 'Mixed Spice and box' },
            { id: 'prod_51', name: 'Khichuri Masala 50 gm', rate: 48.96, category: 'Mixed Spice and box' },
            { id: 'prod_52', name: 'Mustard Oil-80ml', rate: 23.56, category: 'Mustard Oil' },
            { id: 'prod_53', name: 'Mustard Oil-200-mL', rate: 52.89, category: 'Mustard Oil' },
            { id: 'prod_54', name: 'Mustard Oil-250ml', rate: 66.00, category: 'Mustard Oil' },
            { id: 'prod_55', name: 'Mustard Oil-500 ml', rate: 136.89, category: 'Mustard Oil' },
            { id: 'prod_56', name: 'Mustard Oil 500ml-CP', rate: 118.34, category: 'Mustard Oil' },
            { id: 'prod_57', name: 'Mustard Oil-1000ml', rate: 265.71, category: 'Mustard Oil' },
            { id: 'prod_58', name: 'Mustard Oil 1000ml-CP', rate: 255.11, category: 'Mustard Oil' },
            { id: 'prod_59', name: 'Mustard oil 2 liter', rate: 528.89, category: 'Mustard Oil' },
            { id: 'prod_60', name: 'M . Oil 5 Liter', rate: 1102.22, category: 'Mustard Oil' },
            { id: 'prod_61', name: 'Mughal 150 ml', rate: 43.00, category: 'Mustard Oil' },
            { id: 'prod_62', name: 'Mustard oil 16kg Tin', rate: 3270.00, category: 'Mustard Oil' },
            { id: 'prod_63', name: 'Testing salt 20 gm', rate: 7.08, category: 'Testing salt' },
            { id: 'prod_64', name: 'T-Salt-40 gm New', rate: 14.17, category: 'Testing salt' },
            { id: 'prod_65', name: 'T-Salt-100 gm New', rate: 35.00, category: 'Testing salt' },
            { id: 'prod_66', name: 'T-Salt 450 gm', rate: 137.89, category: 'Testing salt' },
            { id: 'prod_67', name: 'Shader Masala 4gmX480 Pcs', rate: 3.40, category: 'Shader Masala ' },
            { id: 'prod_68', name: 'Whole Panchforan 50gm New', rate: 23.41, category: 'Panchforan and Jello' },
            { id: 'prod_69', name: 'The chef Tomato Sauce 295gm', rate: 86.20, category: 'Sauce and Vinegar' },
            { id: 'prod_70', name: 'The Chef Hot Tomato Sauce-1000gm', rate: 229.62, category: 'Sauce and Vinegar' },
            { id: 'prod_71', name: 'The Chef Hot Tomato Sauce 3 Kg', rate: 467.03, category: 'Sauce and Vinegar' },
            { id: 'prod_72', name: 'The chef White Vinager 330 ml', rate: 26.40, category: 'Sauce and Vinegar' },
            { id: 'prod_73', name: 'The chef White vinager 650 ml', rate: 43.56, category: 'Sauce and Vinegar' },
            { id: 'prod_74', name: 'The chef white vinager 5 ltr', rate: 213.18, category: 'Sauce and Vinegar' },
            { id: 'prod_75', name: 'Love Jello-18 pcs Poly', rate: 40.00, category: 'Panchforan and Jello' },
            { id: 'prod_76', name: 'Love Jelly-100pcs', rate: 215.00, category: 'Panchforan and Jello' },
            { id: 'prod_77', name: 'The Chef Rose Water 200 ML', rate: 15.94, category: 'Rose and Kewra' },
            { id: 'prod_78', name: 'The Chef Kewra Water 200 ML', rate: 15.11, category: 'Rose and Kewra' },
            { id: 'prod_79', name: 'The Chef Rose Water 160 ML', rate: 12.00, category: 'Rose and Kewra' },
            { id: 'prod_80', name: 'The Chef Chinigura Rice 1 Kg', rate: 136.00, category: 'Rice' }
        ];

        const reportingCategories = {
            "Basic Spice": ["Chili Powder 50gm NEW", "Chili Powder 100gm NEW", "Chili Powder - 200gm", "Chili Powder-500gm x 24", "Chili Powder-1kg", "Chili powder 200 gm jar", "Turmeric Powder 15gm New", "Turmeric Powder 50gm NEW", "Turmeric Powder 100gm NEW", "Turmeric Powder 200 gm", "Turmeric Powder 500gmX24 Pouch", "Turmeric Powder-1kg", "Turmeric powder 200 gm jar", "Pran Coriander Powder 50 gm pouch", "Pran Coriander Powder 100 gm pouch", "Pran Coriander Powder 200 gm pouch", "Pran Coriander Powder 500 gm pouch", "Pran Coriander Powder 200 gm Jar", "Pran Cumin Powder 15gm pouch", "Pran Cumin Powder 50gm pouch", "Pran Cumin Powder 100gm pouch", "Pran Cumin Powder 200gm pouch", "Pran Cumin Powder 200gm Jar", "Pran Cumin Powder 500gm pouch"],
            "Mixed Spice": ["Fish Masala 20gm Foil NEW", "Beef Masala 20gm Foil NEW", "Chicken Masala 20gm Foil NEW", "Meat Masala 20gm Foil NEW", "Biriyani Masala Mix 25 gm", "Meat Masala 100gm×48pcs P.Box", "Chicken Masala 100gm×48pcs P.Box", "Chicken Roast Masala 35gm×48pcs P.Box", "Tehari Masala 40gm×48pcs P.Box", "Bombay Biryani Masala 45gm×48pcs P.Box", "Biryani Masala 40gm×48pcs P.Box", "Chatpati Masala 45gm×48pcs P.Box", "Firni Mix 150gm×48pcs P.Box", "BBQ Sheik Kabab Masala 50gm×48pcs P.Box", "Kacchi Biryani Masala 45gm×48pcs P.Box", "Haleem Mix  200 gm", "Curry powder 20gm", "Payes Mix 150gmX48pcs P.Box", "Kacchi Biryani Masala 40 gm", "Beef Kala Bhuna 80 gm", "Shindhi Biriany Masala 45 gm", "Khichuri Masala 50 gm"],
            "Must. oil": ["Mustard Oil-80ml", "Mustard Oil-200-mL", "Mustard Oil-250ml", "Mustard Oil-500 ml", "Mustard Oil 500ml-CP", "Mustard Oil-1000ml", "Mustard Oil 1000ml-CP", "Mustard oil 2 liter", "M . Oil 5 Liter", "Mughal 150 ml"],
            "Must. oil Bulk": ["Mustard oil 16kg Tin"],
            "Oil": [],
            "Others": ["Whole Panchforan 50gm New", "The chef Tomato Sauce 295gm", "The Chef Hot Tomato Sauce-1000gm", "The Chef Hot Tomato Sauce 3 Kg", "The Chef Rose Water 200 ML", "The Chef Kewra Water 200 ML", "The Chef Rose Water 160 ML", "Garam Masala 15gm Foil New"],
            "Shader Masala": ["Shader Masala 4gmX480 Pcs"],
            "Spice Bulk": ["Chili powder 5 kg-New", "16 Ana Chilli-15Kg (Bulk)", "Turmeric Powder- 5kg", "16 Ana Turmeric 15kg (Bulk)"],
            "Testing Salt": ["Testing salt 20 gm", "T-Salt-40 gm New", "T-Salt-100 gm New", "T-Salt 450 gm"],
            "White Vinegar": ["The chef White Vinager 330 ml", "The chef White vinager 650 ml", "The chef white vinager 5 ltr"]
        };


        function assignCategoriesToProducts(products) {
            const categoryMap = defaultProducts.reduce((map, p) => {
                map[p.name] = p.category;
                return map;
            }, {});

            return products.map(p => {
                if (!p.category && categoryMap[p.name]) {
                    p.category = categoryMap[p.name];
                }
                return p;
            });
        }

        function resetLocalState() {
             state = {
                loggedInUser: null,
                loggedInUserName: null,
                loggedInUserUsername: null,
                loggedInUserRole: null,
                loggedInUserTeam: null,
                loggedInUserTeamId: null,
                currentReportItems: [],
                superAdminPassword: 'shohel2nt',
                teamAdmins: [],
                salesReports: [],
                products: [],
                categories: [],
                notificationSettings: {},
                logoutSettings: {},
                voiceSettings: {},
                advertisements: {
                    popunder: '',
                    banner: '',
                    nativeBanner: ''
                },
                superAdminNotice: '',
                notices: {},
                reportingSettings: {},
                sidebarMenuConfig: [],
            };
        }


        // --- Firebase Data Functions ---
        async function getFullState() {
            try {
                const snapshot = await db.ref().once('value');
                const dbState = snapshot.val() || {};

                const firebaseObjectToArray = (fbObject) => {
                    if (!fbObject) return [];
                    return Object.keys(fbObject).map(key => ({ id: key, ...fbObject[key] }));
                };
                
                state.teamAdmins = firebaseObjectToArray(dbState.teamAdmins);
                state.salesReports = firebaseObjectToArray(dbState.salesReports);
                state.products = firebaseObjectToArray(dbState.products);
                state.categories = firebaseObjectToArray(dbState.categories);
                state.advertisements = dbState.advertisements || { popunder: '', banner: '', nativeBanner: ''};
                state.superAdminNotice = dbState.superAdminNotice || '';
                state.notices = dbState.notices || {};
                state.notificationSettings = dbState.notificationSettings || {};
                state.logoutSettings = dbState.logoutSettings || {};
                state.voiceSettings = dbState.voiceSettings || {};
                state.reportingSettings = dbState.reportingSettings || {};
                state.sidebarMenuConfig = dbState.sidebarMenuConfig || {};


                if (!dbState.products || state.products.length < 80) {
                    const productsToPush = defaultProducts.reduce((obj, item) => {
                        obj[item.id] = { name: item.name, rate: item.rate, category: item.category };
                        return obj;
                    }, {});
                    await db.ref('products').set(productsToPush);
                    await getFullState(); // Re-fetch after seeding
                    return;
                }

                // Assign categories to products from DB
                state.products = assignCategoriesToProducts(state.products);


                if (dbState.superAdmin && dbState.superAdmin.password) {
                    state.superAdminPassword = dbState.superAdmin.password;
                } else {
                     await db.ref('superAdmin/password').set(state.superAdminPassword);
                }

                 if (!dbState.advertisements) {
                    await db.ref('advertisements').set(state.advertisements);
                }

            } catch (error) {
                console.error("Error fetching data from Firebase:", error);
                showAlert("Could not connect to the database. Please check your connection and Firebase setup.");
            }
        }

        
        // --- Utility Functions ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const page = document.getElementById(pageId);
             if (page) {
                page.classList.add('active');
                document.body.style.overflowY = (pageId === 'teamAdminDashboard' || pageId === 'superAdminDashboard') ? 'auto' : 'hidden';

                 // Set default dates when a page with reports is shown
                const today = new Date().toISOString().split('T')[0];
                if (pageId === 'teamAdminDashboard') {
                    // Daily Report
                    const reportDateEl = document.getElementById('reportDate');
                    if (reportDateEl) reportDateEl.value = today;

                    // Date Range Report
                    const reportStartDateEl = document.getElementById('reportStartDate');
                    if(reportStartDateEl) reportStartDateEl.value = today;
                    const reportEndDateEl = document.getElementById('reportEndDate');
                    if(reportEndDateEl) reportEndDateEl.value = today;
                    
                    // Category Report
                    const categoryReportStartDateEl = document.getElementById('categoryReportStartDate');
                    if(categoryReportStartDateEl) categoryReportStartDateEl.value = today;
                    const categoryReportEndDateEl = document.getElementById('categoryReportEndDate');
                    if(categoryReportEndDateEl) categoryReportEndDateEl.value = today;

                    // SKU TGT vs Sales Report
                    const skuTgtDateEl = document.getElementById('skuTgtDate');
                    if (skuTgtDateEl) skuTgtDateEl.value = today;
                    const skuSalesDateEl = document.getElementById('skuSalesDate');
                    if (skuSalesDateEl) skuSalesDateEl.value = today;

                    // Submission Status Report
                    const submissionStatusDateEl = document.getElementById('submissionStatusDate');
                    if (submissionStatusDateEl) submissionStatusDateEl.value = today;
                }
                if (pageId === 'teamMemberDashboard') {
                    // Member Category Report
                    const myCategoryReportStartDateEl = document.getElementById('myCategoryReportStartDate');
                    if(myCategoryReportStartDateEl) myCategoryReportStartDateEl.value = today;
                    const myCategoryReportEndDateEl = document.getElementById('myCategoryReportEndDate');
                    if(myCategoryReportEndDateEl) myCategoryReportEndDateEl.value = today;
                }


                // Show/hide voice assistant based on page
                const voiceAssistant = document.getElementById('voice-assistant-container');
                if (pageId === 'teamAdminDashboard') {
                    voiceAssistant.style.display = 'block';
                } else {
                    voiceAssistant.style.display = 'none';
                }

            } else {
                 document.body.style.overflowY = 'hidden';
            }

            renderAdvertisements(pageId);
        }

        async function performLogout() {
            if (alarmIntervalId) clearInterval(alarmIntervalId);
            if (adminNotificationIntervalId) clearInterval(adminNotificationIntervalId);
            alarmIntervalId = null;
            adminNotificationIntervalId = null;

            localStorage.removeItem('loggedInUser');
            resetLocalState();
            await getFullState(); 
            document.querySelectorAll('input[type="password"], input[type="text"]').forEach(input => input.value = '');
            showPage('mainLoginPage');
        }

        function handleLogoutClick(event) {
            let requiredClicks = 1;
            
            if (state.loggedInUserRole === 'teammember') {
                const adminSettings = state.logoutSettings[state.loggedInUserTeamId];
                requiredClicks = (adminSettings && adminSettings.clickCount) ? parseInt(adminSettings.clickCount, 10) : 10;
            } else if (state.loggedInUserRole === 'teamadmin') {
                 const adminSettings = state.logoutSettings[state.loggedInUser];
                 requiredClicks = (adminSettings && adminSettings.clickCount) ? parseInt(adminSettings.clickCount, 10) : 10;
            }

            if(requiredClicks <= 1) {
                performLogout();
                return;
            }

            logoutClickCounter++;
            
            clearTimeout(logoutClickTimer);
            logoutClickTimer = setTimeout(() => {
                logoutClickCounter = 0;
            }, 2000); 

            if (logoutClickCounter >= requiredClicks) {
                clearTimeout(logoutClickTimer);
                performLogout();
            }
        }


        function showAlert(message) {
            alert(message);
        }
        
        // --- Super Admin Functions ---
        function loginSuperAdmin() {
            const password = document.getElementById('superAdminPassword').value;
            if (password === state.superAdminPassword) {
                const user = {
                    id: 'superadmin',
                    role: 'superadmin'
                };
                localStorage.setItem('loggedInUser', JSON.stringify(user));
                
                state.loggedInUser = user.id;
                state.loggedInUserRole = user.role;
                
                renderSuperAdminDashboard();
                showPage('superAdminDashboard');
            } else {
                showAlert('Incorrect password!');
            }
        }

        async function createTeamAdmin() {
            const username = document.getElementById('newTeamAdminUsername').value.trim();
            const password = document.getElementById('newTeamAdminPassword').value.trim();
            if (!username || !password) {
                return showAlert('Username and password cannot be empty.');
            }
            if (state.teamAdmins.find(admin => admin.username === username)) {
                return showAlert('This username already exists.');
            }
            
            const newAdminData = { username, password, status: 'active' };
            await db.ref('teamAdmins').push(newAdminData);

            document.getElementById('newTeamAdminUsername').value = '';
            document.getElementById('newTeamAdminPassword').value = '';
            
            await getFullState();
            renderSuperAdminDashboard();
            showAlert('Team Admin created successfully!');
            showPage('superAdminDashboard');
        }

        async function saveUserCredentials(type, adminId, memberId = null) {
            const newUsername = prompt(`Enter new username for this ${type}:`);
            if (!newUsername) return; // User cancelled
            const newPassword = prompt(`Enter new password for this ${type}:`);
            if (!newPassword) return; // User cancelled


            if (!newUsername || !newPassword) {
                return showAlert('Username and password cannot be empty.');
            }

            try {
                if (type === 'admin') {
                    await db.ref(`teamAdmins/${adminId}`).update({ username: newUsername, password: newPassword });
                } else if (type === 'member' && memberId) {
                    await db.ref(`teamAdmins/${adminId}/teamMembers/${memberId}`).update({ username: newUsername, password: newPassword });
                }
                await getFullState();
                
                if (state.loggedInUserRole === 'superadmin') {
                    renderSuperAdminDashboard();
                } else if (state.loggedInUserRole === 'teamadmin') {
                    renderTeamAdminDashboard();
                }

                showAlert(`${type.charAt(0).toUpperCase() + type.slice(1)} credentials updated successfully!`);
            } catch (error) {
                console.error("Error updating credentials:", error);
                showAlert('Failed to update credentials.');
            }
        }
        
        async function deleteTeamAdmin(adminId, adminUsername) {
            if (confirm(`Are you sure you want to delete ${adminUsername}? This will also delete all their team members and sales reports.`)) {
                await db.ref(`teamAdmins/${adminId}`).remove();
                
                const reportsToDelete = state.salesReports.filter(r => r.team === adminUsername);
                const updates = {};
                reportsToDelete.forEach(r => {
                    updates[`/salesReports/${r.id}`] = null;
                });
                if(Object.keys(updates).length > 0) {
                    await db.ref().update(updates);
                }

                await getFullState();
                renderSuperAdminDashboard();
            }
        }

        async function toggleTeamAdminStatus(adminId) {
            const admin = state.teamAdmins.find(admin => admin.id === adminId);
            if (admin) {
                const newStatus = admin.status === 'active' ? 'deactivated' : 'active';
                await db.ref(`teamAdmins/${adminId}/status`).set(newStatus);
                await getFullState();
                renderSuperAdminDashboard();
            }
        }

        async function saveAdvertisements() {
            const popunder = document.getElementById('popunderAd').value.trim();
            const banner = document.getElementById('bannerAd').value.trim();
            const nativeBanner = document.getElementById('nativeBannerAd').value.trim();

            const newAds = { popunder, banner, nativeBanner };
            await db.ref('advertisements').set(newAds);
            
            state.advertisements = newAds;
            showAlert('Advertisements saved successfully!');
        }

        async function saveSuperAdminNotice() {
            const notice = document.getElementById('superAdminNotice').value;
            await db.ref('superAdminNotice').set(notice);
            state.superAdminNotice = notice;
            showAlert('Notice for team admins saved successfully!');
        }

        async function deleteSuperAdminNotice() {
             if (confirm('Are you sure you want to delete the notice for team admins?')) {
                await db.ref('superAdminNotice').remove();
                state.superAdminNotice = '';
                document.getElementById('superAdminNotice').value = '';
                showAlert('Notice deleted successfully.');
            }
        }
        
        async function changeSuperAdminPassword() {
            const newPassword = document.getElementById('newSuperAdminPassword').value;
            const confirmPassword = document.getElementById('confirmSuperAdminPassword').value;

            if (!newPassword || !confirmPassword) {
                return showAlert('Please fill in both password fields.');
            }
            if (newPassword !== confirmPassword) {
                return showAlert('Passwords do not match.');
            }
            if (newPassword.length < 6) {
                return showAlert('Password must be at least 6 characters long.');
            }

            await db.ref('superAdmin/password').set(newPassword);
            state.superAdminPassword = newPassword;
            
            document.getElementById('newSuperAdminPassword').value = '';
            document.getElementById('confirmSuperAdminPassword').value = '';

            showAlert('Super admin password changed successfully!');
        }


        function renderAdvertisementManagement() {
            document.getElementById('popunderAd').value = state.advertisements.popunder || '';
            document.getElementById('bannerAd').value = state.advertisements.banner || '';
            document.getElementById('nativeBannerAd').value = state.advertisements.nativeBanner || '';
        }

        function renderSuperAdminDashboard() {
            const teamAdminsList = document.getElementById('teamAdminsList');
            teamAdminsList.innerHTML = '';
            document.getElementById('teamAdminCount').innerText = state.teamAdmins.length;
            document.getElementById('superAdminNotice').value = state.superAdminNotice || '';


            if (state.teamAdmins.length === 0) {
                teamAdminsList.innerHTML = '<p class="text-gray-500">No team admins created yet.</p>';
            } else {
                state.teamAdmins.forEach(admin => {
                    const div = document.createElement('div');
                    div.className = 'p-3 border rounded';
                    
                    const statusClass = admin.status === 'active' ? 'text-green-600' : 'text-red-600';
                    const toggleButtonText = admin.status === 'active' ? 'Deactivate' : 'Activate';
                    const toggleButtonClass = admin.status === 'active' ? 'btn-warning' : 'btn-success';
                    
                    const members = admin.teamMembers && typeof admin.teamMembers === 'object' 
                        ? Object.keys(admin.teamMembers).map(key => ({id: key, ...admin.teamMembers[key]})) 
                        : [];
                    
                    let membersHtml = '<p class="text-sm text-gray-500 mt-2">No team members yet.</p>';
                    if (members.length > 0) {
                        membersHtml = `
                            <div class="mt-2 border-t pt-2 space-y-2">
                                ${members.map(member => `
                                    <div class="flex justify-between items-center text-sm p-1 bg-gray-50 rounded">
                                        <span>${member.name} (@${member.username})</span>
                                        <button onclick="saveUserCredentials('member', '${admin.id}', '${member.id}')" class="btn btn-secondary btn-sm">Edit</button>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }

                    div.innerHTML = `
                         <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                            <div class="mb-2 md:mb-0">
                                <span class="font-semibold">${admin.username}</span>
                                <span class="text-sm ml-2 ${statusClass}">(${admin.status || 'active'})</span>
                                <span class="text-sm ml-2 font-bold">(${members.length} Members)</span>
                            </div>
                            <div class="space-x-2 flex">
                                <button onclick="saveUserCredentials('admin', '${admin.id}')" class="btn btn-secondary btn-sm">Edit Admin</button>
                                <button onclick="toggleTeamAdminStatus('${admin.id}')" class="btn ${toggleButtonClass} btn-sm">${toggleButtonText}</button>
                                <button onclick="deleteTeamAdmin('${admin.id}', '${admin.username}')" class="btn btn-danger btn-sm">Delete</button>
                            </div>
                        </div>
                        <div class="mt-2">
                             <h4 class="text-sm font-semibold text-gray-700">Team Members:</h4>
                            ${membersHtml}
                        </div>
                    `;
                    teamAdminsList.appendChild(div);
                });
            }
            
            document.getElementById('newSuperAdminPassword').value = '';
            document.getElementById('confirmSuperAdminPassword').value = '';
            renderAdvertisementManagement();
        }


        // --- Team Admin Functions ---
        async function loginTeamAdmin() {
            const username = document.getElementById('teamAdminUsername').value.trim();
            const password = document.getElementById('teamAdminPassword').value.trim();
            const admin = state.teamAdmins.find(a => a.username === username && a.password === password);
            
            if (admin) {
                if (admin.status === 'deactivated') {
                    return showAlert('Your account has been deactivated. Please contact the super admin.');
                }
                const user = {
                    id: admin.id,
                    username: admin.username,
                    role: 'teamadmin'
                };
                localStorage.setItem('loggedInUser', JSON.stringify(user));

                state.loggedInUser = user.id;
                state.loggedInUserName = user.username;
                state.loggedInUserRole = user.role;
                
                await getFullState(); 
                renderTeamAdminDashboard();
                showPage('teamAdminDashboard');
                playVoice("স্বাগতম এডমিন");
            } else {
                showAlert('Invalid username or password.');
            }
        }
        
        async function createTeamMember() {
            const name = document.getElementById('newTeamMemberName').value.trim();
            const username = document.getElementById('newTeamMemberUsername_sidebar').value.trim();
            const password = document.getElementById('newTeamMemberPassword_sidebar').value.trim();
            const adminId = state.loggedInUser;

            if (!name || !username || !password) {
                return showAlert('Name, username and password cannot be empty.');
            }
            
            let usernameExists = false;
            for(const admin of state.teamAdmins) {
                 if (admin.username === username) { // Check against admin usernames too
                    usernameExists = true;
                    break;
                }
                if (!admin.teamMembers || typeof admin.teamMembers !== 'object') continue;
                const members = Object.values(admin.teamMembers);
                if (members.some(m => m.username === username)) {
                    usernameExists = true;
                    break;
                }
            }
            
            if (usernameExists) {
                return showAlert('This username is already taken.');
            }
            
            const newMemberData = { name, username, password, status: 'active' };
            await db.ref(`teamAdmins/${adminId}/teamMembers`).push(newMemberData);
            
            document.getElementById('newTeamMemberName').value = '';
            document.getElementById('newTeamMemberUsername_sidebar').value = '';
            document.getElementById('newTeamMemberPassword_sidebar').value = '';
            
            await getFullState();
            renderTeamAdminDashboard();
            showAlert('Team Member created successfully!');
            switchAdminView('view_manage_team_members');
        }

        async function deleteTeamMember(memberId) {
            const adminId = state.loggedInUser;
            const admin = state.teamAdmins.find(a => a.id === adminId);
             if (!admin || !admin.teamMembers) return;
            
            const memberKey = Object.keys(admin.teamMembers).find(key => key === memberId);

            if (memberKey && confirm(`Are you sure you want to delete this member?`)) {
                 await db.ref(`teamAdmins/${adminId}/teamMembers/${memberKey}`).remove();
                 await getFullState();
                 renderTeamAdminDashboard();
            }
        }

        async function toggleTeamMemberStatus(memberId) {
            const adminId = state.loggedInUser;
            const admin = state.teamAdmins.find(a => a.id === adminId);
             if (!admin || !admin.teamMembers) return;

            const memberKey = Object.keys(admin.teamMembers).find(key => key === memberId);
            if (!memberKey) return;
            const member = admin.teamMembers[memberKey];

            if (member) {
                const newStatus = member.status === 'active' ? 'deactivated' : 'active';
                await db.ref(`teamAdmins/${adminId}/teamMembers/${memberKey}/status`).set(newStatus);
                await getFullState();
                renderTeamAdminDashboard();
            }
        }

        async function updateProductRate(productId, newRate) {
            if (newRate !== '' && !isNaN(newRate)) {
                await db.ref(`products/${productId}/rate`).set(parseFloat(newRate));
                await getFullState();
                filterProductsForAdmin(document.getElementById('adminProductSearch').value); 
            }
        }
        
        async function deleteProduct(productId, productName) {
             if (confirm(`Are you sure you want to delete the product "${productName}"? This action cannot be undone.`)) {
                await db.ref(`products/${productId}`).remove();
                await getFullState();
                filterProductsForAdmin('');
                renderCategoryManagement();
                showAlert('Product deleted successfully!');
            }
        }

        function filterProductsForAdmin(searchTerm) {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const filteredProducts = state.products.filter(product => 
                product.name.toLowerCase().includes(lowerCaseSearchTerm)
            );
            renderProductManagement(filteredProducts);
        }

        function renderProductManagement(productsToRender) {
            const container = document.getElementById('productListForAdmin');
            container.innerHTML = '';
            const products = productsToRender || state.products;

            if (products.length === 0) {
                container.innerHTML = '<p class="text-gray-500 p-4">No products found.</p>';
                return;
            }

            products.forEach((product) => {
                const div = document.createElement('div');
                div.className = 'p-3 border-b grid grid-cols-1 md:grid-cols-4 items-center gap-4';
                div.innerHTML = `
                    <span class="font-semibold col-span-1 md:col-span-2">${product.name}</span>
                    <input 
                        type="number" 
                        value="${product.rate.toFixed(2)}" 
                        onchange="updateProductRate('${product.id}', this.value)"
                        class="input-field !mb-0 text-right"
                    >
                    <button onclick="deleteProduct('${product.id}', '${product.name.replace(/'/g, "\\'")}')" class="btn btn-danger btn-sm">Delete</button>
                `;
                container.appendChild(div);
            });
        }
        
        async function addNewProduct() {
            const name = document.getElementById('newProductName').value.trim();
            const rate = parseFloat(document.getElementById('newProductRate').value);
            const category = document.getElementById('newProductCategory').value.trim();

            if (!name || isNaN(rate)) {
                return showAlert('Please fill in Product Name and Rate.');
            }
             if (!category) {
                 return showAlert('Please add a category for the product.');
            }
            if (state.products.find(p => p.name.toLowerCase() === name.toLowerCase())) {
                return showAlert('A product with this name already exists.');
            }
            
            const newProductData = { name, rate, category };
            await db.ref('products').push(newProductData);
                        
            document.getElementById('newProductName').value = '';
            document.getElementById('newProductRate').value = '';
            document.getElementById('newProductCategory').value = '';
            
            await getFullState();
            filterProductsForAdmin(''); // Re-render product list
            renderCategoryManagement(); // Refresh category lists
            showAlert('New product added successfully!');
        }
        
        async function saveTeamAdminNotice() {
            const adminId = state.loggedInUser;
            const notice = document.getElementById('teamAdminNotice').value;
            await db.ref(`notices/${adminId}`).set(notice);
            state.notices[adminId] = notice;
            showAlert('Notice for team members saved successfully!');
        }

        async function deleteTeamAdminNotice() {
            const adminId = state.loggedInUser;
            if (confirm('Are you sure you want to delete the notice for your team members?')) {
                await db.ref(`notices/${adminId}`).remove();
                state.notices[adminId] = '';
                document.getElementById('teamAdminNotice').value = '';
                showAlert('Notice deleted successfully.');
            }
        }
        
        async function renderTeamAdminDashboard() {
            document.getElementById('loggedInTeamAdminUsername').innerText = state.loggedInUserName;
            const admin = state.teamAdmins.find(a => a.id === state.loggedInUser);
            if (!admin) return;

            const superAdminNoticeContainer = document.getElementById('superAdminNoticeContainerForAdmin');
            if (state.superAdminNotice) {
                superAdminNoticeContainer.innerHTML = `
                    <div class="p-4 mb-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700">
                        <p class="font-bold">Notice from Super Admin</p>
                        <marquee behavior="scroll" direction="left">${state.superAdminNotice}</marquee>
                    </div>`;
            } else {
                superAdminNoticeContainer.innerHTML = '';
            }

            document.getElementById('teamAdminNotice').value = state.notices[admin.id] || '';

            const teamMembersList = document.getElementById('teamMembersList');
            teamMembersList.innerHTML = '';
            
            const members = admin.teamMembers && typeof admin.teamMembers === 'object' 
                ? Object.keys(admin.teamMembers).map(key => ({id: key, ...admin.teamMembers[key]})) 
                : [];

            if (members.length === 0) {
                 teamMembersList.innerHTML = '<p class="text-gray-500">No team members created yet.</p>';
            } else {
                members.forEach(member => {
                    const div = document.createElement('div');
                    div.className = 'p-3 border rounded flex flex-col md:flex-row justify-between items-start md:items-center';
                    const statusClass = member.status === 'active' ? 'text-green-600' : 'text-red-600';
                    const toggleButtonText = member.status === 'active' ? 'Deactivate' : 'Activate';
                    const toggleButtonClass = member.status === 'active' ? 'btn-warning' : 'btn-success';

                    div.innerHTML = `
                         <div class="mb-2 md:mb-0">
                            <span class="font-semibold">${member.name}</span> (@${member.username})
                            <span class="text-sm ml-2 ${statusClass}">(${member.status || 'active'})</span>
                        </div>
                        <div class="space-x-2 flex">
                            <button onclick="saveUserCredentials('member', '${admin.id}', '${member.id}')" class="btn btn-secondary btn-sm">Edit</button>
                            <button onclick="toggleTeamMemberStatus('${member.id}')" class="btn ${toggleButtonClass} btn-sm">${toggleButtonText}</button>
                            <button onclick="deleteTeamMember('${member.id}')" class="btn btn-danger btn-sm">Delete</button>
                        </div>
                    `;
                    teamMembersList.appendChild(div);
                });
            }

            // Populate member and product dropdowns for reports
            const reportMemberSelect = document.getElementById('reportMemberSelect');
            if(reportMemberSelect) {
                reportMemberSelect.innerHTML = '<option value="all">All Members</option>';
                members.forEach(member => {
                    reportMemberSelect.innerHTML += `<option value="${member.username}">${member.name}</option>`;
                });
            }
            
            const reportProductSelect = document.getElementById('reportProductSelect');
             if(reportProductSelect) {
                reportProductSelect.innerHTML = '<option value="all">All Products</option>';
                state.products.forEach(product => {
                    reportProductSelect.innerHTML += `<option value="${product.name}">${product.name}</option>`;
                });
            }

            const categoryMemberSelect = document.getElementById('categoryReportMemberSelect');
            if(categoryMemberSelect) {
                categoryMemberSelect.innerHTML = '<option value="all">All Members</option>';
                members.forEach(member => {
                    categoryMemberSelect.innerHTML += `<option value="${member.username}">${member.name}</option>`;
                });
            }
            
            // Populate filters for new SKU TGT vs Sales report
            const skuMemberSelect = document.getElementById('skuMemberSelect');
            if(skuMemberSelect){
                skuMemberSelect.innerHTML = '<option value="all">All Members</option>';
                members.forEach(member => {
                    skuMemberSelect.innerHTML += `<option value="${member.username}">${member.name}</option>`;
                });
            }
            
            const allCategories = [...new Set(state.products.map(p => p.category).filter(Boolean))].sort();
            const skuCategorySelect = document.getElementById('skuCategorySelect');
            if(skuCategorySelect){
                skuCategorySelect.innerHTML = '<option value="all">All Categories</option>';
                allCategories.forEach(cat => {
                    skuCategorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                });
            }

            const skuProductSelect = document.getElementById('skuProductSelect');
            if(skuProductSelect) {
                skuProductSelect.innerHTML = '<option value="all">All Products</option>';
                state.products.sort((a,b) => a.name.localeCompare(b.name)).forEach(product => {
                    skuProductSelect.innerHTML += `<option value="${product.name}">${product.name}</option>`;
                });
            }


            document.getElementById('adminProductSearch').value = '';
            renderProductManagement(state.products);
            renderNotificationSettings();
            renderLogoutSettings();
            renderCategoryManagement();
            renderVoiceSettings();
            renderSkuReportSettings();
            renderReportFormatSettings();
            renderMenuEditor();

            await setupAdminSidebar();
            switchAdminView('view_dashboard_default');
            
            renderReportSubmissionStatus();
            renderCategoryWiseReport();
        }

        function copyNotSubmittedNames() {
            const container = document.getElementById('submissionStatusContent');
            const namesText = container.querySelector('textarea')?.value;
            if (namesText) {
                navigator.clipboard.writeText(namesText).then(() => {
                    showAlert('Names copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy names: ', err);
                    showAlert('Failed to copy names.');
                });
            }
        }

        async function renderReportSubmissionStatus() {
            const dateInput = document.getElementById('submissionStatusDate');
            const selectedDateStr = dateInput.value || new Date().toISOString().split('T')[0];
            
            const admin = state.teamAdmins.find(a => a.id === state.loggedInUser);
            if (!admin) return;

            const allMembers = admin.teamMembers && typeof admin.teamMembers === 'object' 
                ? Object.values(admin.teamMembers).filter(m => m.status === 'active') 
                : [];
            
            const reportsForDate = state.salesReports.filter(r => {
                const reportDate = new Date(r.date);
                const selectedDate = new Date(selectedDateStr);
                return r.team === state.loggedInUserName &&
                        reportDate.getFullYear() === selectedDate.getFullYear() &&
                        reportDate.getMonth() === selectedDate.getMonth() &&
                        reportDate.getDate() === selectedDate.getDate();
            });
            const submittedMemberUsernames = new Set(reportsForDate.map(r => r.submittedBy));
            const notSubmittedMembers = allMembers.filter(m => !submittedMemberUsernames.has(m.username));

            const statusContainer = document.getElementById('submissionStatusContent');
            const totalMembers = allMembers.length;
            const submittedCount = submittedMemberUsernames.size;
            let notSubmittedNames = notSubmittedMembers.map(m => m.name).join(', ');
            if (notSubmittedNames) {
                notSubmittedNames = "যারা এখনো রিপোর্ট দেননি তাদের নাম দেয়া হলো, অনুগ্রহ পূর্বক রিপোর্ট দেন !!! " + notSubmittedNames + " belly9t-coder.github.io";
            }

            statusContainer.innerHTML = `
                <p class="font-bold">Total Members: ${totalMembers} | Submitted: ${submittedCount} | Not Submitted: ${notSubmittedMembers.length}</p>
                ${notSubmittedMembers.length > 0 ? `
                    <div class="mt-2">
                        <label for="notSubmittedNames" class="font-semibold">Members who did not submit:</label>
                        <div class="flex items-center">
                            <textarea readonly class="input-field !mb-0 flex-grow" rows="2">${notSubmittedNames}</textarea>
                            <button onclick="copyNotSubmittedNames()" class="btn btn-secondary ml-2">Copy</button>
                        </div>
                    </div>
                ` : '<p class="mt-2 text-green-600 font-semibold">All active members have submitted their reports for the selected date!</p>'}
            `;
        }

        
        async function copyTable(tableId) {
            const table = document.getElementById(tableId);
            try {
                let text = '';
                for (const row of table.rows) {
                    let rowText = [];
                    for(const cell of row.cells) {
                        rowText.push(cell.innerText);
                    }
                    text += rowText.join('\t') + '\n';
                }
                await navigator.clipboard.writeText(text);
                showAlert('Table data copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy table: ', err);
                showAlert('Failed to copy table. This feature may not be supported on your browser.');
            }
        }


        function getReportDataForDateRange(startDateStr, endDateStr, selectedMember, selectedProduct) {
            const admin = state.teamAdmins.find(a => a.id === state.loggedInUser);
            if (!admin) return { productData: {}, reportingMembers: [], grandTotalAmount: 0 };

            let reportingMembers = admin.teamMembers && typeof admin.teamMembers === 'object'
                ? Object.values(admin.teamMembers).filter(m => m.status === 'active') 
                : [];
            
            const startDate = new Date(startDateStr);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(endDateStr);
            endDate.setHours(23, 59, 59, 999);

            let reportsForDateRange = state.salesReports.filter(r => {
                const reportDate = new Date(r.date).getTime();
                return r.team === state.loggedInUserName && reportDate >= startDate.getTime() && reportDate <= endDate.getTime();
            });
            
            // Filter by member
            if (selectedMember && selectedMember !== 'all') {
                reportsForDateRange = reportsForDateRange.filter(r => r.submittedBy === selectedMember);
                reportingMembers = reportingMembers.filter(m => m.username === selectedMember);
            }

            const productData = {};
            const productsToList = (selectedProduct && selectedProduct !== 'all') ? state.products.filter(p => p.name === selectedProduct) : [...state.products];

            productsToList.forEach(product => {
                productData[product.name] = { 
                    rate: product.rate, 
                    members: {} 
                };
                reportingMembers.forEach(m => {
                    productData[product.name].members[m.name] = { tgt: 0, sales: 0, amount: 0 };
                });
            });

            let grandTotalAmount = 0;
            reportsForDateRange.forEach(report => {
                const member = reportingMembers.find(m => m.username === report.submittedBy);
                if (member && report.reportData && report.reportData.items) {
                    report.reportData.items.forEach(item => {
                        if (productData[item.name]) {
                            const productInfo = state.products.find(p => p.name === item.name);
                            const itemRate = productInfo ? productInfo.rate : item.rate;
                            const itemAmount = item.sales * itemRate;

                            productData[item.name].members[member.name].tgt += item.tgt;
                            productData[item.name].members[member.name].sales += item.sales;
                            productData[item.name].members[member.name].amount += itemAmount;
                        }
                    });
                }
            });
            
             // Calculate grand total from aggregated data
            Object.values(productData).forEach(pData => {
                Object.values(pData.members).forEach(mData => {
                    grandTotalAmount += mData.amount;
                });
            });

            return { productData, reportingMembers, grandTotalAmount };
        }
        
        function renderTeamAdminReportsForDateRange() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const member = document.getElementById('reportMemberSelect').value;
            const product = document.getElementById('reportProductSelect').value;
            if (!startDate || !endDate) {
                return showAlert('Please select both a start and end date.');
            }
            if (new Date(startDate) > new Date(endDate)) {
                return showAlert('Start date cannot be after end date.');
            }
            renderTeamAdminReports(startDate, endDate, member, product, 'dateRange');
        }

        function renderTeamAdminReports(date, endDate, selectedMember, selectedProduct, reportType = 'daily') {
            const isDateRange = reportType === 'dateRange';
            const selectedDateValue = date || document.getElementById('reportDate').value;
            const finalEndDate = endDate || selectedDateValue;
            
            const { productData, reportingMembers } = getReportDataForDateRange(selectedDateValue, finalEndDate, selectedMember, selectedProduct);

            const admin = state.teamAdmins.find(a => a.id === state.loggedInUser);
            if (!admin) return;

            const tablePrefix = isDateRange ? 'dateRange' : '';
            const memberRow = document.getElementById(`${tablePrefix}MemberRow`);
            const subHeaderRow = document.getElementById(`${tablePrefix}SubHeaderRow`);
            const tableBody = document.getElementById(`${tablePrefix}TableBody`);
            const tableFoot = document.getElementById(`${tablePrefix}TableFoot`);

            if (!memberRow || !subHeaderRow || !tableBody || !tableFoot) return;


            if (Object.keys(productData).length === 0) {
                if (memberRow) memberRow.innerHTML = '';
                if (subHeaderRow) subHeaderRow.innerHTML = '';
                if (tableBody) tableBody.innerHTML = '<tr><td colspan="100%" class="p-4 text-center text-gray-500">No data available for the selected criteria.</td></tr>';
                if (tableFoot) tableFoot.innerHTML = '';
                return;
            }

            memberRow.innerHTML = '<th rowspan="2">SL</th><th rowspan="2" style="white-space: normal;">Product</th><th rowspan="2">Rate</th>';
            subHeaderRow.innerHTML = '';

            reportingMembers.forEach(m => {
                memberRow.innerHTML += `<th colspan="3">${m.name}</th>`;
                subHeaderRow.innerHTML += '<th>TGT</th><th>Sales</th><th>Amount</th>';
            });
            memberRow.innerHTML += `<th colspan="3" class="summary-header">Summary</th>`;
            subHeaderRow.innerHTML += '<th class="summary-header">TGT</th><th class="summary-header">Sales</th><th class="summary-header">Amount</th>';

            tableBody.innerHTML = '';
            const productsToList = (selectedProduct && selectedProduct !== 'all') ? state.products.filter(p => p.name === selectedProduct) : [...state.products];
            
            // Sort the list for rendering
            productsToList.sort((a, b) => {
                const indexA = defaultProducts.findIndex(p => p.name === a.name);
                const indexB = defaultProducts.findIndex(p => p.name === b.name);
                if (indexA === -1 && indexB === -1) return a.name.localeCompare(b.name);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });


            productsToList.forEach((product, index) => {
                const productName = product.name;
                if (!productData[productName]) return; // Skip if no data for this product in the filtered set

                const productInfo = productData[productName];
                let rowHtml = `<tr><td>${index + 1}</td><td style="white-space: normal;">${productName}</td><td>${productInfo.rate.toFixed(2)}</td>`;
                let summaryTgt = 0, summarySales = 0, summaryAmount = 0;

                reportingMembers.forEach(member => {
                    const data = productInfo.members[member.name] || { tgt: 0, sales: 0, amount: 0 };
                    rowHtml += `<td>${data.tgt}</td><td>${data.sales}</td><td>${Math.round(data.amount)}</td>`;
                    summaryTgt += data.tgt;
                    summarySales += data.sales;
                    summaryAmount += data.amount;
                });

                rowHtml += `<td class="summary-col">${summaryTgt}</td><td class="summary-col">${summarySales}</td><td class="summary-col">${Math.round(summaryAmount)}</td>`;
                rowHtml += `</tr>`;
                tableBody.innerHTML += rowHtml;
            });

            tableFoot.innerHTML = '';
            let footerHtml = '<tr><td colspan="3"><b>Total</b></td>';
            const memberTotals = {};
            reportingMembers.forEach(m => { memberTotals[m.name] = { tgt: 0, sales: 0, amount: 0 }; });
            let grandTotal = { tgt: 0, sales: 0, amount: 0 };
            
            productsToList.forEach(product => {
                if (!productData[product.name]) return;
                const productInfo = productData[product.name];
                reportingMembers.forEach(member => {
                    const data = productInfo.members[member.name] || { tgt: 0, sales: 0, amount: 0 };
                    memberTotals[member.name].tgt += data.tgt;
                    memberTotals[member.name].sales += data.sales;
                    memberTotals[member.name].amount += data.amount;
                });
            });

            reportingMembers.forEach(member => {
                footerHtml += `<td><b>${memberTotals[member.name].tgt}</b></td><td><b>${memberTotals[member.name].sales}</b></td><td><b>${Math.round(memberTotals[member.name].amount)}</b></td>`;
                grandTotal.tgt += memberTotals[member.name].tgt;
                grandTotal.sales += memberTotals[member.name].sales;
                grandTotal.amount += memberTotals[member.name].amount;
            });

            footerHtml += `<td class="summary-col"><b>${grandTotal.tgt}</b></td><td class="summary-col"><b>${grandTotal.sales}</b></td><td class="summary-col"><b>${Math.round(grandTotal.amount)}</b></td>`;
            footerHtml += '</tr>';
            tableFoot.innerHTML = footerHtml;
        }

        function exportReportToExcel(tableId) {
            const table = document.getElementById(tableId);
            if (!table || table.querySelector('td')?.innerText.includes('No data')) {
                 return showAlert('No data available to export.');
            }
            const wb = XLSX.utils.table_to_book(table, {sheet: "Report"});
            
            let fileName;
            let startDate, endDate;

            switch(tableId) {
                case 'dateRangeReportTable':
                    startDate = document.getElementById('reportStartDate').value;
                    endDate = document.getElementById('reportEndDate').value;
                    fileName = `SalesReport_${startDate}_to_${endDate}.xlsx`;
                    break;
                case 'categoryReportTable':
                    startDate = document.getElementById('categoryReportStartDate').value;
                    endDate = document.getElementById('categoryReportEndDate').value;
                    fileName = `CategoryWiseReport_${startDate}_to_${endDate}.xlsx`;
                    break;
                case 'skuTgtVsSalesReportTable':
                    const tgtDate = document.getElementById('skuTgtDate').value;
                    const salesDate = document.getElementById('skuSalesDate').value;
                    fileName = `TgtVsSales_${tgtDate}_vs_${salesDate}.xlsx`;
                    break;
                 case 'myCategoryReportTable':
                    startDate = document.getElementById('myCategoryReportStartDate').value;
                    endDate = document.getElementById('myCategoryReportEndDate').value;
                    fileName = `MyCategoryReport_${startDate}_to_${endDate}.xlsx`;
                    break;
                default: // 'reportTable'
                    const selectedDate = document.getElementById('reportDate').value;
                    fileName = `SalesReport_${selectedDate}.xlsx`;
                    break;
            }

            XLSX.writeFile(wb, fileName);
        }

        // --- Team Member Functions ---
        async function loginTeamMember() {
            const username = document.getElementById('teamMemberUsername').value.trim();
            const password = document.getElementById('teamMemberPassword').value.trim();
            
            let foundMember = null;
            let teamAdminInfo = null;

            for (const admin of state.teamAdmins) {
                if (admin.teamMembers && typeof admin.teamMembers === 'object') {
                    const memberKey = Object.keys(admin.teamMembers).find(key => 
                        admin.teamMembers[key].username === username && admin.teamMembers[key].password === password
                    );
                    if(memberKey){
                        foundMember = {id: memberKey, ...admin.teamMembers[memberKey]};
                        teamAdminInfo = {id: admin.id, username: admin.username, status: admin.status };
                        break;
                    }
                }
            }

            if (foundMember) {
                 if (foundMember.status === 'deactivated') {
                    return showAlert('Your account has been deactivated. Please contact your team admin.');
                }
                if (teamAdminInfo.status === 'deactivated') {
                    return showAlert('Your team is currently deactivated. Please contact the super admin.');
                }
                const user = {
                    id: foundMember.id,
                    name: foundMember.name,
                    username: foundMember.username,
                    team: teamAdminInfo.username,
                    teamId: teamAdminInfo.id,
                    role: 'teammember'
                };
                localStorage.setItem('loggedInUser', JSON.stringify(user));

                state.loggedInUser = user.id;
                state.loggedInUserName = user.name;
                state.loggedInUserUsername = user.username;
                state.loggedInUserRole = user.role;
                state.loggedInUserTeam = user.team;
                state.loggedInUserTeamId = user.teamId;
                
                await getFullState();
                renderTeamMemberDashboard();
                showPage('teamMemberDashboard');
                playWelcomeVoice('member');
            } else {
                showAlert('Invalid username or password.');
            }
        }
        
        function updateAmountOnRow(productId) {
            const product = state.products.find(p => p.id === productId);
            if (!product) return;

            const rate = product.rate;
            const salesInput = document.getElementById(`sales-${productId}`);
            const amountCell = document.getElementById(`amount-${productId}`);
            
            if (salesInput && amountCell) {
                const sales = parseFloat(salesInput.value) || 0;
                const amount = rate * sales;
                amountCell.innerText = Math.round(amount);
            }
        }

        function addItemsFromProductListToReport(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let itemsToAdd = [];

            const productRows = container.querySelectorAll('tr[data-product-id]');
            
            productRows.forEach(row => {
                 const productId = row.dataset.productId;
                 const product = state.products.find(p => p.id === productId);
                 if(!product) return;

                 const tgtInput = document.getElementById(`tgt-${productId}`);
                 const salesInput = document.getElementById(`sales-${productId}`);
                 
                 const tgt = parseFloat(tgtInput.value) || 0;
                 const sales = parseFloat(salesInput.value) || 0;

                 if (tgt > 0 || sales > 0) {
                     const rate = product.rate;
                     const amount = rate * sales;
                     
                     if (state.currentReportItems.find(item => item.name === product.name)) {
                        showAlert(`Product "${product.name}" is already in the report. Please remove the existing existing one to add again.`);
                        itemsToAdd = []; // stop processing
                        return;
                    }

                    itemsToAdd.push({
                        name: product.name,
                        rate: rate,
                        tgt: tgt,
                        sales: sales,
                        amount: amount
                    });
                 }
            });


            if(itemsToAdd.length > 0) {
                state.currentReportItems.push(...itemsToAdd);
                renderCurrentReportItems();
                // Clear the inputs after adding
                productRows.forEach(row => {
                    const productId = row.dataset.productId;
                    const tgtInput = document.getElementById(`tgt-${productId}`);
                    const salesInput = document.getElementById(`sales-${productId}`);
                    const amountCell = document.getElementById(`amount-${productId}`);
                    if (tgtInput) tgtInput.value = '';
                    if (salesInput) salesInput.value = '';
                    if (amountCell) amountCell.innerText = '0';
                });

                showAlert(`${itemsToAdd.length} item(s) added to the report.`);
            } else {
                showAlert('Please enter TGT or Sales for at least one product.');
            }
        }


        function removeItemFromReport(index) {
            state.currentReportItems.splice(index, 1);
            renderCurrentReportItems();
        }

        function renderCurrentReportItems() {
            const itemsContainer = document.getElementById('currentReportItems');
            itemsContainer.innerHTML = '';
            
            if (!state.currentReportItems || state.currentReportItems.length === 0) {
                 itemsContainer.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">No items added yet.</td></tr>';
                 return;
            }

            state.currentReportItems.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td class="text-right">${item.tgt}</td>
                    <td class="text-right">${item.sales}</td>
                    <td class="text-right">${Math.round(item.amount)}</td>
                    <td class="text-center">
                        <button onclick="removeItemFromReport(${index})" class="btn btn-danger btn-sm">Remove</button>
                    </td>
                `;
                itemsContainer.appendChild(tr);
            });
        }

        async function submitSalesReport() {
            const currentHour = new Date().getHours();
            if (currentHour >= 23) { // 23 is 11 PM in 24-hour format
                return showAlert('You cannot submit reports after 11 PM. Please submit your report on time tomorrow.');
            }

            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);

            if (!state.loggedInUserUsername) return showAlert('Could not verify your user. Please log out and log in again.');

            const hasSubmittedToday = state.salesReports.some(r => 
                r.submittedBy === state.loggedInUserUsername && new Date(r.date) >= todayStart
            );

            if (hasSubmittedToday) {
                return showAlert('You have already submitted your report for today. You can delete the existing one to submit a new one.');
            }

            const grandTotal = state.currentReportItems.reduce((sum, item) => sum + item.amount, 0);

            const reportData = {
                agentName: state.loggedInUserName,
                items: [...state.currentReportItems],
                grandTotal: grandTotal,
            };
            
            const newReport = {
                reportData: reportData,
                submittedBy: state.loggedInUserUsername,
                team: state.loggedInUserTeam,
                date: new Date().toISOString()
            };
            
            await db.ref('salesReports').push(newReport);
            
            state.currentReportItems = [];
            
            playVoice("ধন্যবাদ, আপনি সফলভাবে আজকের রিপোর্ট সাবমিট করেছেন");
            showAlert('Report submitted successfully!');

            // Show popunder ad
            if(state.advertisements.popunder) {
                window.open(state.advertisements.popunder, '_blank');
            }

            await getFullState();
            renderTeamMemberDashboard();
        }

        async function deleteMyReport(reportId) {
            const currentHour = new Date().getHours();
            if (currentHour >= 23) {
                return showAlert('You cannot delete reports after 11 PM.');
            }
             if (confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
                await db.ref(`salesReports/${reportId}`).remove();
                await getFullState();
                renderTeamMemberDashboard();
            }
        }
        
        function renderProductTableForMember(products, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            if (!products || products.length === 0) {
                container.innerHTML = '<p class="p-4 text-center text-gray-500">No products found.</p>';
                return;
            }
            
            let tableHtml = '<table class="w-full grouped-product-table"><thead><tr><th>Product</th><th>TGT</th><th>Sales</th><th class="text-right">Amount</th></tr></thead><tbody>';

            products.forEach(p => {
                tableHtml += `
                    <tr data-product-id="${p.id}">
                        <td>${p.name}</td>
                        <td><input type="number" id="tgt-${p.id}" class="inline-input" placeholder="TGT"></td>
                        <td><input type="number" id="sales-${p.id}" class="inline-input" placeholder="Sales" oninput="updateAmountOnRow('${p.id}')"></td>
                        <td class="text-right" id="amount-${p.id}">0</td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';

            const uniqueId = `product-list-container-${Date.now()}`;
            const wrapperDiv = document.createElement('div');
            wrapperDiv.id = uniqueId;
            wrapperDiv.innerHTML = tableHtml + `<div class="text-center mt-4"><button onclick="addItemsFromProductListToReport('${uniqueId}')" class="neon-glow-btn">Add to Report</button></div>`;
            container.appendChild(wrapperDiv);
        }

        function handleCategorySelect(categoryKey) {
            document.getElementById('memberProductSearch').value = '';
            const container = document.getElementById('memberProductListContainer');
            container.innerHTML = '';

            if (categoryKey) {
                const productMap = new Map(state.products.map(p => [p.name, { rate: p.rate, id: p.id }]));
                
                let filteredProducts = (categoryKey === 'All')
                    ? defaultProducts
                    : defaultProducts.filter(p => p.category === categoryKey);

                let productsWithLatestRates = filteredProducts.map(dp => {
                    const updatedProduct = productMap.get(dp.name);
                    return {
                        ...dp,
                        rate: updatedProduct ? updatedProduct.rate : dp.rate,
                        id: updatedProduct ? updatedProduct.id : dp.id,
                    };
                });
                
                // No need to sort here as defaultProducts is already sorted
                renderProductTableForMember(productsWithLatestRates, 'memberProductListContainer');
            }
        }
        
        function handleProductSearchForMember(searchTerm) {
            document.getElementById('productCategorySelect').value = ''; // Reset category dropdown
            const container = document.getElementById('memberProductListContainer');
            container.innerHTML = '';
            const lowerCaseSearchTerm = searchTerm.toLowerCase();

            if (lowerCaseSearchTerm.length > 1) {
                const productMap = new Map(state.products.map(p => [p.name, { rate: p.rate, id: p.id }]));

                let filteredProducts = defaultProducts
                    .filter(dp => dp.name.toLowerCase().includes(lowerCaseSearchTerm))
                    .map(dp => {
                         const updatedProduct = productMap.get(dp.name);
                         return {
                            ...dp,
                            rate: updatedProduct ? updatedProduct.rate : dp.rate,
                            id: updatedProduct ? updatedProduct.id : dp.id,
                        };
                    });
                
                // No need to sort, as it's filtered from an already sorted list (defaultProducts)
                renderProductTableForMember(filteredProducts, 'memberProductListContainer');
            }
        }

        function renderTeamMemberDashboard() {
            document.getElementById('loggedInTeamMemberName').innerText = state.loggedInUserName;
            
            const noticeContainer = document.getElementById('teamAdminNoticeContainer');
            const teamNotice = state.notices[state.loggedInUserTeamId] || '';
            if (teamNotice) {
                noticeContainer.innerHTML = `
                     <div class="border-b border-gray-300 pb-2 mb-4">
                        <p class="font-semibold flex items-center">
                             Notice: <marquee behavior="scroll" direction="left" class="ml-2 text-red-600">${teamNotice}</marquee>
                        </p>
                    </div>`;
            } else {
                noticeContainer.innerHTML = '';
            }
            
            const categorySelect = document.getElementById('productCategorySelect');
            const uniqueCategories = [...new Set(state.products.map(p => p.category).filter(Boolean))].sort();
            categorySelect.innerHTML = '<option value="">-- Select a Category --</option><option value="All">All</option>';
            uniqueCategories.forEach(cat => {
                categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            
            document.getElementById('memberProductSearch').value = '';
            document.getElementById('memberProductListContainer').innerHTML = '';


            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);
            const hasSubmittedToday = state.salesReports.some(r => 
                r.submittedBy === state.loggedInUserUsername && new Date(r.date) >= todayStart
            );
            document.getElementById('submitReportContainer').style.display = hasSubmittedToday ? 'none' : 'block';

            const mySalesReportsList = document.getElementById('mySalesReportsList');
            mySalesReportsList.innerHTML = '';
            const myReports = state.salesReports.filter(report => report.submittedBy === state.loggedInUserUsername);

            if (myReports.length === 0) {
                 mySalesReportsList.innerHTML = '<p class="text-gray-500">You have not submitted any reports yet.</p>';
            } else {
                [...myReports].reverse().forEach(report => {
                    const div = document.createElement('div');
                    div.className = 'p-3 border rounded';
                    
                    const reportDate = new Date(report.date);
                    const isToday = reportDate.getFullYear() === todayStart.getFullYear() &&
                                  reportDate.getMonth() === todayStart.getMonth() &&
                                  reportDate.getDate() === todayStart.getDate();
                                  
                    const canDelete = isToday && new Date().getHours() < 23;

                    div.innerHTML = `
                        <div class="flex flex-col md:flex-row justify-between items-start mb-2">
                            <div class="mb-2 md:mb-0">
                                <p><b>Agent:</b> ${report.reportData.agentName}</p>
                                <p class="text-sm text-gray-500 mt-1">Submitted on: ${new Date(report.date).toLocaleString()}</p>
                            </div>
                            <div>
                                ${canDelete ? `<button onclick="deleteMyReport('${report.id}')" class="btn btn-danger btn-sm">Delete</button>` : ''}
                            </div>
                        </div>
                        <div class="border rounded-lg overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-2">Product Name</th>
                                        <th class="p-2 text-right">TGT</th>
                                        <th class="p-2 text-right">Sales</th>
                                        <th class="p-2 text-right">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(report.reportData.items || []).map(item => `
                                        <tr>
                                            <td class="p-2">${item.name}</td>
                                            <td class="p-2 text-right">${item.tgt}</td>
                                            <td class="p-2 text-right">${item.sales}</td>
                                            <td class="p-2 text-right">${Math.round(item.amount)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot class="font-bold bg-gray-100">
                                    <tr>
                                        <td colspan="3" class="p-2 text-right">Grand Total:</td>
                                        <td class="p-2 text-right">${Math.round(report.reportData.grandTotal)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
                    mySalesReportsList.appendChild(div);
                });
            }
            state.currentReportItems = [];
            renderCurrentReportItems();
            
            // Show/hide dynamic report view for member
            renderMemberDynamicReports();
        }

        function renderMemberDynamicReports() {
            const adminReportingSettings = state.reportingSettings[state.loggedInUserTeamId] || {};
            const enabledReportFormatId = adminReportingSettings.enabledReportView;

            // Hide all dynamic report formats first
            document.querySelectorAll('#memberDynamicReportView > div').forEach(el => el.style.display = 'none');

            if (enabledReportFormatId) {
                const reportFormatContainer = document.getElementById('member' + enabledReportFormatId.replace(/view/g, ''));
                 if (reportFormatContainer) {
                    document.getElementById('memberDynamicReportView').style.display = 'block';
                    reportFormatContainer.style.display = 'block';
                    
                    const today = new Date().toISOString().split('T')[0];
                    reportFormatContainer.querySelectorAll('input[type="date"]').forEach(input => {
                        if (!input.value) { // Set date only if it's not already set
                            input.value = today;
                        }
                    });

                }
            } else {
                document.getElementById('memberDynamicReportView').style.display = 'none';
            }
        }
        
        function renderAdvertisements(pageId) {
            const adContainer = document.getElementById('adContainer');
            adContainer.innerHTML = '';
            if (pageId === 'superAdminDashboard') {
                return; 
            }

            let adHtml = '';
            if(state.advertisements.banner) {
                adHtml += `<img src="${state.advertisements.banner}" alt="Banner Ad" class="mx-auto my-2" style="max-width: 100%; height: auto;">`;
            }
            if(state.advertisements.nativeBanner) {
                adHtml += `<img src="${state.advertisements.nativeBanner}" alt="Native Banner Ad" class="mx-auto my-2" style="max-width: 100%; height: auto;">`;
            }

            adContainer.innerHTML = adHtml;
        }

        // --- Notification and Voice System ---
        function loadBengaliVoice() {
            if (!synth) return;
             // This function is called once on init and on voiceschanged event
            const allVoices = synth.getVoices();
            if (allVoices.length === 0) {
                // If voices are not loaded yet, the 'voiceschanged' event will trigger this again.
                return;
            }

            bengaliVoice = allVoices.find(v => v.lang === 'bn-BD' && v.name.includes('Female')) ||
                           allVoices.find(v => v.lang === 'bn-BD') ||
                           allVoices.find(v => v.lang.startsWith('bn-')) ||
                           null;

            if (bengaliVoice) {
                console.log("Found Bengali voice:", bengaliVoice.name);
            } else {
                console.warn("No suitable Bengali voice found. Using default.");
            }
        }

        function playVoice(text, onEndCallback) {
            if (!synth) {
                console.error("Speech synthesis not supported.");
                if (onEndCallback) onEndCallback();
                return;
            }

            synth.cancel(); // Stop any currently speaking utterance

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'bn-BD';
            utterance.rate = 0.85; 
            utterance.pitch = 1;
            utterance.volume = 1;

            if (bengaliVoice) {
                utterance.voice = bengaliVoice;
            } else {
                // Attempt to find it again, in case it loaded late.
                loadBengaliVoice();
                if(bengaliVoice) utterance.voice = bengaliVoice;
            }

            utterance.onend = () => {
                if(onEndCallback) onEndCallback();
            };
            
            utterance.onerror = (event) => {
                console.error('SpeechSynthesisUtterance.onerror', event);
                 if (onEndCallback) onEndCallback();
            };

            setTimeout(() => synth.speak(utterance), 100);
        }

        async function playWelcomeVoice(role) {
             if (role === 'teammember') {
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                const hasSubmittedToday = state.salesReports.some(r => 
                    r.submittedBy === state.loggedInUserUsername && new Date(r.date) >= todayStart
                );

                if (!hasSubmittedToday) {
                    setTimeout(() => {
                        playVoice("আপনি আজকের রিপোর্ট এখনো সাবমিট করেননি, তাই আপনাকে স্মরণ করানো হলো");
                    }, 5000); 
                }
            }
        }
        
        function unlockAudio() {
            if (!synth) return;
            // A silent utterance on user interaction is the most reliable way to unlock the audio context.
            if (synth.paused) {
                synth.resume();
            }
            const utterance = new SpeechSynthesisUtterance('');
            utterance.volume = 0;
            synth.speak(utterance);
        }

        function startMemberAlarmSystem() {
            if (alarmIntervalId) clearInterval(alarmIntervalId); 

            alarmIntervalId = setInterval(async () => {
                const settings = state.notificationSettings[state.loggedInUserTeamId];
                if (!settings || !settings.enabled) return;

                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                
                const salesReportsSnapshot = await db.ref('salesReports').once('value');
                const liveSalesReportsData = salesReportsSnapshot.val() || {};
                const liveSalesReports = Object.values(liveSalesReportsData);

                const hasSubmittedToday = liveSalesReports.some(r => 
                    r.submittedBy === state.loggedInUserUsername && new Date(r.date) >= todayStart
                );

                if (hasSubmittedToday) {
                    clearInterval(alarmIntervalId);
                    alarmIntervalId = null;
                    return;
                }
                
                const now = new Date();
                const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                if (settings.reminderTimes && settings.reminderTimes.includes(currentTime)) {
                    playVoice(settings.reminderMessage);
                }
            }, 60000); // Check every minute
        }

        async function setupPushNotifications(role, teamId, userId) {
            if (!('Notification' in window) || !('serviceWorker' in navigator) || !firebase.messaging.isSupported()) {
                console.log("This browser does not support push notifications.");
                return;
            }
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    const fcmToken = await messaging.getToken({ vapidKey: 'BC0oXNNGZG8Qq43Wuo6YRidw6ZF7vNQMOXhQwTPun7rVRqSu9Ulbh0w84CH3_01XcXih4LKstYWsUF0laM13710' });
                    if (fcmToken) {
                        if (role === 'teammember') {
                            await db.ref(`teamAdmins/${teamId}/teamMembers/${userId}/fcmToken`).set(fcmToken);
                        } else if (role === 'teamadmin') {
                            await db.ref(`teamAdmins/${userId}/fcmToken`).set(fcmToken);
                        }
                    }
                }
            } catch(err) {
                console.error('An error occurred while setting up push notifications.', err);
            }
        }
        
        function addReminderTimeInput(time = '') {
            const container = document.getElementById('reminderTimesContainer');
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            div.innerHTML = `
                <input type="time" class="input-field !mb-0 reminder-time-input" value="${time}">
                <button onclick="this.parentElement.remove()" class="btn btn-danger btn-sm">X</button>
            `;
            container.appendChild(div);
        }

        function renderNotificationSettings() {
            const adminId = state.loggedInUser;
            const settings = state.notificationSettings[adminId] || {};
            
            document.getElementById('enableNotifications').checked = settings.enabled || false;
            document.getElementById('reminderMessage').value = settings.reminderMessage || "আপনি এখনো আগামীকালের টার্গেট ও আজকের সেলস রিপোর্ট জমা দেন নি, দয়া করে রাত 11 তার মধ্যে রিপোর্ট জমা দিন নয়তো নিজের জবাব প্রস্তুত রাখুন সকাল বেলার মিটিংয়ে দেয়ার জন্য";
            
            const timesContainer = document.getElementById('reminderTimesContainer');
            timesContainer.innerHTML = '';
            const reminderTimes = settings.reminderTimes || ["21:30", "22:20"];
            reminderTimes.forEach(time => addReminderTimeInput(time));
            if(reminderTimes.length === 0){
                 addReminderTimeInput();
            }

            document.getElementById('thankYouMessage').value = settings.thankYouMessage || "আপনাকে ধন্যবাদ রিপোর্ট জমাদানের জন্য";
        }

        async function saveNotificationSettings() {
            const adminId = state.loggedInUser;
            const reminderTimes = Array.from(document.querySelectorAll('.reminder-time-input'))
                                     .map(input => input.value)
                                     .filter(value => value !== '');

            const settings = {
                enabled: document.getElementById('enableNotifications').checked,
                reminderMessage: document.getElementById('reminderMessage').value,
                reminderTimes: reminderTimes,
                thankYouMessage: document.getElementById('thankYouMessage').value,
            };

            await db.ref(`notificationSettings/${adminId}`).set(settings);
            state.notificationSettings[adminId] = settings;
            showAlert('Notification settings saved successfully!');
        }

        function renderLogoutSettings() {
            const adminId = state.loggedInUser;
            const settings = state.logoutSettings[adminId] || {};
            document.getElementById('logoutClickCount').value = settings.clickCount || 10;
        }

        async function saveLogoutSettings() {
            const adminId = state.loggedInUser;
            const clickCount = parseInt(document.getElementById('logoutClickCount').value, 10);
            
            if(isNaN(clickCount) || clickCount < 1) {
                return showAlert('Please enter a valid number greater than 0.');
            }

            const settings = { clickCount };
            await db.ref(`logoutSettings/${adminId}`).set(settings);
            state.logoutSettings[adminId] = settings;
            showAlert('Logout settings saved successfully!');
        }
        
        function renderVoiceSettings() {
            const adminId = state.loggedInUser;
            const settings = state.voiceSettings[adminId] || {};
            document.getElementById('voiceRepeatCount').value = settings.repeatCount || 2;
        }

        async function saveVoiceSettings() {
            const adminId = state.loggedInUser;
            const repeatCount = parseInt(document.getElementById('voiceRepeatCount').value, 10);
            
            if(isNaN(repeatCount) || repeatCount < 1) {
                return showAlert('Please enter a valid number greater than 0.');
            }

            const settings = { repeatCount };
            await db.ref(`voiceSettings/${adminId}`).set(settings);
            state.voiceSettings[adminId] = settings;
            showAlert('Voice settings saved successfully!');
        }

        // --- Category Management ---
        function renderCategoryManagement() {
            const deleteSelect = document.getElementById('deleteCategorySelect');
            
            const uniqueCategories = [...new Set(state.products.map(p => p.category).filter(Boolean))].sort();

            deleteSelect.innerHTML = '<option value="">-- Select Category to Delete --</option>';

            uniqueCategories.forEach(cat => {
                deleteSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            document.getElementById('newStandaloneCategoryName').value = '';
        }

        async function addStandaloneCategory() {
            const categoryName = document.getElementById('newStandaloneCategoryName').value.trim();
            if (!categoryName) {
                return showAlert('Category name cannot be empty.');
            }
            const uniqueCategories = [...new Set(state.products.map(p => p.category).filter(Boolean))];
             if (uniqueCategories.some(c => c.toLowerCase() === categoryName.toLowerCase())) {
                return showAlert('This category already exists.');
            }
            
            // To "create" a category, we add a placeholder product. This is a workaround.
            const placeholderProduct = {
                name: `_placeholder_for_${categoryName}`,
                rate: 0,
                category: categoryName
            };
            await db.ref('products').push(placeholderProduct);

            await getFullState();
            renderCategoryManagement();
            showAlert(`Category "${categoryName}" created successfully.`);
        }

        async function deleteStandaloneCategory() {
            const categoryToDelete = document.getElementById('deleteCategorySelect').value;
            if (!categoryToDelete) {
                return showAlert('Please select a category to delete.');
            }
            
            const productsInCategory = state.products.filter(p => p.category === categoryToDelete);

            if (productsInCategory.length > 1 || (productsInCategory.length === 1 && !productsInCategory[0].name.startsWith('_placeholder_for_'))) {
                 if (!confirm(`This category contains products. Deleting it will remove the category from all associated products. Are you sure?`)) {
                    return;
                }
            } else {
                 if (!confirm(`Are you sure you want to delete the category "${categoryToDelete}"?`)) {
                    return;
                }
            }
            
            const updates = {};
            productsInCategory.forEach(p => {
                if (p.name.startsWith('_placeholder_for_')) {
                    updates[`/products/${p.id}`] = null; // Delete placeholder
                } else {
                    updates[`/products/${p.id}/category`] = null; // Unset category for other products
                }
            });

            if(Object.keys(updates).length > 0) {
                await db.ref().update(updates);
            }
            
            await getFullState();
            renderCategoryManagement();
            showAlert(`Category "${categoryToDelete}" has been deleted.`);
        }
        
         // --- Category Wise Report ---
        function renderCategoryWiseReport() {
            const startDateStr = document.getElementById('categoryReportStartDate').value;
            const endDateStr = document.getElementById('categoryReportEndDate').value;
            const selectedMemberUsername = document.getElementById('categoryReportMemberSelect').value;

            if (!startDateStr || !endDateStr) {
                return;
            }

            const startDate = new Date(startDateStr);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(endDateStr);
            endDate.setHours(23, 59, 59, 999);

            let relevantReports = state.salesReports.filter(r => {
                const reportDate = new Date(r.date);
                return r.team === state.loggedInUserName &&
                       reportDate.getTime() >= startDate.getTime() && 
                       reportDate.getTime() <= endDate.getTime();
            });

            if (selectedMemberUsername !== 'all') {
                relevantReports = relevantReports.filter(r => r.submittedBy === selectedMemberUsername);
            }
            
            const categoryData = {};
            const allCategories = [...new Set(state.products.map(p => p.category).filter(Boolean))];
            allCategories.forEach(cat => {
                categoryData[cat] = { tgtAmount: 0, salesAmount: 0 };
            });

            relevantReports.forEach(report => {
                if (report.reportData && report.reportData.items) {
                    report.reportData.items.forEach(item => {
                        const productInfo = state.products.find(p => p.name === item.name);
                        if (productInfo && productInfo.category && categoryData[productInfo.category]) {
                            const rate = productInfo.rate;
                            categoryData[productInfo.category].tgtAmount += item.tgt * rate;
                            categoryData[productInfo.category].salesAmount += item.sales * rate;
                        }
                    });
                }
            });

            // Render Chart
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const labels = Object.keys(categoryData);
            const tgtData = labels.map(l => categoryData[l].tgtAmount);
            const salesData = labels.map(l => categoryData[l].salesAmount);

            if (categoryChartInstance) {
                categoryChartInstance.destroy();
            }

            categoryChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'TGT Amount',
                            data: tgtData,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)', // Blue
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Sales Amount',
                            data: salesData,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)', // Green
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Render Table
            const tableContainer = document.getElementById('categoryReportTableContainer');
            let tableHtml = `
                <table class="w-full text-left text-sm mt-4" id="categoryReportTable">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="p-2 font-semibold">Category</th>
                            <th class="p-2 font-semibold text-right">TGT Amount</th>
                            <th class="p-2 font-semibold text-right">Sales Amount</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let totalTgt = 0;
            let totalSales = 0;

            for (const categoryName in categoryData) {
                const data = categoryData[categoryName];
                totalTgt += data.tgtAmount;
                totalSales += data.salesAmount;
                tableHtml += `
                    <tr class="border-b">
                        <td class="p-2">${categoryName}</td>
                        <td class="p-2 text-right">${Math.round(data.tgtAmount).toLocaleString()}</td>
                        <td class="p-2 text-right">${Math.round(data.salesAmount).toLocaleString()}</td>
                    </tr>
                `;
            }
            
            tableHtml += `
                    </tbody>
                    <tfoot class="font-bold bg-gray-100">
                        <tr>
                            <td class="p-2">Grand Total</td>
                            <td class="p-2 text-right">${Math.round(totalTgt).toLocaleString()}</td>
                            <td class="p-2 text-right">${Math.round(totalSales).toLocaleString()}</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            tableContainer.innerHTML = tableHtml;
        }
        
         function renderMyCategoryWiseReport() {
            const startDateStr = document.getElementById('myCategoryReportStartDate').value;
            const endDateStr = document.getElementById('myCategoryReportEndDate').value;
            const myUsername = state.loggedInUserUsername;

            if (!startDateStr || !endDateStr || !myUsername) {
                return;
            }

            const startDate = new Date(startDateStr);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(endDateStr);
            endDate.setHours(23, 59, 59, 999);

            const myReports = state.salesReports.filter(r => {
                return r.submittedBy === myUsername && new Date(r.date).getTime() >= startDate.getTime() && new Date(r.date).getTime() <= endDate.getTime();
            });

            const categoryData = {};
            const allCategories = [...new Set(state.products.map(p => p.category).filter(Boolean))];
            allCategories.forEach(cat => {
                categoryData[cat] = { tgtAmount: 0, salesAmount: 0 };
            });

            myReports.forEach(report => {
                report.reportData.items.forEach(item => {
                    const productInfo = state.products.find(p => p.name === item.name);
                    if (productInfo && productInfo.category && categoryData[productInfo.category]) {
                        const rate = productInfo.rate;
                        categoryData[productInfo.category].tgtAmount += item.tgt * rate;
                        categoryData[productInfo.category].salesAmount += item.sales * rate;
                    }
                });
            });

            // Render Table
            const tableContainer = document.getElementById('myCategoryReportTableContainer');
            let tableHtml = `
                <table class="w-full text-left text-sm mt-4" id="myCategoryReportTable">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="p-2 font-semibold">Category</th>
                            <th class="p-2 font-semibold text-right">TGT Amount</th>
                            <th class="p-2 font-semibold text-right">Sales Amount</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let totalTgt = 0;
            let totalSales = 0;

            for (const categoryName in categoryData) {
                const data = categoryData[categoryName];
                 if(data.tgtAmount > 0 || data.salesAmount > 0) {
                    totalTgt += data.tgtAmount;
                    totalSales += data.salesAmount;
                    tableHtml += `
                        <tr class="border-b">
                            <td class="p-2">${categoryName}</td>
                            <td class="p-2 text-right">${Math.round(data.tgtAmount).toLocaleString()}</td>
                            <td class="p-2 text-right">${Math.round(data.salesAmount).toLocaleString()}</td>
                        </tr>
                    `;
                }
            }
            
            tableHtml += `
                    </tbody>
                    <tfoot class="font-bold bg-gray-100">
                        <tr>
                            <td class="p-2">Grand Total</td>
                            <td class="p-2 text-right">${Math.round(totalTgt).toLocaleString()}</td>
                            <td class="p-2 text-right">${Math.round(totalSales).toLocaleString()}</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            tableContainer.innerHTML = tableHtml;
        }

        // --- Voice Assistant Functions ---
        function setupVoiceAssistant() {
            const micBtn = document.getElementById('mic-btn');
            const assistantStatus = document.getElementById('assistant-status');
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                micBtn.style.display = 'none';
                console.error("Speech Recognition API not supported in this browser.");
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'bn-BD';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isListening = true;
                micBtn.classList.add('listening');
                assistantStatus.textContent = "শুনছি...";
                assistantStatus.style.display = 'block';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                assistantStatus.textContent = `আপনি বলেছেন: "${transcript}"`;
                processVoiceCommand(transcript);
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error", event.error);
                let errorMessage = "কিছু একটা সমস্যা হয়েছে।";
                if (event.error === 'no-speech') {
                    errorMessage = "আমি আপনার কথা শুনতে পাইনি।";
                } else if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                    errorMessage = "মাইক্রোফোন ব্যবহারের অনুমতি দিন।";
                }
                assistantStatus.textContent = errorMessage;
                 setTimeout(() => assistantStatus.style.display = 'none', 3000);
            };

            recognition.onend = () => {
                isListening = false;
                micBtn.classList.remove('listening');
                 if (!countdownInterval && !synth.speaking) {
                    setTimeout(() => {
                        assistantStatus.style.display = 'none';
                    }, 3000);
                }
            };

            micBtn.addEventListener('click', () => {
                unlockAudio(); // Important: unlock audio context on user gesture
                
                if (isListening) {
                    recognition.stop();
                } else {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error("Error starting recognition:", e);
                        assistantStatus.textContent = "শুরু করতে সমস্যা হচ্ছে।";
                        setTimeout(() => assistantStatus.style.display = 'none', 3000);
                    }
                }
            });
        }
        
        async function processVoiceCommand(command) {
            const assistantStatus = document.getElementById('assistant-status');
            assistantStatus.textContent = "উত্তর প্রস্তুত করছি...";

            const functionUrl = 'https://us-central1-ekta-local-saver.cloudfunctions.net/askAI';
            
            try {
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: command, adminId: state.loggedInUser })
                });

                if (!response.ok) {
                    throw new Error(`Cloud Function Error: ${response.statusText}`);
                }

                const data = await response.json();
                const aiResponse = data.answer || "দুঃখিত, আমি কোনো উত্তর খুঁজে পাইনি।";
                
                playVoice(aiResponse, () => {
                    assistantStatus.style.display = 'none';
                });

            } catch (error) {
                console.error("Error calling Cloud Function:", error);
                const errorMessage = "দুঃখিত, এই মুহূর্তে আমি আপনার প্রশ্নের উত্তর দিতে পারছি না।";
                
                assistantStatus.textContent = errorMessage;
                playVoice(errorMessage, () => {
                    assistantStatus.style.display = 'none';
                });
            }
        }
        
        // --- Sidebar and New UI Functions ---
        async function getSidebarMenuConfig() {
            const adminId = state.loggedInUser;
            const adminMenuConfig = state.sidebarMenuConfig[adminId];

            const staticBaseMenu = [
                { id: 'dashboard_default', name: 'Dashboard Home', icon: '🏠', children: [] },
                { id: 'team_report', name: 'Daily Team Report', icon: '📊', children: [] },
                { id: 'date_range_report', name: 'Date Range Report', icon: '📅', children: [] },
                { id: 'sku_tgt_vs_sales_report', name: 'SKU TGT vs Sales Report', icon: '📈', children: [] },
                 { id: 'reporting_formats', name: 'Reporting Formats', icon: '📄', children: [
                     { id: 'report_format_1', name: 'Report Format 1', children: [] },
                 ]},
                { id: 'create_team_member', name: 'Create Team Member', icon: '➕', children: [] },
                { id: 'add_or_edit_menu', name: 'Add or Edit Menu', icon: '✏️', children: [] },
                { id: 'all_sections', name: 'All Section Management', icon: '⚙️', children: [
                    { id: 'manage_team_members', name: 'Manage Team Members', children: [] },
                    { id: 'notice_for_members', name: 'Notice for Members', children: [] },
                    { id: 'add_new_product', name: 'Add New Product', children: [] },
                    { id: 'manage_products', name: 'Manage Products', children: [] },
                    { id: 'manage_categories', name: 'Manage Categories', children: [] },
                    { id: 'notification_system', name: 'Notification System', children: [] },
                    { id: 'logout_settings', name: 'Logout Settings', children: [] },
                    { id: 'voice_settings', name: 'Voice Settings', children: [] },
                ]}
            ];

            if (!adminMenuConfig) {
                state.sidebarMenuConfig[adminId] = staticBaseMenu;
                 await saveSidebarMenuConfig();
            } else {
                 // You might want to merge or just use the DB version. For now, we'll prefer the DB version if it exists.
                 // This ensures user customizations are not lost.
                 state.sidebarMenuConfig[adminId] = adminMenuConfig;
            }
        }

        async function saveSidebarMenuConfig() {
            const adminId = state.loggedInUser;
            if (adminId && state.sidebarMenuConfig[adminId]) {
                 await db.ref(`sidebarMenuConfig/${adminId}`).set(state.sidebarMenuConfig[adminId]);
            }
        }
        
        function renderSidebarMenu(menuConfig) {
            const nav = document.getElementById('sidebar-nav');
            nav.innerHTML = '';
            if (!menuConfig) return;

            const createMenuItemHTML = (item) => {
                const hasChildren = item.children && item.children.length > 0;
                const isSubItem = item.id.includes('report_format'); // Simple check if it's a sub-item
                const itemClass = isSubItem ? 'sidebar-submenu-item' : 'sidebar-menu-item';
                
                return `
                    <div class="sidebar-menu-container" data-id="${item.id}">
                        <div class="${itemClass}" onclick="${!hasChildren ? `switchAdminView('view_${item.id}')` : `toggleSubmenu(this)`}" id="menu_item_${item.id}">
                            <span class="flex-grow">${item.icon || ''} ${item.name}</span>
                            ${hasChildren ? '<span class="transform transition-transform duration-200">&#9656;</span>' : ''}
                        </div>
                        ${hasChildren ? `
                            <div class="sidebar-submenu" id="submenu_${item.id}">
                                ${item.children.map(createMenuItemHTML).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            };

            nav.innerHTML = menuConfig.map(createMenuItemHTML).join('');
        }

        function toggleSubmenu(element) {
            const parentContainer = element.closest('.sidebar-menu-container');
            const submenu = parentContainer.querySelector('.sidebar-submenu');
            if (submenu) {
                submenu.classList.toggle('show');
                element.querySelector('span.transform').classList.toggle('rotate-90');
            }
        }
        
        async function setupAdminSidebar() {
            await getSidebarMenuConfig();
            renderSidebarMenu(state.sidebarMenuConfig[state.loggedInUser]);
        }
        
        function switchAdminView(viewId) {
            document.querySelectorAll('.admin-content-view').forEach(v => v.classList.remove('active'));
            const view = document.getElementById(viewId);
            if(view) {
                view.classList.add('active');
                 if (viewId === 'view_add_or_edit_menu') {
                    renderMenuEditor();
                }
            } else {
                document.getElementById('view_dashboard_default').classList.add('active');
                console.warn(`View with id "${viewId}" not found. Showing default.`);
            }

            document.querySelectorAll('#sidebar-nav .sidebar-menu-item, #sidebar-nav .sidebar-submenu-item').forEach(item => item.classList.remove('active'));
            
            const menuItemId = `menu_item_${viewId.replace('view_', '')}`;
            const activeItem = document.getElementById(menuItemId);
            if(activeItem) {
                activeItem.classList.add('active');
                
                let parent = activeItem.closest('.sidebar-submenu');
                while(parent) {
                    if (!parent.classList.contains('show')) {
                        parent.classList.add('show');
                         const parentMenu = parent.closest('.sidebar-menu-container').querySelector('.sidebar-menu-item');
                        if(parentMenu) {
                           const arrow = parentMenu.querySelector('span.transform');
                           if (arrow && !arrow.classList.contains('rotate-90')) {
                               arrow.classList.add('rotate-90');
                           }
                        }
                    }
                    // Mark parent menu item as active for visual indication
                    const parentMenuItem = parent.closest('.sidebar-menu-container').querySelector('.sidebar-menu-item');
                     if(parentMenuItem) parentMenuItem.classList.add('active');

                    parent = parent.parentElement.closest('.sidebar-submenu');
                }
            }

            if (window.innerWidth < 768) {
                toggleSidebar(false); // Hide sidebar on mobile after selection
            }
        }
        
        function toggleSidebar(forceShow) {
            const sidebar = document.getElementById('admin-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const shouldShow = forceShow !== undefined ? forceShow : !sidebar.classList.contains('show');
            
            if (shouldShow) {
                sidebar.classList.add('show');
                overlay.classList.add('show');
            } else {
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
            }
        }
        
        function renderSkuReportSettings() {
            const adminId = state.loggedInUser;
            const settings = state.reportingSettings[adminId] || {};
            const viewId = 'sku_tgt_vs_sales_report';
            const isEnabled = settings.enabledReportView === viewId;
            
            const toggleContainer = document.getElementById('skuReportMemberToggle');
            if(toggleContainer){
                toggleContainer.innerHTML = `
                    <label for="enableSkuReportForMembers" class="font-semibold text-gray-700">Enable this Report for Team Members</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="enableSkuReportForMembers" class="sr-only peer" ${isEnabled ? 'checked' : ''} onchange="toggleMemberReportFormat('${viewId}', this.checked)">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                `;
            }
        }

        function renderReportFormatSettings() {
            const adminId = state.loggedInUser;
            const settings = state.reportingSettings[adminId] || {};
            const viewId = 'report_format_1';
            const isEnabled = settings.enabledReportView === viewId;

            const checkbox = document.getElementById('enableReportFormat1');
            if (checkbox) {
                checkbox.checked = isEnabled;
            }
        }


        async function toggleMemberReportFormat(viewId, isEnabled) {
             const adminId = state.loggedInUser;
             let currentSettings = state.reportingSettings[adminId] || {};
             
             let newEnabledViewId = isEnabled ? viewId.replace('view_','') : null;
             
             const newSettings = { ...currentSettings, enabledReportView: newEnabledViewId };
             
             await db.ref(`reportingSettings/${adminId}`).set(newSettings);
             state.reportingSettings[adminId] = newSettings;
             showAlert(`Report format settings for team members has been updated.`);
             renderSkuReportSettings();
             renderReportFormatSettings();
        }

        // --- New TGT vs Sales Report ---
        function renderSkuTgtVsSalesReport() {
            const tgtDateStr = document.getElementById('skuTgtDate').value;
            const salesDateStr = document.getElementById('skuSalesDate').value;
            const memberUsername = document.getElementById('skuMemberSelect').value;
            const category = document.getElementById('skuCategorySelect').value;
            const productName = document.getElementById('skuProductSelect').value;

            if (!tgtDateStr || !salesDateStr) {
                return showAlert('Please select both a Target Date and a Sales Date.');
            }

            const getStartOfDay = (dateStr) => {
                const date = new Date(dateStr);
                date.setHours(0, 0, 0, 0);
                return date;
            };
            const getEndOfDay = (dateStr) => {
                const date = new Date(dateStr);
                date.setHours(23, 59, 59, 999);
                return date;
            };

            const tgtDateStart = getStartOfDay(tgtDateStr);
            const tgtDateEnd = getEndOfDay(tgtDateStr);
            const salesDateStart = getStartOfDay(salesDateStr);
            const salesDateEnd = getEndOfDay(salesDateStr);

            const teamUsername = state.loggedInUserName;
            
            let filteredProducts = [...state.products];
            if (category !== 'all') {
                filteredProducts = filteredProducts.filter(p => p.category === category);
            }
            if (productName !== 'all') {
                filteredProducts = filteredProducts.filter(p => p.name === productName);
            }

            const admin = state.teamAdmins.find(a => a.id === state.loggedInUser);
            if (!admin) return;
            let members = admin.teamMembers ? Object.values(admin.teamMembers).filter(m => m.status === 'active') : [];
            if(memberUsername !== 'all') {
                members = members.filter(m => m.username === memberUsername);
            }
            const memberUsernames = members.map(m => m.username);
            
            // 1. Get all relevant reports
            const reports = state.salesReports.filter(r => 
                r.team === teamUsername &&
                memberUsernames.includes(r.submittedBy)
            );

            // 2. Process reports to get TGT and Sales data
            const reportData = {}; // { productName: { tgt: X, sales: Y, rate: Z }}
            
            filteredProducts.forEach(p => {
                reportData[p.name] = {
                    tgt: 0,
                    sales: 0,
                    rate: p.rate
                };
            });

            reports.forEach(r => {
                const reportTime = new Date(r.date).getTime();
                const isTgtReport = reportTime >= tgtDateStart.getTime() && reportTime <= tgtDateEnd.getTime();
                const isSalesReport = reportTime >= salesDateStart.getTime() && reportTime <= salesDateEnd.getTime();

                if (isTgtReport || isSalesReport) {
                    if (r.reportData && r.reportData.items) {
                        r.reportData.items.forEach(item => {
                            if (reportData[item.name]) {
                                if (isTgtReport) {
                                    reportData[item.name].tgt += item.tgt;
                                }
                                if (isSalesReport) {
                                    reportData[item.name].sales += item.sales;
                                }
                            }
                        });
                    }
                }
            });

            // 3. Render the table
            const tableHead = document.querySelector('#skuTgtVsSalesReportTable thead');
            const tableBody = document.getElementById('skuTgtVsSalesReportBody');
            const tableFoot = document.getElementById('skuTgtVsSalesReportFoot');
            tableBody.innerHTML = '';
            tableFoot.innerHTML = '';

            tableHead.innerHTML = `
                <tr>
                    <th rowspan="2">SL</th>
                    <th rowspan="2">Product Name</th>
                    <th rowspan="2">Rate</th>
                    <th colspan="2">Quantity</th>
                    <th colspan="2">Amount</th>
                    <th colspan="2">Difference</th>
                </tr>
                <tr>
                    <th>TGT</th>
                    <th>Sales</th>
                    <th>TGT Amt</th>
                    <th>Sales Amt</th>
                    <th>Diff Qty</th>
                    <th>Diff Amt</th>
                </tr>
            `;

            let totalTgtQty = 0, totalSalesQty = 0, totalTgtAmt = 0, totalSalesAmt = 0, totalDiffQty = 0, totalDiffAmt = 0;
            let sl = 1;

            filteredProducts.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                const data = reportData[p.name];
                if (data && (data.tgt > 0 || data.sales > 0)) {
                    const tgtAmt = data.tgt * data.rate;
                    const salesAmt = data.sales * data.rate;
                    const diffQty = data.sales - data.tgt;
                    const diffAmt = salesAmt - tgtAmt;

                    totalTgtQty += data.tgt;
                    totalSalesQty += data.sales;
                    totalTgtAmt += tgtAmt;
                    totalSalesAmt += salesAmt;
                    totalDiffQty += diffQty;
                    totalDiffAmt += diffAmt;

                    const diffQtyClass = diffQty < 0 ? 'text-red-500' : 'text-green-500 font-bold';
                    const diffAmtClass = diffAmt < 0 ? 'text-red-500' : 'text-green-500 font-bold';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${sl++}</td>
                        <td style="text-align: left; padding-left: 5px; white-space: normal;">${p.name}</td>
                        <td>${data.rate.toFixed(2)}</td>
                        <td>${data.tgt}</td>
                        <td>${data.sales}</td>
                        <td>${Math.round(tgtAmt)}</td>
                        <td>${Math.round(salesAmt)}</td>
                        <td class="${diffQtyClass}">${diffQty}</td>
                        <td class="${diffAmtClass}">${Math.round(diffAmt)}</td>
                    `;
                    tableBody.appendChild(row);
                }
            });
            
            if (sl === 1) {
                 tableBody.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-gray-500">No data available for the selected criteria.</td></tr>';
            } else {
                 const diffQtyClass = totalDiffQty < 0 ? 'text-red-500' : 'text-green-500';
                 const diffAmtClass = totalDiffAmt < 0 ? 'text-red-500' : 'text-green-500';

                 tableFoot.innerHTML = `
                    <tr>
                        <td colspan="3"><b>Grand Total</b></td>
                        <td><b>${totalTgtQty}</b></td>
                        <td><b>${totalSalesQty}</b></td>
                        <td><b>${Math.round(totalTgtAmt)}</b></td>
                        <td><b>${Math.round(totalSalesAmt)}</b></td>
                        <td class="font-bold ${diffQtyClass}"><b>${totalDiffQty}</b></td>
                        <td class="font-bold ${diffAmtClass}"><b>${Math.round(totalDiffAmt)}</b></td>
                    </tr>
                 `;
            }
        }
        
        // --- Menu Editor Functions ---
        function renderMenuEditor() {
            const container = document.getElementById('menu-editor-list');
            container.innerHTML = '';
            const adminId = state.loggedInUser;
            const menuConfig = state.sidebarMenuConfig[adminId] || [];

            const createItemHTML = (item, parentArray, index) => {
                const hasChildren = item.children && item.children.length > 0;
                let moveUpBtn = index > 0 ? `<button class="btn btn-secondary btn-sm" onclick="moveMenuItem('${item.id}', 'up')">⬆️</button>` : '';
                let moveDownBtn = index < parentArray.length - 1 ? `<button class="btn btn-secondary btn-sm" onclick="moveMenuItem('${item.id}', 'down')">⬇️</button>` : '';

                return `
                    <div class="menu-editor-item" data-id="${item.id}">
                        <div class="item-content">
                            <span class="item-name">${item.name}</span>
                            <div class="item-controls">
                                ${moveUpBtn}
                                ${moveDownBtn}
                                <button class="btn btn-secondary btn-sm" onclick="renameMenuItem('${item.id}')">Edit</button>
                                <button class="btn btn-secondary btn-sm" onclick="changeMenuParent('${item.id}')">Parent</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteMenuItem('${item.id}')">Delete</button>
                            </div>
                        </div>
                        ${hasChildren ? `<div class="sub-items">${item.children.map((child, childIndex) => createItemHTML(child, item.children, childIndex)).join('')}</div>` : ''}
                    </div>
                `;
            };

            container.innerHTML = menuConfig.map((item, index) => createItemHTML(item, menuConfig, index)).join('');
        }

        async function addNewMenuItemToEditor() {
            const nameInput = document.getElementById('newMenuItemName');
            const name = nameInput.value.trim();
            if (!name) return showAlert('Menu name cannot be empty.');

            const id = name.toLowerCase().replace(/\s+/g, '_') + '_' + Date.now();
            const newItem = { id, name, icon: '📄', children: [] };
            
            const adminId = state.loggedInUser;
            state.sidebarMenuConfig[adminId].push(newItem);

            await saveSidebarMenuConfig();
            renderMenuEditor();
            setupAdminSidebar(); // Refresh sidebar view
            nameInput.value = '';
        }

        function findItem(itemId, arr) {
            for (let i = 0; i < arr.length; i++) {
                if (arr[i].id === itemId) return { item: arr[i], parent: arr, index: i };
                if (arr[i].children) {
                    const found = findItem(itemId, arr[i].children);
                    if (found) return found;
                }
            }
            return null;
        }

        async function renameMenuItem(itemId) {
            const { item } = findItem(itemId, state.sidebarMenuConfig[state.loggedInUser]);
            if (!item) return;

            const newName = prompt('Enter new name for the menu item:', item.name);
            if (newName && newName.trim() !== '') {
                item.name = newName.trim();
                await saveSidebarMenuConfig();
                renderMenuEditor();
                setupAdminSidebar();
            }
        }

        async function deleteMenuItem(itemId) {
            if (!confirm('Are you sure you want to delete this menu item and all its sub-items?')) return;
            
            const { parent, index } = findItem(itemId, state.sidebarMenuConfig[state.loggedInUser]);
            if(parent) {
                parent.splice(index, 1);
                await saveSidebarMenuConfig();
                renderMenuEditor();
                setupAdminSidebar();
            }
        }
        
        async function moveMenuItem(itemId, direction) {
            const { parent, index } = findItem(itemId, state.sidebarMenuConfig[state.loggedInUser]);
            if (!parent) return;

            if (direction === 'up' && index > 0) {
                [parent[index], parent[index - 1]] = [parent[index - 1], parent[index]];
            } else if (direction === 'down' && index < parent.length - 1) {
                [parent[index], parent[index + 1]] = [parent[index + 1], parent[index]];
            }

            await saveSidebarMenuConfig();
            renderMenuEditor();
            setupAdminSidebar();
        }

        async function changeMenuParent(itemId) {
            const adminId = state.loggedInUser;
            const menuConfig = state.sidebarMenuConfig[adminId];
            
            const { item, parent, index } = findItem(itemId, menuConfig);
            if (!item) return;

            let potentialParents = [{ id: 'root', name: 'Make Main Menu (No Parent)' }];
            const gatherParents = (currentItems, prefix = '') => {
                currentItems.forEach(i => {
                    // An item cannot be its own parent or a child of its own descendants
                    if (i.id !== itemId && !findItem(itemId, i.children || [])) {
                        potentialParents.push({ id: i.id, name: prefix + i.name });
                        if (i.children) {
                            gatherParents(i.children, prefix + '-- ');
                        }
                    }
                });
            };
            gatherParents(menuConfig);
            
            const promptMessage = 'Select a new parent for "' + item.name + '":\n' + potentialParents.map((p, i) => `${i}: ${p.name}`).join('\n');
            const choiceIndex = parseInt(prompt(promptMessage), 10);
            
            if (!isNaN(choiceIndex) && choiceIndex >= 0 && choiceIndex < potentialParents.length) {
                const newParentId = potentialParents[choiceIndex].id;

                // 1. Remove item from its current location
                parent.splice(index, 1);
                
                // 2. Add item to its new location
                if (newParentId === 'root') {
                     menuConfig.push(item);
                } else {
                    const { item: newParent } = findItem(newParentId, menuConfig);
                    if (newParent) {
                        if (!newParent.children) newParent.children = [];
                        newParent.children.push(item);
                    }
                }
                
                await saveSidebarMenuConfig();
                renderMenuEditor();
                setupAdminSidebar();
            }
        }

        // --- App Initialization ---
        async function initializeApp() {
            resetLocalState();
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();

            // Pre-load voices
            if (synth) {
                loadBengaliVoice(); // Initial call
                if (synth.onvoiceschanged !== undefined) {
                    synth.onvoiceschanged = loadBengaliVoice;
                }
            }

            if (firebase.messaging.isSupported()) {
                messaging = firebase.messaging();
                messaging.onMessage((payload) => {
                    console.log('Message received. ', payload);
                    const notificationTitle = payload.notification.title;
                    const notificationOptions = {
                        body: payload.notification.body,
                        icon: '/firebase-logo.png'
                    };
                    new Notification(notificationTitle, notificationOptions);
                });
            }
            
            await getFullState();

            // Check for saved user in localStorage
            const savedUserJSON = localStorage.getItem('loggedInUser');
            if (savedUserJSON) {
                const savedUser = JSON.parse(savedUserJSON);
                
                const adminUser = state.teamAdmins.find(a => a.id === savedUser.id);
                let memberUser, memberAdmin;
                 if (savedUser.role === 'teammember') {
                    for(const admin of state.teamAdmins) {
                        if (admin.teamMembers) {
                            const memberKey = Object.keys(admin.teamMembers).find(k => k === savedUser.id);
                            if (memberKey) {
                                memberUser = {...admin.teamMembers[memberKey], id: memberKey, adminId: admin.id };
                                memberAdmin = admin;
                                break;
                            }
                        }
                    }
                 }


                let userIsValid = false;
                if (savedUser.role === 'superadmin') {
                     userIsValid = true;
                } else if (savedUser.role === 'teamadmin' && adminUser && adminUser.status === 'active') {
                     userIsValid = true;
                } else if (savedUser.role === 'teammember' && memberUser && memberUser.status === 'active' && memberAdmin && memberAdmin.status === 'active') {
                    userIsValid = true;
                }

                if (userIsValid) {
                    state.loggedInUser = savedUser.id;
                    state.loggedInUserRole = savedUser.role;

                    if (savedUser.role === 'superadmin') {
                        renderSuperAdminDashboard();
                        showPage('superAdminDashboard');
                    } else if (savedUser.role === 'teamadmin') {
                        state.loggedInUserName = savedUser.username;
                        renderTeamAdminDashboard();
                        showPage('teamAdminDashboard');
                        playVoice("স্বাগতম এডমিন");
                    } else if (savedUser.role === 'teammember') {
                        state.loggedInUserName = savedUser.name;
                        state.loggedInUserUsername = savedUser.username;
                        state.loggedInUserTeam = savedUser.team;
                        state.loggedInUserTeamId = savedUser.teamId;
                        renderTeamMemberDashboard();
                        showPage('teamMemberDashboard');
                        playWelcomeVoice('member');
                    }
                    if (savedUser.role !== 'superadmin') {
                        startMemberAlarmSystem();
                    }
                } else {
                    localStorage.removeItem('loggedInUser');
                    showPage('mainLoginPage');
                }
            } else {
                 showPage('mainLoginPage');
            }

            setupVoiceAssistant();
             const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.value = today;
            });
        }

        window.onload = initializeApp;

    </script>
</body>
</html>
