
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales Report App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
        }
        #app-container {
            width: 100%;
            height: 100vh;
            background-color: white;
            display: flex;
            flex-direction: column;
        }
         #app {
            flex-grow: 1;
            overflow-y: auto;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        #app::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        #teamAdminDashboard #app {
            -ms-overflow-style: auto;
            scrollbar-width: auto;
        }
        #teamAdminDashboard #app::-webkit-scrollbar {
            display: block;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.6);
            padding: 24px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            text-align: center;
        }
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.875rem;
        }
        .btn-primary {
            background-color: #1877f2;
            color: white;
        }
        .btn-primary:hover {
            background-color: #166fe5;
        }
        .btn-secondary {
            background-color: #e4e6eb;
            color: #050505;
        }
        .btn-secondary:hover {
            background-color: #d8dade;
        }
        .btn-danger {
            background-color: #fa383e;
            color: white;
        }
         .btn-danger:hover {
            background-color: #e32128;
        }
        .btn-warning {
            background-color: #f59e0b;
            color: white;
        }
        .btn-warning:hover {
            background-color: #d97706;
        }
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        .btn-success:hover {
            background-color: #059669;
        }
        .input-field {
            width: 100%;
            padding: 10px;
            border: 1px solid #dddfe2;
            border-radius: 6px;
            margin-bottom: 12px;
        }
        #currentReportItemsTable th, #currentReportItemsTable td {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
        }
        
        #reportTable {
            border-collapse: collapse;
            width: 100%;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 0.7rem; /* Smaller font size */
        }
        #reportTable th, #reportTable td {
            border: 1px solid #ddd;
            padding: 3px; /* Smaller padding */
            text-align: center;
            white-space: nowrap;
        }
        #reportTable thead th {
            position: sticky;
            z-index: 10;
        }
        #reportTable thead tr:first-child th {
            top: 0;
        }
        #reportTable thead tr:nth-child(2) th {
            top: 25px; /* Adjust this value based on the height of the first row */
        }

        #reportTable th:first-child, #reportTable td:first-child,
        #reportTable th:nth-child(2), #reportTable td:nth-child(2),
        #reportTable th:nth-child(3), #reportTable td:nth-child(3) {
            position: sticky;
            z-index: 11;
            background: #f1f5f9;
        }
        #reportTable th:first-child, #reportTable td:first-child {
            left: 0;
            min-width: 40px;
        }
        #reportTable th:nth-child(2), #reportTable td:nth-child(2) {
            left: 40px;
            min-width: 100px;
        }
        #reportTable th:nth-child(3), #reportTable td:nth-child(3) {
            left: 140px;
        }
        
        #reportTable thead th {
             background: #0867d2;
             color: white;
        }
        #reportTable th:first-child, #reportTable th:nth-child(2), #reportTable th:nth-child(3) {
            z-index: 12;
        }

        #reportTable tfoot td {
            font-weight: bold;
            background: #f1f5f9;
        }
        #reportTable .summary-header {
            background: #4a148c; /* Purple for Summary Header */
        }
        #reportTable .summary-col {
             background: #f3e5f5; /* Light purple for summary data columns */
             font-weight: bold;
        }
        .search-suggestions {
            border: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            position: absolute;
            z-index: 100;
            width: 100%;
        }
        .suggestion-item {
            padding: 8px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f0f2f5;
        }
        .neon-glow-btn {
            background-color: #059669;
            color: white;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 0 5px #10b981, 0 0 15px #10b981, 0 0 25px #10b981, 0 0 35px #10b981;
            transition: box-shadow 0.3s ease-in-out, background-color 0.3s ease-in-out;
        }
        .neon-glow-btn:hover {
             background-color: #06d6a0;
             box-shadow: 0 0 10px #06d6a0, 0 0 25px #06d6a0, 0 0 40px #06d6a0, 0 0 60px #06d6a0;
        }
        .grouped-product-table th, .grouped-product-table td {
            padding: 6px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.8rem;
        }
        .grouped-product-table .group-header {
            background-color: #f1f5f9;
            font-weight: 700;
            color: #1e293b;
            padding: 10px 8px;
        }
        .grouped-product-table .inline-input {
            width: 50px;
            padding: 4px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            text-align: center;
            font-size: 0.8rem;
        }
        .toggle-btn {
            cursor: pointer;
            color: #1877f2;
            font-weight: 500;
            margin-left: 8px;
        }
         footer {
            background-color: #1f2937;
            color: #d1d5db;
            padding: 1rem;
            text-align: center;
            font-size: 0.875rem;
            flex-shrink: 0;
        }
         @keyframes blink {
            50% {
                opacity: 0;
            }
        }
        .blinking-text {
            animation: blink 1s linear infinite;
            color: #ef4444; /* red-500 */
            font-weight: bold;
        }
        .accordion-header {
            cursor: pointer;
            padding: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(255, 255, 255, 0.1);
            transition: background-color 0.2s;
        }
        .accordion-header:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .accordion-content {
            display: none;
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(255, 255, 255, 0.05);
        }

    </style>
</head>
<body class="antialiased font-sans">
<div id="app-container">
    <div id="app">

        <!-- Main Login Page -->
        <div id="mainLoginPage" class="page active">
            <div class="card max-w-md mx-auto mt-8 md:mt-16">
                <h1 class="text-2xl font-bold text-center mb-6">Welcome to Sales Report App</h1>
                <p class="text-center text-gray-600 mb-6">Login to continue</p>
                <div class="flex flex-col space-y-4">
                    <button onclick="showPage('superAdminLoginPage')" class="btn btn-primary">Super Admin Login</button>
                    <button onclick="showPage('teamAdminLoginPage')" class="btn btn-primary">Team Admin Login</button>
                    <button onclick="showPage('teamMemberLoginPage')" class="btn btn-primary">Team Member Login</button>
                </div>
            </div>
        </div>

        <!-- Super Admin Login Page -->
        <div id="superAdminLoginPage" class="page">
             <div class="card max-w-md mx-auto mt-8 md:mt-16">
                <h2 class="text-xl font-bold mb-4">Super Admin Login</h2>
                <input type="password" id="superAdminPassword" class="input-field" placeholder="Enter password">
                <button onclick="loginSuperAdmin()" class="btn btn-primary w-full">Login</button>
                <button onclick="showPage('mainLoginPage')" class="btn btn-secondary w-full mt-2">Back to Main Menu</button>
            </div>
        </div>

        <!-- Team Admin Login Page -->
        <div id="teamAdminLoginPage" class="page">
            <div class="card max-w-md mx-auto mt-8 md:mt-16">
                <h2 class="text-xl font-bold mb-4">Team Admin Login</h2>
                <input type="text" id="teamAdminUsername" class="input-field" placeholder="Username">
                <input type="password" id="teamAdminPassword" class="input-field" placeholder="Password">
                <button onclick="loginTeamAdmin()" class="btn btn-primary w-full">Login</button>
                <button onclick="showPage('mainLoginPage')" class="btn btn-secondary w-full mt-2">Back to Main Menu</button>
            </div>
        </div>
        
        <!-- Team Member Login Page -->
        <div id="teamMemberLoginPage" class="page">
            <div class="card max-w-md mx-auto mt-8 md:mt-16">
                <h2 class="text-xl font-bold mb-4">Team Member Login</h2>
                <input type="text" id="teamMemberUsername" class="input-field" placeholder="Username">
                <input type="password" id="teamMemberPassword" class="input-field" placeholder="Password">
                <button onclick="loginTeamMember()" class="btn btn-primary w-full">Login</button>
                <button onclick="showPage('mainLoginPage')" class="btn btn-secondary w-full mt-2">Back to Main Menu</button>
            </div>
        </div>


        <!-- Super Admin Dashboard -->
        <div id="superAdminDashboard" class="page">
            <div class="card">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <h2 class="text-2xl font-bold mb-4 md:mb-0">Super Admin Dashboard</h2>
                    <button onclick="handleLogoutClick(event)" class="btn btn-danger w-full md:w-auto">Logout</button>
                </div>

                <div class="mb-8">
                    <button onclick="showPage('createTeamAdminPage')" class="btn btn-primary">Create New Team Admin</button>
                </div>

                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-2">Manage Team Admins (<span id="teamAdminCount">0</span>)</h3>
                    <div id="teamAdminsList" class="space-y-2"></div>
                </div>
                
                 <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-2">Change Super Admin Password</h3>
                    <div class="p-4 border rounded-lg space-y-4 max-w-md">
                        <input type="password" id="newSuperAdminPassword" class="input-field" placeholder="New Password">
                        <input type="password" id="confirmSuperAdminPassword" class="input-field" placeholder="Confirm New Password">
                        <button onclick="changeSuperAdminPassword()" class="btn btn-warning w-full">Change Password</button>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-2">Notice for Team Admins</h3>
                    <div class="p-4 border rounded-lg space-y-4">
                        <textarea id="superAdminNotice" class="input-field !mb-0" placeholder="Write notice for team admins..."></textarea>
                        <button onclick="saveSuperAdminNotice()" class="btn btn-primary w-full">Save Notice</button>
                         <button onclick="deleteSuperAdminNotice()" class="btn btn-danger w-full mt-2">Delete Notice</button>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-2">Manage Advertisements</h3>
                    <div class="p-4 border rounded-lg space-y-4">
                        <div>
                            <label for="popunderAd" class="font-semibold text-sm">Popunder Ad URL</label>
                            <input type="text" id="popunderAd" class="input-field !mb-0" placeholder="https://example.com/popunder">
                        </div>
                        <div>
                            <label for="bannerAd" class="font-semibold text-sm">Banner Ad URL</label>
                            <input type="text" id="bannerAd" class="input-field !mb-0" placeholder="https://example.com/banner.jpg">
                        </div>
                        <div>
                            <label for="nativeBannerAd" class="font-semibold text-sm">Native Banner Ad URL</label>
                            <input type="text" id="nativeBannerAd" class="input-field !mb-0" placeholder="https://example.com/native_banner.jpg">
                        </div>
                        <button onclick="saveAdvertisements()" class="btn btn-primary w-full">Save Advertisements</button>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- Create Team Admin Page -->
        <div id="createTeamAdminPage" class="page">
            <div class="card max-w-md mx-auto mt-8 md:mt-16">
                <h3 class="text-xl font-bold mb-4">Create New Team Admin</h3>
                <input type="text" id="newTeamAdminUsername" class="input-field" placeholder="Team Admin Username">
                <input type="password" id="newTeamAdminPassword" class="input-field" placeholder="Password">
                <button onclick="createTeamAdmin()" class="btn btn-primary w-full">Create Team Admin</button>
                <button onclick="showPage('superAdminDashboard')" class="btn btn-secondary w-full mt-2">Back to Dashboard</button>
            </div>
        </div>

        <!-- Team Admin Dashboard -->
        <div id="teamAdminDashboard" class="page">
             <div class="card">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <h2 class="text-2xl font-bold mb-4 md:mb-0">Team Admin Dashboard</h2>
                    <button onclick="handleLogoutClick(event)" class="btn btn-danger w-full md:w-auto">Logout</button>
                </div>
                <p class="mb-6">Welcome, <span id="loggedInTeamAdminUsername" class="font-semibold"></span>!</p>
                <div id="superAdminNoticeContainerForAdmin" class="mb-4"></div>

                <div class="mb-8">
                     <button onclick="showPage('createTeamMemberPage')" class="btn btn-primary">Create New Team Member</button>
                </div>

                <!-- Team Report Section -->
                <div id="teamReportSection" class="mb-8">
                    <h3 class="text-lg font-semibold mb-2">Team Report Dashboard</h3>
                    
                    <div class="controls mb-4 flex flex-col md:flex-row items-stretch md:items-center md:space-x-4 space-y-4 md:space-y-0">
                        <div class="flex items-center space-x-2">
                            <label for="reportDate" class="font-semibold whitespace-nowrap">Select Date:</label>
                            <input type="date" id="reportDate" onchange="renderTeamAdminReports()" class="input-field !mb-0 w-auto">
                        </div>
                         <button onclick="exportReportToExcel()" class="btn btn-success">Export</button>
                         <button onclick="copyTable()" class="btn btn-secondary">Copy</button>
                    </div>

                    <div id="reportSubmissionStatus" class="mb-4 p-4 border rounded-lg bg-gray-50">
                        <!-- Submission status will be rendered here -->
                    </div>

                    <div class="overflow-x-auto max-h-[50vh] overflow-y-auto">
                        <table id="reportTable">
                            <thead>
                              <tr id="memberRow">
                              </tr>
                              <tr id="subHeaderRow">
                              </tr>
                            </thead>
                            <tbody id="tableBody">
                            </tbody>
                            <tfoot id="tableFoot">
                            </tfoot>
                        </table>
                    </div>
                </div>

                 <div class="mt-8 mb-8 border-t pt-8">
                    <h3 class="text-lg font-semibold mb-2">Up to Date Report</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end mb-4 p-4 border rounded-lg bg-gray-50">
                        <div>
                            <label for="reportStartDate" class="font-semibold text-sm">Start Date:</label>
                            <input type="date" id="reportStartDate" class="input-field !mb-0 w-full">
                        </div>
                         <div>
                            <label for="reportEndDate" class="font-semibold text-sm">End Date:</label>
                            <input type="date" id="reportEndDate" class="input-field !mb-0 w-full">
                        </div>
                        <div>
                            <label for="reportMemberSelect" class="font-semibold text-sm">Select Member:</label>
                            <select id="reportMemberSelect" class="input-field !mb-0 w-full"></select>
                        </div>
                         <div>
                            <label for="reportProductSelect" class="font-semibold text-sm">Select Product:</label>
                            <select id="reportProductSelect" class="input-field !mb-0 w-full"></select>
                        </div>
                    </div>
                    <button onclick="renderTeamAdminReportsForDateRange()" class="btn btn-primary w-full">View Report</button>
                </div>
                
                 <!-- Category Wise Report Section -->
                <div class="border-t-4 border-gray-200 pt-8 mt-8 mb-8">
                     <div class="flex items-center mb-4">
                        <h3 class="text-lg font-semibold">Category Wise Report</h3>
                        <span id="toggleCategoryWiseReport" class="toggle-btn text-sm">[Show]</span>
                    </div>
                    <div id="categoryWiseReportSection" class="p-4 border rounded-lg space-y-6 bg-gray-50" style="display: none;">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label for="categoryReportStartDate" class="font-semibold text-sm">Start Date:</label>
                                <input type="date" id="categoryReportStartDate" class="input-field !mb-0 w-full">
                            </div>
                             <div>
                                <label for="categoryReportEndDate" class="font-semibold text-sm">End Date:</label>
                                <input type="date" id="categoryReportEndDate" class="input-field !mb-0 w-full">
                            </div>
                            <div>
                                <label for="categoryReportMemberSelect" class="font-semibold text-sm">Select Member:</label>
                                <select id="categoryReportMemberSelect" class="input-field !mb-0 w-full"></select>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button onclick="renderCategoryWiseReport()" class="btn btn-primary w-full">View Category Report</button>
                            <button onclick="exportCategoryReportToExcel()" class="btn btn-success w-full">Export to Excel</button>
                        </div>
                        <div class="mt-4">
                            <canvas id="categoryChart"></canvas>
                        </div>
                        <div id="categoryReportTableContainer" class="mt-4 overflow-x-auto"></div>
                    </div>
                </div>

                <div id="allSectionsManager" class="border-t-4 border-double border-gray-300 pt-8 mt-12 mb-8">
                     <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold">All Section Manage</h3>
                        <button id="toggleAllSectionsBtn" class="btn btn-secondary btn-sm">Toggle All</button>
                    </div>
                    <div class="border rounded-lg overflow-hidden">
                        
                        <div class="accordion-header">
                            <h3 class="text-lg font-semibold">Manage Team Members</h3>
                        </div>
                        <div class="accordion-content">
                            <div id="teamMembersList" class="space-y-2"></div>
                        </div>
        
                        <div class="accordion-header">
                            <h3 class="text-lg font-semibold">Notice for Team Members</h3>
                        </div>
                        <div class="accordion-content">
                            <div id="teamAdminNoticeSection" class="space-y-4">
                                <textarea id="teamAdminNotice" class="input-field !mb-0" placeholder="Write notice for team members..."></textarea>
                                <button onclick="saveTeamAdminNotice()" class="btn btn-primary w-full">Save Notice</button>
                                <button onclick="deleteTeamAdminNotice()" class="btn btn-danger w-full mt-2">Delete Notice</button>
                            </div>
                        </div>
        
                        <div class="accordion-header">
                            <h3 class="text-lg font-semibold">Add New Product</h3>
                        </div>
                        <div class="accordion-content">
                            <div id="addProductSection" class="space-y-4">
                                <input type="text" id="newProductName" class="input-field" placeholder="Product Name">
                                <input type="number" id="newProductRate" class="input-field" placeholder="Product Rate">
                                <label for="newProductCategory" class="text-sm font-medium text-gray-700">Add New Category</label>
                                <input type="text" id="newProductCategory" class="input-field" placeholder="Type new category name...">
                                <button onclick="addNewProduct()" class="btn btn-primary w-full">Add Product</button>
                            </div>
                        </div>
        
                        <div class="accordion-header">
                            <h3 class="text-lg font-semibold">Manage Products</h3>
                        </div>
                        <div class="accordion-content">
                            <div id="manageProductSection">
                                <div class="relative mb-2">
                                    <input type="text" id="adminProductSearch" class="input-field" placeholder="Search for a product..." oninput="filterProductsForAdmin(this.value)">
                                </div>
                                <div id="productListForAdmin" class="space-y-2 max-h-96 overflow-y-auto p-2 border rounded-md"></div>
                            </div>
                        </div>

                        <div class="accordion-header">
                            <h3 class="text-lg font-semibold">Manage Categories</h3>
                        </div>
                        <div class="accordion-content">
                            <div id="categoryManagerSection">
                                <div class="mb-4 p-4 border rounded-lg">
                                    <h4 class="font-semibold mb-2">Add New Category</h4>
                                    <input type="text" id="newStandaloneCategoryName" class="input-field" placeholder="New category name">
                                    <button onclick="addStandaloneCategory()" class="btn btn-primary w-full">Add Category</button>
                                </div>
                                <div class="mb-4 p-4 border rounded-lg">
                                    <h4 class="font-semibold mb-2">Delete Existing Category</h4>
                                    <select id="deleteCategorySelect" class="input-field">
                                        <option value="">-- Select Category to Delete --</option>
                                    </select>
                                    <button onclick="deleteStandaloneCategory()" class="btn btn-danger w-full">Delete Selected Category</button>
                                </div>
                            </div>
                        </div>

                         <div class="accordion-header">
                            <h3 class="text-lg font-semibold">Manage Notification System</h3>
                        </div>
                        <div class="accordion-content">
                            <div id="notificationSystemSection" class="space-y-6">
                                <div class="flex items-center justify-between">
                                    <label for="enableNotifications" class="font-semibold text-gray-700">Enable Notification System</label>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="enableNotifications" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
        
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Reminder Message (for non-submitters)</label>
                                    <textarea id="reminderMessage" rows="3" class="input-field !mb-0" placeholder="Message for members who have not submitted their report..."></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Reminder Times</label>
                                    <div id="reminderTimesContainer" class="space-y-2">
                                        <!-- Reminder time inputs will be here -->
                                    </div>
                                    <button onclick="addReminderTimeInput()" class="btn btn-secondary btn-sm mt-2">Add More Time</button>
                                </div>
        
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Thank You Message (for submitters)</label>
                                    <textarea id="thankYouMessage" rows="2" class="input-field !mb-0" placeholder="Message for members who have submitted their report..."></textarea>
                                </div>
        
                                <button onclick="saveNotificationSettings()" class="btn btn-primary w-full">Save Settings</button>
                            </div>
                        </div>

                        <div class="accordion-header">
                            <h3 class="text-lg font-semibold">Manage Logout Settings</h3>
                        </div>
                        <div class="accordion-content">
                            <div id="logoutSettingsSection" class="space-y-4">
                                <div>
                                    <label for="logoutClickCount" class="block text-sm font-medium text-gray-700 mb-1">Required Clicks to Logout</label>
                                    <input type="number" id="logoutClickCount" class="input-field !mb-0" placeholder="e.g., 10">
                                </div>
                                <button onclick="saveLogoutSettings()" class="btn btn-primary w-full">Save Logout Clicks</button>
                            </div>
                        </div>
                        
                        <div class="accordion-header">
                            <h3 class="text-lg font-semibold">Manage Voice Settings</h3>
                        </div>
                        <div class="accordion-content">
                            <div id="voiceSettingsSection" class="space-y-4">
                                <div>
                                    <label for="voiceRepeatCount" class="block text-sm font-medium text-gray-700 mb-1">Voice Summary Repeat Count</label>
                                    <input type="number" id="voiceRepeatCount" class="input-field !mb-0" placeholder="e.g., 2">
                                </div>
                                <button onclick="saveVoiceSettings()" class="btn btn-primary w-full">Save Voice Settings</button>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>
        
         <!-- Create Team Member Page -->
        <div id="createTeamMemberPage" class="page">
            <div class="card max-w-md mx-auto mt-8 md:mt-16">
                 <h3 class="text-xl font-bold mb-4">Create New Team Member</h3>
                <input type="text" id="newTeamMemberName" class="input-field" placeholder="Team Member Name">
                <input type="text" id="newTeamMemberUsername" class="input-field" placeholder="Team Member Username">
                <input type="password" id="newTeamMemberPassword" class="input-field" placeholder="Password">
                <button onclick="createTeamMember()" class="btn btn-primary w-full">Create Team Member</button>
                <button onclick="showPage('teamAdminDashboard')" class="btn btn-secondary w-full mt-2">Back to Dashboard</button>
            </div>
        </div>

        <!-- Team Member Dashboard -->
        <div id="teamMemberDashboard" class="page">
            <div class="card">
                 <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 md:mb-0">Team Member Dashboard</h2>
                        <p class="mb-4 md:mb-0">Welcome, <span id="loggedInTeamMemberName" class="font-semibold"></span>!</p>
                    </div>
                    <button onclick="handleLogoutClick(event)" class="btn btn-danger w-full md:w-auto">Logout</button>
                </div>
                 <div id="teamAdminNoticeContainer" class="border-b pb-4 mb-6"></div>


                <div id="submitReportContainer" class="mb-8 p-4 border rounded-lg">
                    <h3 class="text-lg font-semibold mb-2">Submit Daily Sales Report</h3>
                    
                     <div class="border-t pt-4">
                        <h4 class="text-md font-semibold mb-4">Add Products to Report</h4>
                        
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <input type="text" id="memberProductSearch" oninput="handleProductSearchForMember(this.value)" class="input-field !mb-0 flex-grow" placeholder="Search for a product by name...">
                            <select id="productCategorySelect" onchange="handleCategorySelect(this.value)" class="input-field !mb-0 md:w-1/3">
                                <!-- Categories will be populated here -->
                            </select>
                        </div>

                        <div id="memberProductListContainer" class="max-h-[60vh] overflow-y-auto mb-6">
                            <!-- Product list for selected category or search will be rendered here -->
                        </div>
                    </div>


                    <div class="mt-6">
                        <h4 class="text-md font-semibold mb-2">Current Report Items</h4>
                        <div class="border rounded-lg overflow-x-auto">
                            <table id="currentReportItemsTable" class="w-full text-left">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th>Product Name</th>
                                        <th>TGT</th>
                                        <th>Sales</th>
                                        <th>Amount</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="currentReportItems">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <button onclick="submitSalesReport()" class="btn btn-success mt-4 w-full">Submit Final Report</button>
                </div>

                <div class="mt-8">
                    <h3 class="text-lg font-semibold mb-2">My All Submitted Reports</h3>
                    <div id="mySalesReportsList" class="space-y-4"></div>
                </div>

            </div>
        </div>

        <!-- Advertisement Container -->
        <div id="adContainer" class="mt-8 text-center"></div>
    </div>
    <footer id="mainFooter">
        © 2024 shohel_it. All rights reserved.
    </footer>
</div>
    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBhvOEtF_7iMzBxEtJMUx4y49XtfwcsuDs",
            authDomain: "ekta-local-saver.firebaseapp.com",
            databaseURL: "https://ekta-local-saver-default-rtdb.firebaseio.com",
            projectId: "ekta-local-saver",
            storageBucket: "ekta-local-saver.appspot.com",
            messagingSenderId: "279895079867",
            appId: "1:279895079867:web:51b22c70183af03551e29e"
        };

        // --- Global Variables ---
        let db;
        let messaging;
        let state = {}; 
        let alarmIntervalId = null;
        let adminNotificationIntervalId = null;
        let logoutClickCounter = 0;
        let logoutClickTimer = null;
        let categoryChartInstance = null;
        
        const defaultProducts = [
            { id: 'prod_1', name: 'Chili Powder 50gm NEW', rate: 29.11, category: 'Chili Powder' },
            { id: 'prod_2', name: 'Chili Powder 100gm NEW', rate: 57.60, category: 'Chili Powder' },
            { id: 'prod_3', name: 'Chili Powder - 200gm', rate: 108.00, category: 'Chili Powder' },
            { id: 'prod_4', name: 'Chili Powder-500gm x 24', rate: 254.57, category: 'Chili Powder' },
            { id: 'prod_5', name: 'Chili Powder-1kg', rate: 556.45, category: 'Chili Powder' },
            { id: 'prod_6', name: 'Chili powder 200 gm jar', rate: 132.96, category: 'Chili Powder' },
            { id: 'prod_7', name: 'Chili powder 5 kg-New', rate: 1530, category: 'Chili Powder' },
            { id: 'prod_8', name: '16 Ana Chilli-15Kg (Bulk)', rate: 4380, category: 'Chili Powder' },
            { id: 'prod_9', name: 'Turmeric Powder 15gm New', rate: 9.95, category: 'Turmeric Powder' },
            { id: 'prod_10', name: 'Turmeric Powder 50gm NEW', rate: 30.67, category: 'Turmeric Powder' },
            { id: 'prod_11', name: 'Turmeric Powder 100gm NEW', rate: 57.78, category: 'Turmeric Powder' },
            { id: 'prod_12', name: 'Turmeric Powder 200 gm', rate: 112.00, category: 'Turmeric Powder' },
            { id: 'prod_13', name: 'Turmeric Powder 500gmX24 Pouch', rate: 249.43, category: 'Turmeric Powder' },
            { id: 'prod_14', name: 'Turmeric Powder-1kg', rate: 533.33, category: 'Turmeric Powder' },
            { id: 'prod_15', name: 'Turmeric powder 200 gm jar', rate: 135.36, category: 'Turmeric Powder' },
            { id: 'prod_16', name: 'Turmeric Powder- 5kg', rate: 1310, category: 'Turmeric Powder' },
            { id: 'prod_17', name: '16 Ana Turmeric 15kg (Bulk)', rate: 3821, category: 'Turmeric Powder' },
            { id: 'prod_18', name: 'Pran Coriander Powder 50 gm pouch', rate: 23.57, category: 'Coriander Powder' },
            { id: 'prod_19', name: 'Pran Coriander Powder 100 gm pouch', rate: 44.14, category: 'Coriander Powder' },
            { id: 'prod_20', name: 'Pran Coriander Powder 200 gm pouch', rate: 83.33, category: 'Coriander Powder' },
            { id: 'prod_21', name: 'Pran Coriander Powder 500 gm pouch', rate: 180.00, category: 'Coriander Powder' },
            { id: 'prod_22', name: 'Pran Coriander Powder 200 gm Jar', rate: 92.57, category: 'Coriander Powder' },
            { id: 'prod_23', name: 'Pran Cumin Powder 15gm pouch', rate: 22.05, category: 'Cumin Powder' },
            { id: 'prod_24', name: 'Pran Cumin Powder 50gm pouch', rate: 66.67, category: 'Cumin Powder' },
            { id: 'prod_25', name: 'Pran Cumin Powder 100gm pouch', rate: 129.09, category: 'Cumin Powder' },
            { id: 'prod_26', name: 'Pran Cumin Powder 200gm pouch', rate: 247.11, category: 'Cumin Powder' },
            { id: 'prod_27', name: 'Pran Cumin Powder 200gm Jar', rate: 268.18, category: 'Cumin Powder' },
            { id: 'prod_28', name: 'Pran Cumin Powder 500gm pouch', rate: 578.57, category: 'Cumin Powder' },
            { id: 'prod_29', name: 'Fish Masala 20gm Foil NEW', rate: 15.00, category: 'Mixed Spice and box' },
            { id: 'prod_30', name: 'Beef Masala 20gm Foil NEW', rate: 15.45, category: 'Mixed Spice and box' },
            { id: 'prod_31', name: 'Chicken Masala 20gm Foil NEW', rate: 15.11, category: 'Mixed Spice and box' },
            { id: 'prod_32', name: 'Meat Masala 20gm Foil NEW', rate: 15.45, category: 'Mixed Spice and box' },
            { id: 'prod_33', name: 'Biriyani Masala Mix 25 gm', rate: 30.74, category: 'Mixed Spice and box' },
            { id: 'prod_34', name: 'Meat Masala 100gm×48pcs P.Box', rate: 76.36, category: 'Mixed Spice and box' },
            { id: 'prod_35', name: 'Chicken Masala 100gm×48pcs P.Box', rate: 75.00, category: 'Mixed Spice and box' },
            { id: 'prod_36', name: 'Chicken Roast Masala 35gm×48pcs P.Box', rate: 48.89, category: 'Mixed Spice and box' },
            { id: 'prod_37', name: 'Tehari Masala 40gm×48pcs P.Box', rate: 44.16, category: 'Mixed Spice and box' },
            { id: 'prod_38', name: 'Bombay Biryani Masala 45gm×48pcs P.Box', rate: 48.00, category: 'Mixed Spice and box' },
            { id: 'prod_39', name: 'Biryani Masala 40gm×48pcs P.Box', rate: 46.15, category: 'Mixed Spice and box' },
            { id: 'prod_40', name: 'Chatpati Masala 45gm×48pcs P.Box', rate: 36.00, category: 'Mixed Spice and box' },
            { id: 'prod_41', name: 'Firni Mix 150gm×48pcs P.Box', rate: 48.40, category: 'Mixed Spice and box' },
            { id: 'prod_42', name: 'BBQ Sheik Kabab Masala 50gm×48pcs P.Box', rate: 62.77, category: 'Mixed Spice and box' },
            { id: 'prod_43', name: 'Kacchi Biryani Masala 45gm×48pcs P.Box', rate: 52.53, category: 'Mixed Spice and box' },
            { id: 'prod_44', name: 'Haleem Mix  200 gm', rate: 54.67, category: 'Mixed Spice and box' },
            { id: 'prod_45', name: 'Curry powder 20gm', rate: 90.10, category: 'Mixed Spice and box' },
            { id: 'prod_46', name: 'Garam Masala 15gm Foil New', rate: 27.50, category: 'Mixed Spice and box' },
            { id: 'prod_47', name: 'Payes Mix 150gmX48pcs P.Box', rate: 53.78, category: 'Mixed Spice and box' },
            { id: 'prod_48', name: 'Kacchi Biryani Masala 40 gm', rate: 52.53, category: 'Mixed Spice and box' },
            { id: 'prod_49', name: 'Beef Kala Bhuna 80 gm', rate: 91.58, category: 'Mixed Spice and box' },
            { id: 'prod_50', name: 'Shindhi Biriany Masala 45 gm', rate: 44.31, category: 'Mixed Spice and box' },
            { id: 'prod_51', name: 'Khichuri Masala 50 gm', rate: 48.96, category: 'Mixed Spice and box' },
            { id: 'prod_52', name: 'Mustard Oil-80ml', rate: 23.56, category: 'Mustard Oil' },
            { id: 'prod_53', name: 'Mustard Oil-200-mL', rate: 52.89, category: 'Mustard Oil' },
            { id: 'prod_54', name: 'Mustard Oil-250ml', rate: 66.00, category: 'Mustard Oil' },
            { id: 'prod_55', name: 'Mustard Oil-500 ml', rate: 136.89, category: 'Mustard Oil' },
            { id: 'prod_56', name: 'Mustard Oil 500ml-CP', rate: 118.34, category: 'Mustard Oil' },
            { id: 'prod_57', name: 'Mustard Oil-1000ml', rate: 265.71, category: 'Mustard Oil' },
            { id: 'prod_58', name: 'Mustard Oil 1000ml-CP', rate: 255.11, category: 'Mustard Oil' },
            { id: 'prod_59', name: 'Mustard oil 2 liter', rate: 528.89, category: 'Mustard Oil' },
            { id: 'prod_60', name: 'M . Oil 5 Liter', rate: 1102.22, category: 'Mustard Oil' },
            { id: 'prod_61', name: 'Mughal 150 ml', rate: 43.00, category: 'Mustard Oil' },
            { id: 'prod_62', name: 'Mustard oil 16kg Tin', rate: 3270.00, category: 'Mustard Oil' },
            { id: 'prod_63', name: 'Testing salt 20 gm', rate: 7.08, category: 'Testing salt' },
            { id: 'prod_64', name: 'T-Salt-40 gm New', rate: 14.17, category: 'Testing salt' },
            { id: 'prod_65', name: 'T-Salt-100 gm New', rate: 35.00, category: 'Testing salt' },
            { id: 'prod_66', name: 'T-Salt 450 gm', rate: 137.89, category: 'Testing salt' },
            { id: 'prod_67', name: 'Shader Masala 4gmX480 Pcs', rate: 3.40, category: 'Shader Masala ' },
            { id: 'prod_68', name: 'Whole Panchforan 50gm New', rate: 23.41, category: 'Panchforan and Jello' },
            { id: 'prod_69', name: 'The chef Tomato Sauce 295gm', rate: 86.20, category: 'Sauce and Vinegar' },
            { id: 'prod_70', name: 'The Chef Hot Tomato Sauce-1000gm', rate: 229.62, category: 'Sauce and Vinegar' },
            { id: 'prod_71', name: 'The Chef Hot Tomato Sauce 3 Kg', rate: 467.03, category: 'Sauce and Vinegar' },
            { id: 'prod_72', name: 'The chef White Vinager 330 ml', rate: 26.40, category: 'Sauce and Vinegar' },
            { id: 'prod_73', name: 'The chef White vinager 650 ml', rate: 43.56, category: 'Sauce and Vinegar' },
            { id: 'prod_74', name: 'The chef white vinager 5 ltr', rate: 213.18, category: 'Sauce and Vinegar' },
            { id: 'prod_75', name: 'Love Jello-18 pcs Poly', rate: 40.00, category: 'Panchforan and Jello' },
            { id: 'prod_76', name: 'Love Jelly-100pcs', rate: 215.00, category: 'Panchforan and Jello' },
            { id: 'prod_77', name: 'The Chef Rose Water 200 ML', rate: 15.94, category: 'Rose and Kewra' },
            { id: 'prod_78', name: 'The Chef Kewra Water 200 ML', rate: 15.11, category: 'Rose and Kewra' },
            { id: 'prod_79', name: 'The Chef Rose Water 160 ML', rate: 12.00, category: 'Rose and Kewra' },
            { id: 'prod_80', name: 'The Chef Chinigura Rice 1 Kg', rate: 136.00, category: 'Rice' }
        ];

        const reportingCategories = {
            "Basic Spice": ["Chili Powder 50gm NEW", "Chili Powder 100gm NEW", "Chili Powder - 200gm", "Chili Powder-500gm x 24", "Chili Powder-1kg", "Chili powder 200 gm jar", "Turmeric Powder 15gm New", "Turmeric Powder 50gm NEW", "Turmeric Powder 100gm NEW", "Turmeric Powder 200 gm", "Turmeric Powder 500gmX24 Pouch", "Turmeric Powder-1kg", "Turmeric powder 200 gm jar", "Pran Coriander Powder 50 gm pouch", "Pran Coriander Powder 100 gm pouch", "Pran Coriander Powder 200 gm pouch", "Pran Coriander Powder 500 gm pouch", "Pran Coriander Powder 200 gm Jar", "Pran Cumin Powder 15gm pouch", "Pran Cumin Powder 50gm pouch", "Pran Cumin Powder 100gm pouch", "Pran Cumin Powder 200gm pouch", "Pran Cumin Powder 200gm Jar", "Pran Cumin Powder 500gm pouch"],
            "Mixed Spice": ["Fish Masala 20gm Foil NEW", "Beef Masala 20gm Foil NEW", "Chicken Masala 20gm Foil NEW", "Meat Masala 20gm Foil NEW", "Biriyani Masala Mix 25 gm", "Meat Masala 100gm×48pcs P.Box", "Chicken Masala 100gm×48pcs P.Box", "Chicken Roast Masala 35gm×48pcs P.Box", "Tehari Masala 40gm×48pcs P.Box", "Bombay Biryani Masala 45gm×48pcs P.Box", "Biryani Masala 40gm×48pcs P.Box", "Chatpati Masala 45gm×48pcs P.Box", "Firni Mix 150gm×48pcs P.Box", "BBQ Sheik Kabab Masala 50gm×48pcs P.Box", "Kacchi Biryani Masala 45gm×48pcs P.Box", "Haleem Mix  200 gm", "Curry powder 20gm", "Payes Mix 150gmX48pcs P.Box", "Kacchi Biryani Masala 40 gm", "Beef Kala Bhuna 80 gm", "Shindhi Biriany Masala 45 gm", "Khichuri Masala 50 gm"],
            "Must. oil": ["Mustard Oil-80ml", "Mustard Oil-200-mL", "Mustard Oil-250ml", "Mustard Oil-500 ml", "Mustard Oil 500ml-CP", "Mustard Oil-1000ml", "Mustard Oil 1000ml-CP", "Mustard oil 2 liter", "M . Oil 5 Liter", "Mughal 150 ml"],
            "Must. oil Bulk": ["Mustard oil 16kg Tin"],
            "Oil": [],
            "Others": ["Whole Panchforan 50gm New", "The chef Tomato Sauce 295gm", "The Chef Hot Tomato Sauce-1000gm", "The Chef Hot Tomato Sauce 3 Kg", "The Chef Rose Water 200 ML", "The Chef Kewra Water 200 ML", "The Chef Rose Water 160 ML", "Garam Masala 15gm Foil New"],
            "Shader Masala": ["Shader Masala 4gmX480 Pcs"],
            "Spice Bulk": ["Chili powder 5 kg-New", "16 Ana Chilli-15Kg (Bulk)", "Turmeric Powder- 5kg", "16 Ana Turmeric 15kg (Bulk)"],
            "Testing Salt": ["Testing salt 20 gm", "T-Salt-40 gm New", "T-Salt-100 gm New", "T-Salt 450 gm"],
            "White Vinegar": ["The chef White Vinager 330 ml", "The chef White vinager 650 ml", "The chef white vinager 5 ltr"]
        };


        function assignCategoriesToProducts(products) {
            const categoryMap = defaultProducts.reduce((map, p) => {
                map[p.name] = p.category;
                return map;
            }, {});

            return products.map(p => {
                if (!p.category && categoryMap[p.name]) {
                    p.category = categoryMap[p.name];
                }
                return p;
            });
        }

        function resetLocalState() {
             state = {
                loggedInUser: null,
                loggedInUserName: null,
                loggedInUserUsername: null,
                loggedInUserRole: null,
                loggedInUserTeam: null,
                loggedInUserTeamId: null,
                currentReportItems: [],
                superAdminPassword: 'shohel2nt',
                teamAdmins: [],
                salesReports: [],
                products: [],
                categories: [],
                notificationSettings: {},
                logoutSettings: {},
                voiceSettings: {},
                advertisements: {
                    popunder: '',
                    banner: '',
                    nativeBanner: ''
                },
                superAdminNotice: '',
                notices: {}
            };
        }


        // --- Firebase Data Functions ---
        async function getFullState() {
            try {
                const snapshot = await db.ref().once('value');
                const dbState = snapshot.val() || {};

                const firebaseObjectToArray = (fbObject) => {
                    if (!fbObject) return [];
                    return Object.keys(fbObject).map(key => ({ id: key, ...fbObject[key] }));
                };
                
                state.teamAdmins = firebaseObjectToArray(dbState.teamAdmins);
                state.salesReports = firebaseObjectToArray(dbState.salesReports);
                state.products = firebaseObjectToArray(dbState.products);
                state.categories = firebaseObjectToArray(dbState.categories);
                state.advertisements = dbState.advertisements || { popunder: '', banner: '', nativeBanner: ''};
                state.superAdminNotice = dbState.superAdminNotice || '';
                state.notices = dbState.notices || {};
                state.notificationSettings = dbState.notificationSettings || {};
                state.logoutSettings = dbState.logoutSettings || {};
                state.voiceSettings = dbState.voiceSettings || {};


                if (!dbState.products || state.products.length < 80) {
                    const productsToPush = defaultProducts.reduce((obj, item) => {
                        obj[item.id] = { name: item.name, rate: item.rate, category: item.category };
                        return obj;
                    }, {});
                    await db.ref('products').set(productsToPush);
                    await getFullState(); // Re-fetch after seeding
                    return;
                }

                // Assign categories to products from DB
                state.products = assignCategoriesToProducts(state.products);


                if (dbState.superAdmin && dbState.superAdmin.password) {
                    state.superAdminPassword = dbState.superAdmin.password;
                } else {
                     await db.ref('superAdmin/password').set(state.superAdminPassword);
                }

                 if (!dbState.advertisements) {
                    await db.ref('advertisements').set(state.advertisements);
                }

            } catch (error) {
                console.error("Error fetching data from Firebase:", error);
                showAlert("Could not connect to the database. Please check your connection and Firebase setup.");
            }
        }

        
        // --- Utility Functions ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const page = document.getElementById(pageId);
             if (page) {
                page.classList.add('active');
                 document.body.style.overflowY = (pageId === 'teamAdminDashboard' || pageId === 'superAdminDashboard') ? 'auto' : 'hidden';
            } else {
                 document.body.style.overflowY = 'hidden';
            }

            renderAdvertisements(pageId);
        }

        async function performLogout() {
            if (alarmIntervalId) clearInterval(alarmIntervalId);
            if (adminNotificationIntervalId) clearInterval(adminNotificationIntervalId);
            alarmIntervalId = null;
            adminNotificationIntervalId = null;

            localStorage.removeItem('loggedInUser');
            resetLocalState();
            await getFullState(); 
            document.querySelectorAll('input[type="password"], input[type="text"]').forEach(input => input.value = '');
            showPage('mainLoginPage');
        }

        function handleLogoutClick(event) {
            let requiredClicks = 1;
            
            if (state.loggedInUserRole === 'teammember') {
                const adminSettings = state.logoutSettings[state.loggedInUserTeamId];
                requiredClicks = (adminSettings && adminSettings.clickCount) ? parseInt(adminSettings.clickCount, 10) : 10;
            } else if (state.loggedInUserRole === 'teamadmin') {
                 const adminSettings = state.logoutSettings[state.loggedInUser];
                 requiredClicks = (adminSettings && adminSettings.clickCount) ? parseInt(adminSettings.clickCount, 10) : 10;
            }

            if(requiredClicks <= 1) {
                performLogout();
                return;
            }

            logoutClickCounter++;
            
            clearTimeout(logoutClickTimer);
            logoutClickTimer = setTimeout(() => {
                logoutClickCounter = 0;
            }, 2000); 

            if (logoutClickCounter >= requiredClicks) {
                clearTimeout(logoutClickTimer);
                performLogout();
            }
        }


        function showAlert(message) {
            alert(message);
        }
        
        // --- Super Admin Functions ---
        function loginSuperAdmin() {
            const password = document.getElementById('superAdminPassword').value;
            if (password === state.superAdminPassword) {
                const user = {
                    id: 'superadmin',
                    role: 'superadmin'
                };
                localStorage.setItem('loggedInUser', JSON.stringify(user));
                
                state.loggedInUser = user.id;
                state.loggedInUserRole = user.role;
                
                renderSuperAdminDashboard();
                showPage('superAdminDashboard');
            } else {
                showAlert('Incorrect password!');
            }
        }

        async function createTeamAdmin() {
            const username = document.getElementById('newTeamAdminUsername').value.trim();
            const password = document.getElementById('newTeamAdminPassword').value.trim();
            if (!username || !password) {
                return showAlert('Username and password cannot be empty.');
            }
            if (state.teamAdmins.find(admin => admin.username === username)) {
                return showAlert('This username already exists.');
            }
            
            const newAdminData = { username, password, status: 'active' };
            await db.ref('teamAdmins').push(newAdminData);

            document.getElementById('newTeamAdminUsername').value = '';
            document.getElementById('newTeamAdminPassword').value = '';
            
            await getFullState();
            renderSuperAdminDashboard();
            showAlert('Team Admin created successfully!');
            showPage('superAdminDashboard');
        }

        async function saveUserCredentials(type, adminId, memberId = null) {
            const newUsername = prompt(`Enter new username for this ${type}:`);
            if (!newUsername) return; // User cancelled
            const newPassword = prompt(`Enter new password for this ${type}:`);
            if (!newPassword) return; // User cancelled


            if (!newUsername || !newPassword) {
                return showAlert('Username and password cannot be empty.');
            }

            try {
                if (type === 'admin') {
                    await db.ref(`teamAdmins/${adminId}`).update({ username: newUsername, password: newPassword });
                } else if (type === 'member' && memberId) {
                    await db.ref(`teamAdmins/${adminId}/teamMembers/${memberId}`).update({ username: newUsername, password: newPassword });
                }
                await getFullState();
                
                if (state.loggedInUserRole === 'superadmin') {
                    renderSuperAdminDashboard();
                } else if (state.loggedInUserRole === 'teamadmin') {
                    renderTeamAdminDashboard();
                }

                showAlert(`${type.charAt(0).toUpperCase() + type.slice(1)} credentials updated successfully!`);
            } catch (error) {
                console.error("Error updating credentials:", error);
                showAlert('Failed to update credentials.');
            }
        }
        
        async function deleteTeamAdmin(adminId, adminUsername) {
            if (confirm(`Are you sure you want to delete ${adminUsername}? This will also delete all their team members and sales reports.`)) {
                await db.ref(`teamAdmins/${adminId}`).remove();
                
                const reportsToDelete = state.salesReports.filter(r => r.team === adminUsername);
                const updates = {};
                reportsToDelete.forEach(r => {
                    updates[`/salesReports/${r.id}`] = null;
                });
                if(Object.keys(updates).length > 0) {
                    await db.ref().update(updates);
                }

                await getFullState();
                renderSuperAdminDashboard();
            }
        }

        async function toggleTeamAdminStatus(adminId) {
            const admin = state.teamAdmins.find(admin => admin.id === adminId);
            if (admin) {
                const newStatus = admin.status === 'active' ? 'deactivated' : 'active';
                await db.ref(`teamAdmins/${adminId}/status`).set(newStatus);
                await getFullState();
                renderSuperAdminDashboard();
            }
        }

        async function saveAdvertisements() {
            const popunder = document.getElementById('popunderAd').value.trim();
            const banner = document.getElementById('bannerAd').value.trim();
            const nativeBanner = document.getElementById('nativeBannerAd').value.trim();

            const newAds = { popunder, banner, nativeBanner };
            await db.ref('advertisements').set(newAds);
            
            state.advertisements = newAds;
            showAlert('Advertisements saved successfully!');
        }

        async function saveSuperAdminNotice() {
            const notice = document.getElementById('superAdminNotice').value;
            await db.ref('superAdminNotice').set(notice);
            state.superAdminNotice = notice;
            showAlert('Notice for team admins saved successfully!');
        }

        async function deleteSuperAdminNotice() {
             if (confirm('Are you sure you want to delete the notice for team admins?')) {
                await db.ref('superAdminNotice').remove();
                state.superAdminNotice = '';
                document.getElementById('superAdminNotice').value = '';
                showAlert('Notice deleted successfully.');
            }
        }
        
        async function changeSuperAdminPassword() {
            const newPassword = document.getElementById('newSuperAdminPassword').value;
            const confirmPassword = document.getElementById('confirmSuperAdminPassword').value;

            if (!newPassword || !confirmPassword) {
                return showAlert('Please fill in both password fields.');
            }
            if (newPassword !== confirmPassword) {
                return showAlert('Passwords do not match.');
            }
            if (newPassword.length < 6) {
                return showAlert('Password must be at least 6 characters long.');
            }

            await db.ref('superAdmin/password').set(newPassword);
            state.superAdminPassword = newPassword;
            
            document.getElementById('newSuperAdminPassword').value = '';
            document.getElementById('confirmSuperAdminPassword').value = '';

            showAlert('Super admin password changed successfully!');
        }


        function renderAdvertisementManagement() {
            document.getElementById('popunderAd').value = state.advertisements.popunder || '';
            document.getElementById('bannerAd').value = state.advertisements.banner || '';
            document.getElementById('nativeBannerAd').value = state.advertisements.nativeBanner || '';
        }

        function renderSuperAdminDashboard() {
            const teamAdminsList = document.getElementById('teamAdminsList');
            teamAdminsList.innerHTML = '';
            document.getElementById('teamAdminCount').innerText = state.teamAdmins.length;
            document.getElementById('superAdminNotice').value = state.superAdminNotice || '';


            if (state.teamAdmins.length === 0) {
                teamAdminsList.innerHTML = '<p class="text-gray-500">No team admins created yet.</p>';
            } else {
                state.teamAdmins.forEach(admin => {
                    const div = document.createElement('div');
                    div.className = 'p-3 border rounded';
                    
                    const statusClass = admin.status === 'active' ? 'text-green-600' : 'text-red-600';
                    const toggleButtonText = admin.status === 'active' ? 'Deactivate' : 'Activate';
                    const toggleButtonClass = admin.status === 'active' ? 'btn-warning' : 'btn-success';
                    
                    const members = admin.teamMembers && typeof admin.teamMembers === 'object' 
                        ? Object.keys(admin.teamMembers).map(key => ({id: key, ...admin.teamMembers[key]})) 
                        : [];
                    
                    let membersHtml = '<p class="text-sm text-gray-500 mt-2">No team members yet.</p>';
                    if (members.length > 0) {
                        membersHtml = `
                            <div class="mt-2 border-t pt-2 space-y-2">
                                ${members.map(member => `
                                    <div class="flex justify-between items-center text-sm p-1 bg-gray-50 rounded">
                                        <span>${member.name} (@${member.username})</span>
                                        <button onclick="saveUserCredentials('member', '${admin.id}', '${member.id}')" class="btn btn-secondary btn-sm">Edit</button>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }

                    div.innerHTML = `
                         <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                            <div class="mb-2 md:mb-0">
                                <span class="font-semibold">${admin.username}</span>
                                <span class="text-sm ml-2 ${statusClass}">(${admin.status || 'active'})</span>
                                <span class="text-sm ml-2 font-bold">(${members.length} Members)</span>
                            </div>
                            <div class="space-x-2 flex">
                                <button onclick="saveUserCredentials('admin', '${admin.id}')" class="btn btn-secondary btn-sm">Edit Admin</button>
                                <button onclick="toggleTeamAdminStatus('${admin.id}')" class="btn ${toggleButtonClass} btn-sm">${toggleButtonText}</button>
                                <button onclick="deleteTeamAdmin('${admin.id}', '${admin.username}')" class="btn btn-danger btn-sm">Delete</button>
                            </div>
                        </div>
                        <div class="mt-2">
                             <h4 class="text-sm font-semibold text-gray-700">Team Members:</h4>
                            ${membersHtml}
                        </div>
                    `;
                    teamAdminsList.appendChild(div);
                });
            }
            
            document.getElementById('newSuperAdminPassword').value = '';
            document.getElementById('confirmSuperAdminPassword').value = '';
            renderAdvertisementManagement();
        }


        // --- Team Admin Functions ---
        async function loginTeamAdmin() {
            const username = document.getElementById('teamAdminUsername').value.trim();
            const password = document.getElementById('teamAdminPassword').value.trim();
            const admin = state.teamAdmins.find(a => a.username === username && a.password === password);
            
            if (admin) {
                if (admin.status === 'deactivated') {
                    return showAlert('Your account has been deactivated. Please contact the super admin.');
                }
                const user = {
                    id: admin.id,
                    username: admin.username,
                    role: 'teamadmin'
                };
                localStorage.setItem('loggedInUser', JSON.stringify(user));

                state.loggedInUser = user.id;
                state.loggedInUserName = user.username;
                state.loggedInUserRole = user.role;
                
                await getFullState(); 
                renderTeamAdminDashboard();
                showPage('teamAdminDashboard');
                playAdminWelcomeVoice();
            } else {
                showAlert('Invalid username or password.');
            }
        }
        
        async function createTeamMember() {
            const name = document.getElementById('newTeamMemberName').value.trim();
            const username = document.getElementById('newTeamMemberUsername').value.trim();
            const password = document.getElementById('newTeamMemberPassword').value.trim();
            const adminId = state.loggedInUser;

            if (!name || !username || !password) {
                return showAlert('Name, username and password cannot be empty.');
            }
            
            let usernameExists = false;
            for(const admin of state.teamAdmins) {
                 if (admin.username === username) { // Check against admin usernames too
                    usernameExists = true;
                    break;
                }
                if (!admin.teamMembers || typeof admin.teamMembers !== 'object') continue;
                const members = Object.values(admin.teamMembers);
                if (members.some(m => m.username === username)) {
                    usernameExists = true;
                    break;
                }
            }
            
            if (usernameExists) {
                return showAlert('This username is already taken.');
            }
            
            const newMemberData = { name, username, password, status: 'active' };
            await db.ref(`teamAdmins/${adminId}/teamMembers`).push(newMemberData);
            
            document.getElementById('newTeamMemberName').value = '';
            document.getElementById('newTeamMemberUsername').value = '';
            document.getElementById('newTeamMemberPassword').value = '';
            
            await getFullState();
            renderTeamAdminDashboard();
            showAlert('Team Member created successfully!');
            showPage('teamAdminDashboard');
        }

        async function deleteTeamMember(memberId) {
            const adminId = state.loggedInUser;
            const admin = state.teamAdmins.find(a => a.id === adminId);
             if (!admin || !admin.teamMembers) return;
            
            const memberKey = Object.keys(admin.teamMembers).find(key => key === memberId);

            if (memberKey && confirm(`Are you sure you want to delete this member?`)) {
                 await db.ref(`teamAdmins/${adminId}/teamMembers/${memberKey}`).remove();
                 await getFullState();
                 renderTeamAdminDashboard();
            }
        }

        async function toggleTeamMemberStatus(memberId) {
            const adminId = state.loggedInUser;
            const admin = state.teamAdmins.find(a => a.id === adminId);
             if (!admin || !admin.teamMembers) return;

            const memberKey = Object.keys(admin.teamMembers).find(key => key === memberId);
            if (!memberKey) return;
            const member = admin.teamMembers[memberKey];

            if (member) {
                const newStatus = member.status === 'active' ? 'deactivated' : 'active';
                await db.ref(`teamAdmins/${adminId}/teamMembers/${memberKey}/status`).set(newStatus);
                await getFullState();
                renderTeamAdminDashboard();
            }
        }

        async function updateProductRate(productId, newRate) {
            if (newRate !== '' && !isNaN(newRate)) {
                await db.ref(`products/${productId}/rate`).set(parseFloat(newRate));
                await getFullState();
                filterProductsForAdmin(document.getElementById('adminProductSearch').value); 
            }
        }
        
        async function deleteProduct(productId, productName) {
             if (confirm(`Are you sure you want to delete the product "${productName}"? This action cannot be undone.`)) {
                await db.ref(`products/${productId}`).remove();
                await getFullState();
                filterProductsForAdmin('');
                renderCategoryManagement();
                showAlert('Product deleted successfully!');
            }
        }

        function filterProductsForAdmin(searchTerm) {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const filteredProducts = state.products.filter(product => 
                product.name.toLowerCase().includes(lowerCaseSearchTerm)
            );
            renderProductManagement(filteredProducts);
        }

        function renderProductManagement(productsToRender) {
            const container = document.getElementById('productListForAdmin');
            container.innerHTML = '';
            const products = productsToRender || state.products;

            if (products.length === 0) {
                container.innerHTML = '<p class="text-gray-500 p-4">No products found.</p>';
                return;
            }

            products.forEach((product) => {
                const div = document.createElement('div');
                div.className = 'p-3 border-b grid grid-cols-1 md:grid-cols-4 items-center gap-4';
                div.innerHTML = `
                    <span class="font-semibold col-span-1 md:col-span-2">${product.name}</span>
                    <input 
                        type="number" 
                        value="${product.rate.toFixed(2)}" 
                        onchange="updateProductRate('${product.id}', this.value)"
                        class="input-field !mb-0 text-right"
                    >
                    <button onclick="deleteProduct('${product.id}', '${product.name.replace(/'/g, "\\'")}')" class="btn btn-danger btn-sm">Delete</button>
                `;
                container.appendChild(div);
            });
        }
        
        async function addNewProduct() {
            const name = document.getElementById('newProductName').value.trim();
            const rate = parseFloat(document.getElementById('newProductRate').value);
            const category = document.getElementById('newProductCategory').value.trim();

            if (!name || isNaN(rate)) {
                return showAlert('Please fill in Product Name and Rate.');
            }
             if (!category) {
                 return showAlert('Please add a category for the product.');
            }
            if (state.products.find(p => p.name.toLowerCase() === name.toLowerCase())) {
                return showAlert('A product with this name already exists.');
            }
            
            const newProductData = { name, rate, category };
            await db.ref('products').push(newProductData);
                        
            document.getElementById('newProductName').value = '';
            document.getElementById('newProductRate').value = '';
            document.getElementById('newProductCategory').value = '';
            
            await getFullState();
            filterProductsForAdmin(''); // Re-render product list
            renderCategoryManagement(); // Refresh category lists
            showAlert('New product added successfully!');
        }
        
        async function saveTeamAdminNotice() {
            const adminId = state.loggedInUser;
            const notice = document.getElementById('teamAdminNotice').value;
            await db.ref(`notices/${adminId}`).set(notice);
            state.notices[adminId] = notice;
            showAlert('Notice for team members saved successfully!');
        }

        async function deleteTeamAdminNotice() {
            const adminId = state.loggedInUser;
            if (confirm('Are you sure you want to delete the notice for your team members?')) {
                await db.ref(`notices/${adminId}`).remove();
                state.notices[adminId] = '';
                document.getElementById('teamAdminNotice').value = '';
                showAlert('Notice deleted successfully.');
            }
        }
        
        function setupToggle(buttonId, sectionId, showByDefault = false) {
             const button = document.getElementById(buttonId);
             const section = document.getElementById(sectionId);
             if(!button || !section) return;

             let isVisible = showByDefault;
             const updateVisibility = () => {
                section.style.display = isVisible ? 'block' : 'none';
                button.innerText = isVisible ? '[Hide]' : '[Show]';
             }
             updateVisibility();

             button.addEventListener('click', () => {
                isVisible = !isVisible;
                updateVisibility();
             });
        }
        
        function setupAccordion() {
            const manager = document.getElementById('allSectionsManager');
            if (!manager) return;

            const headers = manager.querySelectorAll('.accordion-header');
            const contents = manager.querySelectorAll('.accordion-content');
            const toggleAllBtn = document.getElementById('toggleAllSectionsBtn');

            headers.forEach((header, index) => {
                header.addEventListener('click', () => {
                    const content = contents[index];
                    const isVisible = content.style.display === 'block';

                    // Close all sections
                    contents.forEach(c => c.style.display = 'none');

                    // Open the clicked section if it was closed
                    if (!isVisible) {
                        content.style.display = 'block';
                    }
                });
            });

            toggleAllBtn.addEventListener('click', () => {
                const areAnyOpen = Array.from(contents).some(c => c.style.display === 'block');
                const newDisplayState = areAnyOpen ? 'none' : 'block';
                contents.forEach(c => c.style.display = newDisplayState);
            });
        }


        function renderTeamAdminDashboard() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
            document.getElementById('reportStartDate').value = today;
            document.getElementById('reportEndDate').value = today;
            document.getElementById('categoryReportStartDate').value = today;
            document.getElementById('categoryReportEndDate').value = today;
            
            document.getElementById('loggedInTeamAdminUsername').innerText = state.loggedInUserName;
            const admin = state.teamAdmins.find(a => a.id === state.loggedInUser);
            if (!admin) return;

            const superAdminNoticeContainer = document.getElementById('superAdminNoticeContainerForAdmin');
            if (state.superAdminNotice) {
                superAdminNoticeContainer.innerHTML = `
                    <div class="p-4 mb-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700">
                        <p class="font-bold">Notice from Super Admin</p>
                        <marquee behavior="scroll" direction="left">${state.superAdminNotice}</marquee>
                    </div>`;
            } else {
                superAdminNoticeContainer.innerHTML = '';
            }

            document.getElementById('teamAdminNotice').value = state.notices[admin.id] || '';

            const teamMembersList = document.getElementById('teamMembersList');
            teamMembersList.innerHTML = '';
            
            const members = admin.teamMembers && typeof admin.teamMembers === 'object' 
                ? Object.keys(admin.teamMembers).map(key => ({id: key, ...admin.teamMembers[key]})) 
                : [];

            if (members.length === 0) {
                 teamMembersList.innerHTML = '<p class="text-gray-500">No team members created yet.</p>';
            } else {
                members.forEach(member => {
                    const div = document.createElement('div');
                    div.className = 'p-3 border rounded flex flex-col md:flex-row justify-between items-start md:items-center';
                    const statusClass = member.status === 'active' ? 'text-green-600' : 'text-red-600';
                    const toggleButtonText = member.status === 'active' ? 'Deactivate' : 'Activate';
                    const toggleButtonClass = member.status === 'active' ? 'btn-warning' : 'btn-success';

                    div.innerHTML = `
                         <div class="mb-2 md:mb-0">
                            <span class="font-semibold">${member.name}</span> (@${member.username})
                            <span class="text-sm ml-2 ${statusClass}">(${member.status || 'active'})</span>
                        </div>
                        <div class="space-x-2 flex">
                            <button onclick="saveUserCredentials('member', '${admin.id}', '${member.id}')" class="btn btn-secondary btn-sm">Edit</button>
                            <button onclick="toggleTeamMemberStatus('${member.id}')" class="btn ${toggleButtonClass} btn-sm">${toggleButtonText}</button>
                            <button onclick="deleteTeamMember('${member.id}')" class="btn btn-danger btn-sm">Delete</button>
                        </div>
                    `;
                    teamMembersList.appendChild(div);
                });
            }

            // Populate member and product dropdowns for reports
            const reportMemberSelect = document.getElementById('reportMemberSelect');
            const reportProductSelect = document.getElementById('reportProductSelect');
            reportMemberSelect.innerHTML = '<option value="all">All Members</option>';
            members.forEach(member => {
                reportMemberSelect.innerHTML += `<option value="${member.username}">${member.name}</option>`;
            });
            reportProductSelect.innerHTML = '<option value="all">All Products</option>';
            state.products.forEach(product => {
                reportProductSelect.innerHTML += `<option value="${product.name}">${product.name}</option>`;
            });

            // Populate category wise report member dropdown
            const categoryMemberSelect = document.getElementById('categoryReportMemberSelect');
            categoryMemberSelect.innerHTML = '<option value="all">All Members</option>';
            members.forEach(member => {
                categoryMemberSelect.innerHTML += `<option value="${member.username}">${member.name}</option>`;
            });


            setupAccordion();
            setupToggle('toggleCategoryWiseReport', 'categoryWiseReportSection', false);


            document.getElementById('adminProductSearch').value = '';
            renderProductManagement(state.products);
            renderNotificationSettings();
            renderLogoutSettings();
            renderCategoryManagement();
            renderVoiceSettings();
            
            renderTeamAdminReports();
            renderCategoryWiseReport();
        }

        function copyNotSubmittedNames() {
            const namesText = document.getElementById('notSubmittedNames').value;
            if (namesText) {
                navigator.clipboard.writeText(namesText).then(() => {
                    showAlert('Names copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy names: ', err);
                    showAlert('Failed to copy names.');
                });
            }
        }
        
        async function copyTable() {
            const table = document.getElementById('reportTable');
            try {
                let text = '';
                for (const row of table.rows) {
                    let rowText = [];
                    for(const cell of row.cells) {
                        rowText.push(cell.innerText);
                    }
                    text += rowText.join('\t') + '\n';
                }
                await navigator.clipboard.writeText(text);
                showAlert('Table data copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy table: ', err);
                showAlert('Failed to copy table. This feature may not be supported on your browser.');
            }
        }


        function getReportDataForDateRange(startDateStr, endDateStr, selectedMember, selectedProduct) {
            const admin = state.teamAdmins.find(a => a.id === state.loggedInUser);
            if (!admin) return { productData: {}, reportingMembers: [], grandTotalAmount: 0 };

            let reportingMembers = admin.teamMembers && typeof admin.teamMembers === 'object'
                ? Object.values(admin.teamMembers).filter(m => m.status === 'active') 
                : [];
            
            const startDate = new Date(startDateStr);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(endDateStr);
            endDate.setHours(23, 59, 59, 999);

            let reportsForDateRange = state.salesReports.filter(r => {
                const reportDate = new Date(r.date).getTime();
                return r.team === state.loggedInUserName && reportDate >= startDate.getTime() && reportDate <= endDate.getTime();
            });
            
            // Filter by member
            if (selectedMember && selectedMember !== 'all') {
                reportsForDateRange = reportsForDateRange.filter(r => r.submittedBy === selectedMember);
                reportingMembers = reportingMembers.filter(m => m.username === selectedMember);
            }

            const productData = {};
            const productsToList = (selectedProduct && selectedProduct !== 'all') ? state.products.filter(p => p.name === selectedProduct) : state.products;

            productsToList.forEach(product => {
                productData[product.name] = { 
                    rate: product.rate, 
                    members: {} 
                };
                reportingMembers.forEach(m => {
                    productData[product.name].members[m.name] = { tgt: 0, sales: 0, amount: 0 };
                });
            });

            let grandTotalAmount = 0;
            reportsForDateRange.forEach(report => {
                const member = reportingMembers.find(m => m.username === report.submittedBy);
                if (member && report.reportData && report.reportData.items) {
                    report.reportData.items.forEach(item => {
                        if (productData[item.name]) {
                            const productInfo = state.products.find(p => p.name === item.name);
                            const itemRate = productInfo ? productInfo.rate : item.rate;
                            const itemAmount = item.sales * itemRate;

                            productData[item.name].members[member.name].tgt += item.tgt;
                            productData[item.name].members[member.name].sales += item.sales;
                            productData[item.name].members[member.name].amount += itemAmount;
                        }
                    });
                }
            });
            
             // Calculate grand total from aggregated data
            Object.values(productData).forEach(pData => {
                Object.values(pData.members).forEach(mData => {
                    grandTotalAmount += mData.amount;
                });
            });

            return { productData, reportingMembers, grandTotalAmount };
        }
        
        function renderTeamAdminReportsForDateRange() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const member = document.getElementById('reportMemberSelect').value;
            const product = document.getElementById('reportProductSelect').value;
            if (!startDate || !endDate) {
                return showAlert('Please select both a start and end date.');
            }
            if (new Date(startDate) > new Date(endDate)) {
                return showAlert('Start date cannot be after end date.');
            }
            renderTeamAdminReports(startDate, endDate, member, product);
        }

        function renderTeamAdminReports(startDate, endDate, selectedMember, selectedProduct) {
            const isFiltered = startDate && endDate;
            const selectedDateValue = startDate || document.getElementById('reportDate').value;
            
            const { productData, reportingMembers } = isFiltered
                ? getReportDataForDateRange(startDate, endDate, selectedMember, selectedProduct)
                : getReportDataForDateRange(selectedDateValue, selectedDateValue, 'all', 'all');

            const admin = state.teamAdmins.find(a => a.id === state.loggedInUser);
            const allMembers = admin.teamMembers && typeof admin.teamMembers === 'object' 
                ? Object.values(admin.teamMembers).filter(m => m.status === 'active') 
                : [];
            
            // Submission status check for single day, non-filtered report
            if (!isFiltered) {
                 const reportsForDate = state.salesReports.filter(r => {
                    const reportDate = new Date(r.date);
                    const selectedDate = new Date(selectedDateValue);
                    return r.team === state.loggedInUserName &&
                           reportDate.getFullYear() === selectedDate.getFullYear() &&
                           reportDate.getMonth() === selectedDate.getMonth() &&
                           reportDate.getDate() === selectedDate.getDate();
                });
                const submittedMemberUsernames = new Set(reportsForDate.map(r => r.submittedBy));
                const notSubmittedMembers = allMembers.filter(m => !submittedMemberUsernames.has(m.username));

                const statusContainer = document.getElementById('reportSubmissionStatus');
                const totalMembers = allMembers.length;
                const submittedCount = submittedMemberUsernames.size;
                let notSubmittedNames = notSubmittedMembers.map(m => m.name).join(', ');
                if (notSubmittedNames) {
                    notSubmittedNames = "যারা এখনো রিপোর্ট দেননি তাদের নাম দেয়া হলো, অনুগ্রহ পূর্বক রিপোর্ট দেন !!! " + notSubmittedNames;
                }

                statusContainer.innerHTML = `
                    <p class="font-bold">Total Members: ${totalMembers} | Submitted: ${submittedCount} | Not Submitted: ${notSubmittedMembers.length}</p>
                    ${notSubmittedMembers.length > 0 ? `
                        <div class="mt-2">
                            <label for="notSubmittedNames" class="font-semibold">Members who did not submit:</label>
                            <div class="flex items-center">
                                <textarea id="notSubmittedNames" readonly class="input-field !mb-0 flex-grow" rows="2">${notSubmittedNames}</textarea>
                                <button onclick="copyNotSubmittedNames()" class="btn btn-secondary ml-2">Copy</button>
                            </div>
                        </div>
                    ` : '<p class="mt-2 text-green-600 font-semibold">All active members have submitted their reports!</p>'}
                `;
            } else {
                 document.getElementById('reportSubmissionStatus').innerHTML = `<p class="font-bold">Displaying filtered report.</p>`;
            }

            const memberRow = document.getElementById('memberRow');
            const subHeaderRow = document.getElementById('subHeaderRow');
            const tableBody = document.getElementById('tableBody');
            const tableFoot = document.getElementById('tableFoot');

            if (Object.keys(productData).length === 0) {
                memberRow.innerHTML = '';
                subHeaderRow.innerHTML = '';
                tableBody.innerHTML = '<tr><td colspan="100%" class="p-4 text-center text-gray-500">No data available for the selected criteria.</td></tr>';
                tableFoot.innerHTML = '';
                return;
            }

            memberRow.innerHTML = '<th rowspan="2">SL</th><th rowspan="2" style="white-space: normal;">Product</th><th rowspan="2">Rate</th>';
            subHeaderRow.innerHTML = '';

            reportingMembers.forEach(m => {
                memberRow.innerHTML += `<th colspan="3">${m.name}</th>`;
                subHeaderRow.innerHTML += '<th>TGT</th><th>Sales</th><th>Amount</th>';
            });
            memberRow.innerHTML += `<th colspan="3" class="summary-header">Summary</th>`;
            subHeaderRow.innerHTML += '<th class="summary-header">TGT</th><th class="summary-header">Sales</th><th class="summary-header">Amount</th>';

            tableBody.innerHTML = '';
            const productsToList = (selectedProduct && selectedProduct !== 'all') ? state.products.filter(p => p.name === selectedProduct) : state.products;

            productsToList.forEach((product, index) => {
                const productName = product.name;
                if (!productData[productName]) return; // Skip if no data for this product in the filtered set

                const productInfo = productData[productName];
                let rowHtml = `<tr><td>${index + 1}</td><td style="white-space: normal;">${productName}</td><td>${productInfo.rate.toFixed(2)}</td>`;
                let summaryTgt = 0, summarySales = 0, summaryAmount = 0;

                reportingMembers.forEach(member => {
                    const data = productInfo.members[member.name] || { tgt: 0, sales: 0, amount: 0 };
                    rowHtml += `<td>${data.tgt}</td><td>${data.sales}</td><td>${Math.round(data.amount)}</td>`;
                    summaryTgt += data.tgt;
                    summarySales += data.sales;
                    summaryAmount += data.amount;
                });

                rowHtml += `<td class="summary-col">${summaryTgt}</td><td class="summary-col">${summarySales}</td><td class="summary-col">${Math.round(summaryAmount)}</td>`;
                rowHtml += `</tr>`;
                tableBody.innerHTML += rowHtml;
            });

            tableFoot.innerHTML = '';
            let footerHtml = '<tr><td colspan="3"><b>Total</b></td>';
            const memberTotals = {};
            reportingMembers.forEach(m => { memberTotals[m.name] = { tgt: 0, sales: 0, amount: 0 }; });
            let grandTotal = { tgt: 0, sales: 0, amount: 0 };
            
            productsToList.forEach(product => {
                if (!productData[product.name]) return;
                const productInfo = productData[product.name];
                reportingMembers.forEach(member => {
                    const data = productInfo.members[member.name] || { tgt: 0, sales: 0, amount: 0 };
                    memberTotals[member.name].tgt += data.tgt;
                    memberTotals[member.name].sales += data.sales;
                    memberTotals[member.name].amount += data.amount;
                });
            });

            reportingMembers.forEach(member => {
                footerHtml += `<td><b>${memberTotals[member.name].tgt}</b></td><td><b>${memberTotals[member.name].sales}</b></td><td><b>${Math.round(memberTotals[member.name].amount)}</b></td>`;
                grandTotal.tgt += memberTotals[member.name].tgt;
                grandTotal.sales += memberTotals[member.name].sales;
                grandTotal.amount += memberTotals[member.name].amount;
            });

            footerHtml += `<td class="summary-col"><b>${grandTotal.tgt}</b></td><td class="summary-col"><b>${grandTotal.sales}</b></td><td class="summary-col"><b>${Math.round(grandTotal.amount)}</b></td>`;
            footerHtml += '</tr>';
            tableFoot.innerHTML = footerHtml;
        }

        function exportReportToExcel() {
            const table = document.getElementById('reportTable');
            if (!table || table.querySelector('td')?.innerText.includes('No data')) {
                 return showAlert('No data available to export.');
            }
            const wb = XLSX.utils.table_to_book(table, {sheet: "Report"});
            
            const selectedDate = document.getElementById('reportDate').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            let fileName = `SalesReport_${selectedDate}.xlsx`;
            if (startDate && endDate && (startDate !== selectedDate || endDate !== selectedDate)) {
                 fileName = `SalesReport_${startDate}_to_${endDate}.xlsx`;
            }

            XLSX.writeFile(wb, fileName);
        }

        // --- Team Member Functions ---
        async function loginTeamMember() {
            const username = document.getElementById('teamMemberUsername').value.trim();
            const password = document.getElementById('teamMemberPassword').value.trim();
            
            let foundMember = null;
            let teamAdminInfo = null;

            for (const admin of state.teamAdmins) {
                if (admin.teamMembers && typeof admin.teamMembers === 'object') {
                    const memberKey = Object.keys(admin.teamMembers).find(key => 
                        admin.teamMembers[key].username === username && admin.teamMembers[key].password === password
                    );
                    if(memberKey){
                        foundMember = {id: memberKey, ...admin.teamMembers[memberKey]};
                        teamAdminInfo = {id: admin.id, username: admin.username, status: admin.status };
                        break;
                    }
                }
            }

            if (foundMember) {
                 if (foundMember.status === 'deactivated') {
                    return showAlert('Your account has been deactivated. Please contact your team admin.');
                }
                if (teamAdminInfo.status === 'deactivated') {
                    return showAlert('Your team is currently deactivated. Please contact the super admin.');
                }
                const user = {
                    id: foundMember.id,
                    name: foundMember.name,
                    username: foundMember.username,
                    team: teamAdminInfo.username,
                    teamId: teamAdminInfo.id,
                    role: 'teammember'
                };
                localStorage.setItem('loggedInUser', JSON.stringify(user));

                state.loggedInUser = user.id;
                state.loggedInUserName = user.name;
                state.loggedInUserUsername = user.username; 
                state.loggedInUserRole = user.role;
                state.loggedInUserTeam = user.team;
                state.loggedInUserTeamId = teamAdminInfo.id;
                
                await getFullState();
                renderTeamMemberDashboard();
                showPage('teamMemberDashboard');
                playWelcomeVoice('member');
            } else {
                showAlert('Invalid username or password.');
            }
        }
        
        function updateAmountOnRow(productId) {
            const product = state.products.find(p => p.id === productId);
            if (!product) return;

            const rate = product.rate;
            const salesInput = document.getElementById(`sales-${productId}`);
            const amountCell = document.getElementById(`amount-${productId}`);
            
            if (salesInput && amountCell) {
                const sales = parseFloat(salesInput.value) || 0;
                const amount = rate * sales;
                amountCell.innerText = Math.round(amount);
            }
        }

        function addItemsFromProductListToReport(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let itemsToAdd = [];

            const productRows = container.querySelectorAll('tr[data-product-id]');
            
            productRows.forEach(row => {
                 const productId = row.dataset.productId;
                 const product = state.products.find(p => p.id === productId);
                 if(!product) return;

                 const tgtInput = document.getElementById(`tgt-${productId}`);
                 const salesInput = document.getElementById(`sales-${productId}`);
                 
                 const tgt = parseFloat(tgtInput.value) || 0;
                 const sales = parseFloat(salesInput.value) || 0;

                 if (tgt > 0 || sales > 0) {
                     const rate = product.rate;
                     const amount = rate * sales;
                     
                     if (state.currentReportItems.find(item => item.name === product.name)) {
                        showAlert(`Product "${product.name}" is already in the report. Please remove the existing one to add again.`);
                        itemsToAdd = []; // stop processing
                        return;
                    }

                    itemsToAdd.push({
                        name: product.name,
                        rate: rate,
                        tgt: tgt,
                        sales: sales,
                        amount: amount
                    });
                 }
            });


            if(itemsToAdd.length > 0) {
                state.currentReportItems.push(...itemsToAdd);
                renderCurrentReportItems();
                // Clear the inputs after adding
                productRows.forEach(row => {
                    const productId = row.dataset.productId;
                    const tgtInput = document.getElementById(`tgt-${productId}`);
                    const salesInput = document.getElementById(`sales-${productId}`);
                    const amountCell = document.getElementById(`amount-${productId}`);
                    if (tgtInput) tgtInput.value = '';
                    if (salesInput) salesInput.value = '';
                    if (amountCell) amountCell.innerText = '0';
                });

                showAlert(`${itemsToAdd.length} item(s) added to the report.`);
            } else {
                showAlert('Please enter TGT or Sales for at least one product.');
            }
        }


        function removeItemFromReport(index) {
            state.currentReportItems.splice(index, 1);
            renderCurrentReportItems();
        }

        function renderCurrentReportItems() {
            const itemsContainer = document.getElementById('currentReportItems');
            itemsContainer.innerHTML = '';
            
            if (!state.currentReportItems || state.currentReportItems.length === 0) {
                 itemsContainer.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">No items added yet.</td></tr>';
                 return;
            }

            state.currentReportItems.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td class="text-right">${item.tgt}</td>
                    <td class="text-right">${item.sales}</td>
                    <td class="text-right">${Math.round(item.amount)}</td>
                    <td class="text-center">
                        <button onclick="removeItemFromReport(${index})" class="btn btn-danger btn-sm">Remove</button>
                    </td>
                `;
                itemsContainer.appendChild(tr);
            });
        }

        async function submitSalesReport() {
            const currentHour = new Date().getHours();
            if (currentHour >= 23) { // 23 is 11 PM in 24-hour format
                return showAlert('You cannot submit reports after 11 PM. Please submit your report on time tomorrow.');
            }

            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);

            if (!state.loggedInUserUsername) return showAlert('Could not verify your user. Please log out and log in again.');

            const hasSubmittedToday = state.salesReports.some(r => 
                r.submittedBy === state.loggedInUserUsername && new Date(r.date) >= todayStart
            );

            if (hasSubmittedToday) {
                return showAlert('You have already submitted your report for today. You can delete the existing one to submit a new one.');
            }

            if (state.currentReportItems.length === 0) {
                return showAlert('Please add at least one product to the report.');
            }

            const grandTotal = state.currentReportItems.reduce((sum, item) => sum + item.amount, 0);

            const reportData = {
                agentName: state.loggedInUserName,
                items: [...state.currentReportItems],
                grandTotal: grandTotal,
            };
            
            const newReport = {
                reportData: reportData,
                submittedBy: state.loggedInUserUsername,
                team: state.loggedInUserTeam,
                date: new Date().toISOString()
            };
            
            await db.ref('salesReports').push(newReport);
            
            state.currentReportItems = [];
            
            playVoice("ধন্যবাদ, আপনি সফলভাবে আজকের রিপোর্ট সাবমিট করেছেন", 'bn-BD', true);
            showAlert('Report submitted successfully!');

            // Show popunder ad
            if(state.advertisements.popunder) {
                window.open(state.advertisements.popunder, '_blank');
            }

            await getFullState();
            renderTeamMemberDashboard();
        }

        async function deleteMyReport(reportId) {
            const currentHour = new Date().getHours();
            if (currentHour >= 23) {
                return showAlert('You cannot delete reports after 11 PM.');
            }
             if (confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
                await db.ref(`salesReports/${reportId}`).remove();
                await getFullState();
                renderTeamMemberDashboard();
            }
        }
        
        function renderProductTableForMember(products, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            if (!products || products.length === 0) {
                container.innerHTML = '<p class="p-4 text-center text-gray-500">No products found.</p>';
                return;
            }

            // Sort products based on their order in state.products
            const sortedProducts = products.sort((a, b) => {
                const indexA = state.products.findIndex(p => p.id === a.id);
                const indexB = state.products.findIndex(p => p.id === b.id);
                return indexA - indexB;
            });


            let tableHtml = '<table class="w-full grouped-product-table"><thead><tr><th>Product</th><th>TGT</th><th>Sales</th><th class="text-right">Amount</th></tr></thead><tbody>';

            sortedProducts.forEach(p => {
                tableHtml += `
                    <tr data-product-id="${p.id}">
                        <td>${p.name}</td>
                        <td><input type="number" id="tgt-${p.id}" class="inline-input" placeholder="TGT"></td>
                        <td><input type="number" id="sales-${p.id}" class="inline-input" placeholder="Sales" oninput="updateAmountOnRow('${p.id}')"></td>
                        <td class="text-right" id="amount-${p.id}">0</td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';

            const uniqueId = `product-list-container-${Date.now()}`;
            const wrapperDiv = document.createElement('div');
            wrapperDiv.id = uniqueId;
            wrapperDiv.innerHTML = tableHtml + `<div class="text-center mt-4"><button onclick="addItemsFromProductListToReport('${uniqueId}')" class="neon-glow-btn">Add to Report</button></div>`;
            container.appendChild(wrapperDiv);
        }

        function handleCategorySelect(categoryKey) {
            document.getElementById('memberProductSearch').value = '';
            const container = document.getElementById('memberProductListContainer');
            container.innerHTML = '';
            if (categoryKey) {
                let products;
                if (categoryKey === 'All') {
                    products = [...state.products];
                } else {
                    products = state.products.filter(p => p.category === categoryKey);
                }
                renderProductTableForMember(products, 'memberProductListContainer');
            }
        }
        
        function handleProductSearchForMember(searchTerm) {
            document.getElementById('productCategorySelect').value = ''; // Reset category dropdown
            const container = document.getElementById('memberProductListContainer');
            container.innerHTML = '';
            const lowerCaseSearchTerm = searchTerm.toLowerCase();

            if (lowerCaseSearchTerm.length > 1) {
                const filteredProducts = state.products.filter(product => 
                    product.name.toLowerCase().includes(lowerCaseSearchTerm)
                );
                renderProductTableForMember(filteredProducts, 'memberProductListContainer');
            }
        }

        function renderTeamMemberDashboard() {
            const today = new Date().toISOString().split('T')[0];

            document.getElementById('loggedInTeamMemberName').innerText = state.loggedInUserName;
            
            const noticeContainer = document.getElementById('teamAdminNoticeContainer');
            const teamNotice = state.notices[state.loggedInUserTeamId] || '';
            if (teamNotice) {
                noticeContainer.innerHTML = `
                     <div class="border-b border-gray-300 pb-2 mb-4">
                        <p class="font-semibold flex items-center">
                             Notice: <marquee behavior="scroll" direction="left" class="ml-2 text-red-600">${teamNotice}</marquee>
                        </p>
                    </div>`;
            } else {
                noticeContainer.innerHTML = '';
            }
            
            const categorySelect = document.getElementById('productCategorySelect');
            const uniqueCategories = [...new Set(state.products.map(p => p.category).filter(Boolean))].sort();
            categorySelect.innerHTML = '<option value="">-- Select a Category --</option><option value="All">All</option>';
            uniqueCategories.forEach(cat => {
                categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            
            document.getElementById('memberProductSearch').value = '';
            document.getElementById('memberProductListContainer').innerHTML = '';


            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);
            const hasSubmittedToday = state.salesReports.some(r => 
                r.submittedBy === state.loggedInUserUsername && new Date(r.date) >= todayStart
            );
            document.getElementById('submitReportContainer').style.display = hasSubmittedToday ? 'none' : 'block';

            const mySalesReportsList = document.getElementById('mySalesReportsList');
            mySalesReportsList.innerHTML = '';
            const myReports = state.salesReports.filter(report => report.submittedBy === state.loggedInUserUsername);

            if (myReports.length === 0) {
                 mySalesReportsList.innerHTML = '<p class="text-gray-500">You have not submitted any reports yet.</p>';
            } else {
                [...myReports].reverse().forEach(report => {
                    const div = document.createElement('div');
                    div.className = 'p-3 border rounded';
                    
                    const reportDate = new Date(report.date);
                    const isToday = reportDate.getFullYear() === todayStart.getFullYear() &&
                                  reportDate.getMonth() === todayStart.getMonth() &&
                                  reportDate.getDate() === todayStart.getDate();
                                  
                    const canDelete = isToday && new Date().getHours() < 23;

                    div.innerHTML = `
                        <div class="flex flex-col md:flex-row justify-between items-start mb-2">
                            <div class="mb-2 md:mb-0">
                                <p><b>Agent:</b> ${report.reportData.agentName}</p>
                                <p class="text-sm text-gray-500 mt-1">Submitted on: ${new Date(report.date).toLocaleString()}</p>
                            </div>
                            <div>
                                ${canDelete ? `<button onclick="deleteMyReport('${report.id}')" class="btn btn-danger btn-sm">Delete</button>` : ''}
                            </div>
                        </div>
                        <div class="border rounded-lg overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-2">Product Name</th>
                                        <th class="p-2 text-right">TGT</th>
                                        <th class="p-2 text-right">Sales</th>
                                        <th class="p-2 text-right">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(report.reportData.items || []).map(item => `
                                        <tr>
                                            <td class="p-2">${item.name}</td>
                                            <td class="p-2 text-right">${item.tgt}</td>
                                            <td class="p-2 text-right">${item.sales}</td>
                                            <td class="p-2 text-right">${Math.round(item.amount)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot class="font-bold bg-gray-100">
                                    <tr>
                                        <td colspan="3" class="p-2 text-right">Grand Total:</td>
                                        <td class="p-2 text-right">${Math.round(report.reportData.grandTotal)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
                    mySalesReportsList.appendChild(div);
                });
            }
            state.currentReportItems = [];
            renderCurrentReportItems();
        }
        
        function renderAdvertisements(pageId) {
            const adContainer = document.getElementById('adContainer');
            adContainer.innerHTML = '';
            if (pageId === 'superAdminDashboard') {
                return; 
            }

            let adHtml = '';
            if(state.advertisements.banner) {
                adHtml += `<img src="${state.advertisements.banner}" alt="Banner Ad" class="mx-auto my-2" style="max-width: 100%; height: auto;">`;
            }
            if(state.advertisements.nativeBanner) {
                adHtml += `<img src="${state.advertisements.nativeBanner}" alt="Native Banner Ad" class="mx-auto my-2" style="max-width: 100%; height: auto;">`;
            }

            adContainer.innerHTML = adHtml;
        }

        // --- Notification and Voice System ---
        function playVoice(text, lang = 'en-US', isFemale = true, onEndCallback) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                utterance.rate = 0.9;
                
                if (onEndCallback) {
                    utterance.onend = onEndCallback;
                }
                
                const voices = window.speechSynthesis.getVoices();
                let chosenVoice = null;

                if (lang === 'bn-BD') {
                    chosenVoice = voices.find(v => v.lang === 'bn-BD' && v.name.includes('Female'));
                    if (!chosenVoice) {
                        chosenVoice = voices.find(v => v.lang === 'bn-BD');
                    }
                } else if (isFemale) {
                    chosenVoice = voices.find(v => v.name.includes('Female') || v.name.includes('Google UK English Female'));
                }
                
                if(chosenVoice) {
                    utterance.voice = chosenVoice;
                }
                
                window.speechSynthesis.cancel(); // Stop any previous speech
                window.speechSynthesis.speak(utterance);
            } else {
                console.log("Speech synthesis not supported.");
                 if (onEndCallback) {
                    onEndCallback();
                }
            }
        }

        async function playAdminWelcomeVoice() {
            playVoice("Welcome admin", 'en-US', false);

            const today = new Date().toISOString().split('T')[0];
            const { grandTotalAmount } = getReportDataForDateRange(today, today, 'all', 'all');
            
             const admin = state.teamAdmins.find(a => a.id === state.loggedInUser);
            const allMembers = admin.teamMembers && typeof admin.teamMembers === 'object' ? Object.values(admin.teamMembers).filter(m => m.status === 'active') : [];
             const reportsForDate = state.salesReports.filter(r => {
                const reportDate = new Date(r.date);
                const selectedDate = new Date(today);
                return r.team === state.loggedInUserName &&
                       reportDate.getFullYear() === selectedDate.getFullYear() &&
                       reportDate.getMonth() === selectedDate.getMonth() &&
                       reportDate.getDate() === selectedDate.getDate();
            });
            const submittedMemberUsernames = new Set(reportsForDate.map(r => r.submittedBy));
            const notSubmittedMembers = allMembers.filter(m => !submittedMemberUsernames.has(m.username));


            const adminSettings = state.voiceSettings[state.loggedInUser] || {};
            const repeatCount = parseInt(adminSettings.repeatCount, 10) || 1;

            let fullMessage = "";
            if (notSubmittedMembers.length > 0) {
                fullMessage += `${notSubmittedMembers.length} members have not submitted the report yet. `;
            } else {
                fullMessage += `All members have submitted their reports. `;
            }
            fullMessage += `Today's grand total amount is ${Math.round(grandTotalAmount)}.`;

            let repeatCounter = 0;
            const playRepeatedly = () => {
                if (repeatCounter < repeatCount) {
                    repeatCounter++;
                    playVoice(fullMessage, 'en-US', false, playRepeatedly);
                }
            };
            
            setTimeout(() => {
                playRepeatedly();
            }, 2000);
        }

        async function playWelcomeVoice(role) {
             if (role === 'member') {
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                const hasSubmittedToday = state.salesReports.some(r => 
                    r.submittedBy === state.loggedInUserUsername && new Date(r.date) >= todayStart
                );

                if (!hasSubmittedToday) {
                    setTimeout(() => {
                        playVoice("আপনি আজকের রিপোর্ট এখনো সাবমিট করেননি, তাই আপনাকে স্মরণ করানো হলো", 'bn-BD', true);
                    }, 5000); 
                }
            }
        }
        
        function unlockAudio() {
            if ('speechSynthesis' in window) {
                const voices = window.speechSynthesis.getVoices();
                if (voices.length === 0) {
                     const utterance = new SpeechSynthesisUtterance('');
                    utterance.volume = 0;
                    window.speechSynthesis.speak(utterance);
                }
            }
        }

        if (window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = unlockAudio;
        }

        function startMemberAlarmSystem() {
            if (alarmIntervalId) clearInterval(alarmIntervalId); 

            alarmIntervalId = setInterval(async () => {
                const settings = state.notificationSettings[state.loggedInUserTeamId];
                if (!settings || !settings.enabled) return;

                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                
                const salesReportsSnapshot = await db.ref('salesReports').once('value');
                const liveSalesReportsData = salesReportsSnapshot.val() || {};
                const liveSalesReports = Object.values(liveSalesReportsData);

                const hasSubmittedToday = liveSalesReports.some(r => 
                    r.submittedBy === state.loggedInUserUsername && new Date(r.date) >= todayStart
                );

                if (hasSubmittedToday) {
                    clearInterval(alarmIntervalId);
                    alarmIntervalId = null;
                    return;
                }
                
                const now = new Date();
                const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                if (settings.reminderTimes && settings.reminderTimes.includes(currentTime)) {
                    playVoice(settings.reminderMessage, 'bn-BD', true);
                }
            }, 60000); // Check every minute
        }

        async function setupPushNotifications(role, teamId, userId) {
            if (!('Notification' in window) || !('serviceWorker' in navigator) || !firebase.messaging.isSupported()) {
                console.log("This browser does not support push notifications.");
                return;
            }
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    const fcmToken = await messaging.getToken({ vapidKey: 'BC0oXNNGZG8Qq43Wuo6YRidw6ZF7vNQMOXhQwTPun7rVRqSu9Ulbh0w84CH3_01XcXih4LKstYWsUF0laM13710' });
                    if (fcmToken) {
                        if (role === 'teammember') {
                            await db.ref(`teamAdmins/${teamId}/teamMembers/${userId}/fcmToken`).set(fcmToken);
                        } else if (role === 'teamadmin') {
                            await db.ref(`teamAdmins/${userId}/fcmToken`).set(fcmToken);
                        }
                    }
                }
            } catch(err) {
                console.error('An error occurred while setting up push notifications.', err);
            }
        }
        
        function addReminderTimeInput(time = '') {
            const container = document.getElementById('reminderTimesContainer');
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            div.innerHTML = `
                <input type="time" class="input-field !mb-0 reminder-time-input" value="${time}">
                <button onclick="this.parentElement.remove()" class="btn btn-danger btn-sm">X</button>
            `;
            container.appendChild(div);
        }

        function renderNotificationSettings() {
            const adminId = state.loggedInUser;
            const settings = state.notificationSettings[adminId] || {};
            
            document.getElementById('enableNotifications').checked = settings.enabled || false;
            document.getElementById('reminderMessage').value = settings.reminderMessage || "আপনি এখনো আগামীকালের টার্গেট ও আজকের সেলস রিপোর্ট জমা দেন নি, দয়া করে রাত 11 তার মধ্যে রিপোর্ট জমা দিন নয়তো নিজের জবাব প্রস্তুত রাখুন সকাল বেলার মিটিংয়ে দেয়ার জন্য";
            
            const timesContainer = document.getElementById('reminderTimesContainer');
            timesContainer.innerHTML = '';
            const reminderTimes = settings.reminderTimes || ["21:30", "22:20"];
            reminderTimes.forEach(time => addReminderTimeInput(time));
            if(reminderTimes.length === 0){
                 addReminderTimeInput();
            }

            document.getElementById('thankYouMessage').value = settings.thankYouMessage || "আপনাকে ধন্যবাদ রিপোর্ট জমাদানের জন্য";
        }

        async function saveNotificationSettings() {
            const adminId = state.loggedInUser;
            const reminderTimes = Array.from(document.querySelectorAll('.reminder-time-input'))
                                     .map(input => input.value)
                                     .filter(value => value !== '');

            const settings = {
                enabled: document.getElementById('enableNotifications').checked,
                reminderMessage: document.getElementById('reminderMessage').value,
                reminderTimes: reminderTimes,
                thankYouMessage: document.getElementById('thankYouMessage').value,
            };

            await db.ref(`notificationSettings/${adminId}`).set(settings);
            state.notificationSettings[adminId] = settings;
            showAlert('Notification settings saved successfully!');
        }

        function renderLogoutSettings() {
            const adminId = state.loggedInUser;
            const settings = state.logoutSettings[adminId] || {};
            document.getElementById('logoutClickCount').value = settings.clickCount || 10;
        }

        async function saveLogoutSettings() {
            const adminId = state.loggedInUser;
            const clickCount = parseInt(document.getElementById('logoutClickCount').value, 10);
            
            if(isNaN(clickCount) || clickCount < 1) {
                return showAlert('Please enter a valid number greater than 0.');
            }

            const settings = { clickCount };
            await db.ref(`logoutSettings/${adminId}`).set(settings);
            state.logoutSettings[adminId] = settings;
            showAlert('Logout settings saved successfully!');
        }
        
        function renderVoiceSettings() {
            const adminId = state.loggedInUser;
            const settings = state.voiceSettings[adminId] || {};
            document.getElementById('voiceRepeatCount').value = settings.repeatCount || 2;
        }

        async function saveVoiceSettings() {
            const adminId = state.loggedInUser;
            const repeatCount = parseInt(document.getElementById('voiceRepeatCount').value, 10);
            
            if(isNaN(repeatCount) || repeatCount < 1) {
                return showAlert('Please enter a valid number greater than 0.');
            }

            const settings = { repeatCount };
            await db.ref(`voiceSettings/${adminId}`).set(settings);
            state.voiceSettings[adminId] = settings;
            showAlert('Voice settings saved successfully!');
        }

        // --- Category Management ---
        function renderCategoryManagement() {
            const deleteSelect = document.getElementById('deleteCategorySelect');
            
            const uniqueCategories = [...new Set(state.products.map(p => p.category).filter(Boolean))].sort();

            deleteSelect.innerHTML = '<option value="">-- Select Category to Delete --</option>';

            uniqueCategories.forEach(cat => {
                deleteSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            document.getElementById('newStandaloneCategoryName').value = '';
        }

        async function addStandaloneCategory() {
            const categoryName = document.getElementById('newStandaloneCategoryName').value.trim();
            if (!categoryName) {
                return showAlert('Category name cannot be empty.');
            }
            const uniqueCategories = [...new Set(state.products.map(p => p.category).filter(Boolean))];
             if (uniqueCategories.some(c => c.toLowerCase() === categoryName.toLowerCase())) {
                return showAlert('This category already exists.');
            }
            
            // To "create" a category, we add a placeholder product. This is a workaround.
            const placeholderProduct = {
                name: `_placeholder_for_${categoryName}`,
                rate: 0,
                category: categoryName
            };
            await db.ref('products').push(placeholderProduct);

            await getFullState();
            renderCategoryManagement();
            showAlert(`Category "${categoryName}" created successfully.`);
        }

        async function deleteStandaloneCategory() {
            const categoryToDelete = document.getElementById('deleteCategorySelect').value;
            if (!categoryToDelete) {
                return showAlert('Please select a category to delete.');
            }
            
            const productsInCategory = state.products.filter(p => p.category === categoryToDelete);

            if (productsInCategory.length > 1 || (productsInCategory.length === 1 && !productsInCategory[0].name.startsWith('_placeholder_for_'))) {
                 if (!confirm(`This category contains products. Deleting it will remove the category from all associated products. Are you sure?`)) {
                    return;
                }
            } else {
                 if (!confirm(`Are you sure you want to delete the category "${categoryToDelete}"?`)) {
                    return;
                }
            }
            
            const updates = {};
            productsInCategory.forEach(p => {
                if (p.name.startsWith('_placeholder_for_')) {
                    updates[`/products/${p.id}`] = null; // Delete placeholder
                } else {
                    updates[`/products/${p.id}/category`] = null; // Unset category for other products
                }
            });

            if(Object.keys(updates).length > 0) {
                await db.ref().update(updates);
            }
            
            await getFullState();
            renderCategoryManagement();
            showAlert(`Category "${categoryToDelete}" has been deleted.`);
        }
        
         // --- Category Wise Report ---
        function renderCategoryWiseReport() {
            const startDateStr = document.getElementById('categoryReportStartDate').value;
            const endDateStr = document.getElementById('categoryReportEndDate').value;
            const selectedMemberUsername = document.getElementById('categoryReportMemberSelect').value;

            if (!startDateStr || !endDateStr) {
                return showAlert('Please select both start and end dates for the category report.');
            }

            const startDate = new Date(startDateStr);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(endDateStr);
            endDate.setHours(23, 59, 59, 999);

            let relevantReports = state.salesReports.filter(r => {
                const reportDate = new Date(r.date).getTime();
                return r.team === state.loggedInUserName && reportDate >= startDate.getTime() && reportDate <= endDate.getTime();
            });

            if (selectedMemberUsername !== 'all') {
                relevantReports = relevantReports.filter(r => r.submittedBy === selectedMemberUsername);
            }

            const categoryData = {};
            Object.keys(reportingCategories).forEach(cat => {
                categoryData[cat] = { tgtAmount: 0, salesAmount: 0 };
            });

            relevantReports.forEach(report => {
                report.reportData.items.forEach(item => {
                    for (const categoryName in reportingCategories) {
                        if (reportingCategories[categoryName].includes(item.name)) {
                            const productInfo = state.products.find(p => p.name === item.name);
                            const rate = productInfo ? productInfo.rate : item.rate;
                            categoryData[categoryName].tgtAmount += item.tgt * rate;
                            categoryData[categoryName].salesAmount += item.sales * rate;
                            // An item belongs to only one reporting category, so we can break.
                            break; 
                        }
                    }
                });
            });

            // Render Chart
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const labels = Object.keys(categoryData);
            const tgtData = labels.map(l => categoryData[l].tgtAmount);
            const salesData = labels.map(l => categoryData[l].salesAmount);

            if (categoryChartInstance) {
                categoryChartInstance.destroy();
            }

            categoryChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'TGT Amount',
                            data: tgtData,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)', // Blue
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Sales Amount',
                            data: salesData,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)', // Green
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Render Table
            const tableContainer = document.getElementById('categoryReportTableContainer');
            let tableHtml = `
                <table class="w-full text-left text-sm mt-4" id="categoryReportTable">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="p-2 font-semibold">Category</th>
                            <th class="p-2 font-semibold text-right">TGT Amount</th>
                            <th class="p-2 font-semibold text-right">Sales Amount</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let totalTgt = 0;
            let totalSales = 0;

            for (const categoryName in categoryData) {
                const data = categoryData[categoryName];
                totalTgt += data.tgtAmount;
                totalSales += data.salesAmount;
                tableHtml += `
                    <tr class="border-b">
                        <td class="p-2">${categoryName}</td>
                        <td class="p-2 text-right">${Math.round(data.tgtAmount).toLocaleString()}</td>
                        <td class="p-2 text-right">${Math.round(data.salesAmount).toLocaleString()}</td>
                    </tr>
                `;
            }
            
            tableHtml += `
                    </tbody>
                    <tfoot class="font-bold bg-gray-100">
                        <tr>
                            <td class="p-2">Grand Total</td>
                            <td class="p-2 text-right">${Math.round(totalTgt).toLocaleString()}</td>
                            <td class="p-2 text-right">${Math.round(totalSales).toLocaleString()}</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            tableContainer.innerHTML = tableHtml;
        }

        function exportCategoryReportToExcel() {
            const table = document.getElementById('categoryReportTable');
            if (!table || table.rows.length <= 1) { // Check if table has more than just header
                return showAlert('No data available to export.');
            }
            const wb = XLSX.utils.table_to_book(table, { sheet: "Category Report" });

            const startDate = document.getElementById('categoryReportStartDate').value;
            const endDate = document.getElementById('categoryReportEndDate').value;

            const fileName = `CategoryWiseReport_${startDate}_to_${endDate}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // --- App Initialization ---
        async function initializeApp() {
            resetLocalState();
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();

            if (firebase.messaging.isSupported()) {
                messaging = firebase.messaging();
                messaging.onMessage((payload) => {
                    console.log('Message received. ', payload);
                    const notificationTitle = payload.notification.title;
                    const notificationOptions = {
                        body: payload.notification.body,
                        icon: '/firebase-logo.png'
                    };
                    new Notification(notificationTitle, notificationOptions);
                });
            }
            
            await getFullState();

            // Check for saved user in localStorage
            const savedUserJSON = localStorage.getItem('loggedInUser');
            if (savedUserJSON) {
                const savedUser = JSON.parse(savedUserJSON);
                
                const adminUser = state.teamAdmins.find(a => a.id === savedUser.id);
                let memberUser, memberAdmin;
                 if (savedUser.role === 'teammember') {
                    for(const admin of state.teamAdmins) {
                        if (admin.teamMembers) {
                            const memberKey = Object.keys(admin.teamMembers).find(k => k === savedUser.id);
                            if (memberKey) {
                                memberUser = {...admin.teamMembers[memberKey], id: memberKey, adminId: admin.id };
                                memberAdmin = admin;
                                break;
                            }
                        }
                    }
                 }


                let userIsValid = false;
                if (savedUser.role === 'superadmin') {
                     userIsValid = true;
                } else if (savedUser.role === 'teamadmin' && adminUser && adminUser.status === 'active') {
                     userIsValid = true;
                } else if (savedUser.role === 'teammember' && memberUser && memberUser.status === 'active' && memberAdmin && memberAdmin.status === 'active') {
                    userIsValid = true;
                }

                if (userIsValid) {
                    state.loggedInUser = savedUser.id;
                    state.loggedInUserRole = savedUser.role;

                    if (savedUser.role === 'superadmin') {
                        renderSuperAdminDashboard();
                        showPage('superAdminDashboard');
                    } else if (savedUser.role === 'teamadmin') {
                        state.loggedInUserName = savedUser.username;
                        renderTeamAdminDashboard();
                        showPage('teamAdminDashboard');
                        playAdminWelcomeVoice();
                    } else if (savedUser.role === 'teammember') {
                        state.loggedInUserName = savedUser.name;
                        state.loggedInUserUsername = savedUser.username;
                        state.loggedInUserTeam = savedUser.team;
                        state.loggedInUserTeamId = savedUser.teamId;
                        renderTeamMemberDashboard();
                        showPage('teamMemberDashboard');
                        playWelcomeVoice('member');
                    }
                    if (savedUser.role !== 'superadmin') {
                        startMemberAlarmSystem();
                    }
                } else {
                    localStorage.removeItem('loggedInUser');
                    showPage('mainLoginPage');
                }
            } else {
                 showPage('mainLoginPage');
            }

            document.addEventListener('click', unlockAudio, { once: true });
        }

        window.onload = initializeApp;

    </script>
</body>
</html>

    
